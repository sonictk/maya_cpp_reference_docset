<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
<head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="MAYAUL" name="product"><meta content="2016" name="release"><meta content="Developer" name="book"><meta content="2015-10-14" name="created"><meta content="GUID-02DEF634-1E7B-48C6-8ACD-2C934CA97887" name="topicid"><meta content="concept" name="topic-type">
<title>hlslShader/hlslShader.cpp</title>
<meta content="C++" name="topic-subtype"/></meta></meta></meta></meta></meta></meta></meta></head>
<body height="100%"><div class="body_content" id="body-content"><link href="cpp_ref/navtree.css" rel="stylesheet" type="text/css"><link href="cpp_ref/doxygen.css" rel="stylesheet" type="text/css"><link href="cpp_ref/tabs.css" rel="stylesheet" type="text/css"><link href="style/adsk.cpm.css" rel="stylesheet" type="text/css"><script language="javascript">var index = 'index.html';</script><script>$(document).ready(function() { yepnope.injectJs("./scripts/ac_common.js"); });</script><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('hlsl_shader_2hlsl_shader_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>$("div#WidgetFloaterPanels,link[href*='microsofttranslator.com'],script[src*='microsofttranslator.com'],script[src*='bing.com']").remove();</script><script type="text/javascript">$("div#navigation,div#breadcrumbs,div#banner").attr("translate","no"); var mtLocation = ((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?siteData=y5CYlxTRD0znCzRLDwX0Wy7-g1EdC1XA4dSC-Y1LtaeScyli8_Ps5jPKqTr4xKxMI0OOUfkDplvX3uxN0JnPclebSYW8_J1HBzf4VLQEzQ8M4PsYXF_cMyp1Oumaetky&category=5297189e-446b-459e-ae1d-9d0360400781_tech&ctf=True&ui=true&settings=Manual&from=en&hidelanguages='; yepnope.injectJs(mtLocation, function() {}, { charset:'utf-8', type:'text/javascript' } );</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script><!-- begin MT -->
<div class="Dark" id="MicrosoftTranslatorWidget" style="position:absolute;right:20px;top:5px;z-index:100;color:white;background-color:#555555;height:58px;overflow:hidden"></div>
<div>
<div class="head">
<h1>hlslShader/hlslShader.cpp</h1>
</div>
<div id="top"><!-- Generated by Doxygen 1.8.10 -->
<div class="tabs" id="navrow1">
<ul class="tablist">
<li><a href="./index.html"><span>MainÂ Page</span></a></li>
<li><a href="./pages.html"><span>Topics</span></a></li>
<li><a href="./modules.html"><span>Modules</span></a></li>
<li><a href="./namespaces.html"><span>Namespaces</span></a></li>
<li><a href="./annotated.html"><span>Classes</span></a></li>
<li><a href="./examples.html"><span>Examples</span></a></li>
</ul>
</div>
</div><!-- top -->
<div class="ui-resizable side-nav-resizable" id="side-nav">
<div id="nav-tree">
<div id="nav-tree-contents">
<div class="sync" id="nav-sync"></div>
</div>
</div>
<div class="ui-resizable-handle" id="splitbar" style="-moz-user-select:none;">
</div>
</div>
<div id="doc-content">
<div class="header">
<div class="headertitle">
<div class="title">hlslShader/hlslShader.cpp</div> </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">//-</span></div>
<div class="line"><span class="comment">// ==========================================================================</span></div>
<div class="line"><span class="comment">// Copyright 1995,2006,2008 Autodesk, Inc. All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk</span></div>
<div class="line"><span class="comment">// license agreement provided at the time of installation or download,</span></div>
<div class="line"><span class="comment">// or which otherwise accompanies this software in either electronic</span></div>
<div class="line"><span class="comment">// or hard copy form.</span></div>
<div class="line"><span class="comment">// ==========================================================================</span></div>
<div class="line"><span class="comment">//+</span></div>
<div class="line"><span class="preprocessor">#ifndef HLSL_VERSION  </span></div>
<div class="line"><span class="preprocessor">#define HLSL_VERSION  "1.0"</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#define ERROR_LIMIT 20</span></div>
<div class="line"><span class="comment">//#define VALIDATE_TECHNIQUE_LIST</span></div>
<div class="line"><span class="comment">//#define VALIDATE_TECHNIQUES</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Now, because we're rendering from system memory, DirectX can start to get</span></div>
<div class="line"><span class="comment">// suspicious that the graphics driver has hung if we try and render too much</span></div>
<div class="line"><span class="comment">// stuff in a single call. So, we'll take stability over performance and</span></div>
<div class="line"><span class="comment">// split up the draw. Given we only do this for large amounts of geometry, the</span></div>
<div class="line"><span class="comment">// hit shouldn't be too bad. Commenting this #define out will cause the plugin</span></div>
<div class="line"><span class="comment">// to try and render everything in a single render call, no matter how large </span></div>
<div class="line"><span class="comment">// it is (which seems to work on some graphics cards, but not others)</span></div>
<div class="line"><span class="preprocessor">#define MAX_SEGMENTED_BATCH_SIZE 40000</span></div>
<div class="line"> </div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include "hlslShader.h"</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGlobal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGeometry.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGeometryData.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGeometryPrimitive.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGeometryList.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGeometryManager.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MVaryingParameterList.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MUniformParameter.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGlobal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnDependencyNode.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnTypedAttribute.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnStringData.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFnStringArrayData.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MSceneMessage.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFileIO.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MMatrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MFileObject.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MArgParser.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MSyntax.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MD3D9Renderer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MHwrCallback.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;new.h&gt;</span> <span class="comment">// for fancy pants re-initialisation of existing memory version</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// For swatch rendering</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MHardwareRenderer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MHWShaderSwatchGenerator.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGeometryRequirements.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MHwTextureManager.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MImageFileInfo.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Debugging</span></div>
<div class="line"><span class="preprocessor">#define DEBUG_TEXTURE_CACHE(X) </span></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">class </span>ObjArray</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> <span class="keyword">inline</span>      ObjArray() : fLength( 0), fCapacity( 0), fData( NULL) {}</div>
<div class="line"> <span class="keyword">inline</span>      ~ObjArray() { <span class="keywordflow">if</span>( fData) { destroy( 0, fLength); <span class="keyword">delete</span>[] ((<span class="keywordtype">char</span>*)fData); } } <span class="comment">// Don't call the destructors here, destroy did it!</span></div>
<div class="line"> <span class="keyword">inline</span> <span class="keywordtype">int</span>  length()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> fLength; }</div>
<div class="line"> <span class="keyword">inline</span> <span class="keywordtype">void</span> length( <span class="keywordtype">int</span> l) { <span class="keywordflow">if</span>( l &gt; fLength) { <span class="keywordflow">if</span>( l &gt; fCapacity) resize( l); create( fLength, l); } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( l &lt; fLength) destroy( l, fLength); fLength = l; }</div>
<div class="line"> <span class="keyword">inline</span> <span class="keyword">const</span> T&amp; operator[]( <span class="keywordtype">int</span> i)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> fData[ i]; }</div>
<div class="line"> <span class="keyword">inline</span> T&amp;   operator[]( <span class="keywordtype">int</span> i) { <span class="keywordflow">return</span> fData[ i]; }</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"> <span class="keyword">inline</span> <span class="keywordtype">void</span> create( <span class="keywordtype">int</span> s, <span class="keywordtype">int</span> e) { <span class="keywordflow">for</span>( ; s &lt; e; s++) <span class="keyword">new</span> ((<span class="keywordtype">void</span>*)(fData + s)) T; }</div>
<div class="line"> <span class="keyword">inline</span> <span class="keywordtype">void</span> destroy( <span class="keywordtype">int</span> s, <span class="keywordtype">int</span> e) { <span class="keywordflow">for</span>( ; s &lt; e; s++) (fData + s)-&gt;T::~T(); }</div>
<div class="line"> <span class="keyword">enum</span></div>
<div class="line">    {</div>
<div class="line">        MIN_ARRAY_SIZE = 4</div>
<div class="line">    };</div>
<div class="line"> <span class="keyword">inline</span> <span class="keywordtype">void</span> resize( <span class="keywordtype">int</span> l) </div>
<div class="line">    { </div>
<div class="line"> <span class="keywordflow">if</span>( l &lt; MIN_ARRAY_SIZE) l = MIN_ARRAY_SIZE; </div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( l &lt; fCapacity * 2) l = fCapacity * 2; </div>
<div class="line">        T* newData = (T*)<span class="keyword">new</span> <span class="keywordtype">char</span>[ l * <span class="keyword">sizeof</span>( T)]; </div>
<div class="line"> <span class="keywordflow">if</span>( fData) </div>
<div class="line">        { </div>
<div class="line">            memcpy( newData, fData, fCapacity * <span class="keyword">sizeof</span>( T)); </div>
<div class="line"> <span class="keyword">delete</span>[] ((<span class="keywordtype">char</span>*)fData); </div>
<div class="line">        } </div>
<div class="line">        fData = newData; </div>
<div class="line">        fCapacity = l; </div>
<div class="line">    }</div>
<div class="line"> <span class="keywordtype">int</span>         fLength;</div>
<div class="line"> <span class="keywordtype">int</span>         fCapacity;</div>
<div class="line">    T*          fData;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// setup device callbacks as needed</span></div>
<div class="line"><span class="comment">// currently this class defined in hlslShader.h</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> hlslDeviceManager::deviceNew()</div>
<div class="line">{</div>
<div class="line">    fState = kValid;</div>
<div class="line"> <span class="comment">//printf("calling setShader with name: %s\n", fShader.fShader.asChar() );   </span></div>
<div class="line">    fShader.setShader( fShader.fShader);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> hlslDeviceManager::deviceLost()</div>
<div class="line">{</div>
<div class="line">    fState = kInvalid;</div>
<div class="line"> <span class="comment">//printf("devLost: releasing %s handles\n", fShader.fShader.asChar() );</span></div>
<div class="line">    fShader.release();</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">void</span> hlslDeviceManager::deviceDeleted()</div>
<div class="line">{</div>
<div class="line">    fState = kInvalid;</div>
<div class="line"> <span class="comment">//printf("devDeleted: releasing %s handles\n", fShader.fShader.asChar() );</span></div>
<div class="line">    fShader.release();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> hlslDeviceManager::deviceReset()</div>
<div class="line">{</div>
<div class="line">    fState = kReset;</div>
<div class="line"> <span class="comment">//printf("devRest: releasing %s handles\n", fShader.fShader.asChar() );</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> hlslDeviceManager::resetShader()</div>
<div class="line">{</div>
<div class="line">    fState = kValid;</div>
<div class="line">    fShader.setShader( fShader.fShader);</div>
<div class="line"> <span class="comment">//printf("resetShader: releasing %s handles\n", fShader.fShader.asChar() );</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Lookup tables for the (default) names and internal semantics</span></div>
<div class="line"><span class="comment">// that map to D3D's usage types</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">struct </span>SemanticInfo</div>
<div class="line">{</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">char</span>* Name;</div>
<div class="line"> <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321">MVaryingParameter::MVaryingParameterSemantic</a> Type;</div>
<div class="line"> <span class="keywordtype">int</span>         MinElements;</div>
<div class="line"> <span class="keywordtype">int</span>         MaxElements;</div>
<div class="line">    BYTE        D3DType;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">SemanticInfo gSemanticInfo[] = </div>
<div class="line">{ </div>
<div class="line"> <span class="stringliteral">"Position"</span>,             <a name="a0"></a><a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321aa20581584e5f9447cb96afb4f2e10703">MVaryingParameter::kPosition</a>,       2, 4,       D3DDECLTYPE_FLOAT3,     </div>
<div class="line"> <span class="stringliteral">"BlendWeight"</span>,          <a name="a1"></a><a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321adfd9c161a2e178f85cb4ca9d6debdb8f">MVaryingParameter::kNoSemantic</a>,     1, 4,       D3DDECLTYPE_FLOAT4,</div>
<div class="line"> <span class="stringliteral">"BlendIndices"</span>,         <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321adfd9c161a2e178f85cb4ca9d6debdb8f">MVaryingParameter::kNoSemantic</a>,     1, 4,       D3DDECLTYPE_FLOAT4, </div>
<div class="line"> <span class="stringliteral">"Normal"</span>,               <a name="a2"></a><a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321a227e8416235cd3b43077ca91504a463f">MVaryingParameter::kNormal</a>,         3, 4,       D3DDECLTYPE_FLOAT3, </div>
<div class="line"> <span class="stringliteral">"PointSize"</span>,            <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321adfd9c161a2e178f85cb4ca9d6debdb8f">MVaryingParameter::kNoSemantic</a>,     1, 4,       D3DDECLTYPE_FLOAT3, </div>
<div class="line"> <span class="stringliteral">"UV"</span>,                   <a name="a3"></a><a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321a45b7096916b12a78e94c62bba9d50739">MVaryingParameter::kTexCoord</a>,       2, 4,       D3DDECLTYPE_FLOAT2,</div>
<div class="line"> <span class="stringliteral">"Tangent"</span>,              <a name="a4"></a><a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321ab90d6591156ad2cb2eea2cb5b75e77e0">MVaryingParameter::kTangent</a>,        3, 4,       D3DDECLTYPE_FLOAT3, </div>
<div class="line"> <span class="stringliteral">"BiNormal"</span>,             <a name="a5"></a><a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321a7dd396b8135e53c57a88a0d466884e39">MVaryingParameter::kBinormal</a>,       3, 4,       D3DDECLTYPE_FLOAT3, </div>
<div class="line"> <span class="stringliteral">"TesselateFactor"</span>,      <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321adfd9c161a2e178f85cb4ca9d6debdb8f">MVaryingParameter::kNoSemantic</a>,     1, 4,       D3DDECLTYPE_FLOAT4, </div>
<div class="line"> <span class="stringliteral">"PositionTransformed"</span>,  <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321adfd9c161a2e178f85cb4ca9d6debdb8f">MVaryingParameter::kNoSemantic</a>,     1, 4,       D3DDECLTYPE_FLOAT4, </div>
<div class="line"> <span class="stringliteral">"Color"</span>,                <a name="a6"></a><a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321afc0133ebaa6c307b2388ecf5f72f6fdf">MVaryingParameter::kColor</a>,          3, 4,       D3DDECLTYPE_FLOAT4, </div>
<div class="line"> <span class="stringliteral">"Fog"</span>,                  <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321adfd9c161a2e178f85cb4ca9d6debdb8f">MVaryingParameter::kNoSemantic</a>,     1, 4,       D3DDECLTYPE_FLOAT4, </div>
<div class="line"> <span class="stringliteral">"Depth"</span>,                <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321adfd9c161a2e178f85cb4ca9d6debdb8f">MVaryingParameter::kNoSemantic</a>,     1, 4,       D3DDECLTYPE_FLOAT4, </div>
<div class="line"> <span class="stringliteral">"Sample"</span>,               <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321adfd9c161a2e178f85cb4ca9d6debdb8f">MVaryingParameter::kNoSemantic</a>,     1, 4,       D3DDECLTYPE_FLOAT4,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// A wee state manager used to flip from DX to GL culling handed-ness</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">class </span>HLSLStateManager : <span class="keyword">public</span> ID3DXEffectStateManager</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> <span class="keyword">static</span> HLSLStateManager sInstance;</div>
<div class="line"> <span class="keyword">inline</span> HLSLStateManager() : fShapeCullMode( <a name="_a7"></a><a class="code" href="./class_m_geometry_list.html">MGeometryList</a>::kCullCW), fShaderCullMode( D3DCULL_CCW) {}</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Set the cull mode Maya needs</span></div>
<div class="line"> <span class="keyword">inline</span> <span class="keywordtype">void</span> shapeCullMode( <a class="code" href="./class_m_geometry_list.html#ae8a071ea1afbb0c50330deec77c8c2c4">MGeometryList::MCullMode</a> cullMode, <span class="keywordtype">bool</span> ignoreShaderCullMode = <span class="keyword">false</span>) </div>
<div class="line">    { </div>
<div class="line">        fShapeCullMode = cullMode; </div>
<div class="line"> <span class="keywordflow">if</span>( ignoreShaderCullMode) fShaderSetCullMode = <span class="keyword">false</span>;</div>
<div class="line">        setupCulling(); </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Reverse the cull direction if we need "normal" OpenGL culling as DirectX</span></div>
<div class="line"> <span class="comment">// has the opposite "handedness" to GL</span></div>
<div class="line">    STDMETHOD(SetRenderState)(THIS_ D3DRENDERSTATETYPE d3dRenderState, DWORD dwValue ) </div>
<div class="line">    { </div>
<div class="line"> <span class="keywordflow">if</span>( d3dRenderState == D3DRS_CULLMODE)</div>
<div class="line">        {</div>
<div class="line">            fShaderCullMode = dwValue;</div>
<div class="line">            fShaderSetCullMode = <span class="keyword">true</span>;</div>
<div class="line"> <span class="keywordflow">return</span> D3D_OK;</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">return</span> fD3DDevice-&gt;SetRenderState( d3dRenderState, dwValue ); </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Helper to setup a pass tracking whether cull direction was explicitly set, and reversing it if it was</span></div>
<div class="line"> <span class="keyword">inline</span> <span class="keywordtype">void</span> BeginPass( LPD3DXEFFECT effect, <span class="keywordtype">int</span> pass) </div>
<div class="line">    { </div>
<div class="line">        fShaderSetCullMode = <span class="keyword">false</span>;</div>
<div class="line">        effect-&gt;BeginPass( pass); </div>
<div class="line">        setupCulling();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Default implementations</span></div>
<div class="line">    STDMETHOD(SetSamplerState)(THIS_ DWORD dwStage, D3DSAMPLERSTATETYPE d3dSamplerState, DWORD dwValue ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetSamplerState( dwStage, d3dSamplerState, dwValue ); }</div>
<div class="line">    STDMETHOD(SetTextureStageState)(THIS_ DWORD dwStage, D3DTEXTURESTAGESTATETYPE d3dTextureStageState, DWORD dwValue ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetTextureStageState( dwStage, d3dTextureStageState, dwValue ); }</div>
<div class="line">    STDMETHOD(SetTexture)(THIS_ DWORD dwStage, LPDIRECT3DBASETEXTURE9 pTexture ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetTexture( dwStage, pTexture ); }</div>
<div class="line">    STDMETHOD(SetVertexShader)(THIS_ LPDIRECT3DVERTEXSHADER9 pShader ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetVertexShader( pShader ); }</div>
<div class="line">    STDMETHOD(SetPixelShader)(THIS_ LPDIRECT3DPIXELSHADER9 pShader ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetPixelShader( pShader ); }</div>
<div class="line">    STDMETHOD(SetFVF)(THIS_ DWORD dwFVF ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetFVF( dwFVF ); }</div>
<div class="line">    STDMETHOD(SetTransform)(THIS_ D3DTRANSFORMSTATETYPE State, CONST D3DMATRIX *pMatrix ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetTransform( State, pMatrix ); }</div>
<div class="line">    STDMETHOD(SetMaterial)(THIS_ CONST D3DMATERIAL9 *pMaterial ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetMaterial( pMaterial ); }</div>
<div class="line">    STDMETHOD(SetLight)(THIS_ DWORD Index, CONST D3DLIGHT9 *pLight ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetLight( Index, pLight ); }</div>
<div class="line">    STDMETHOD(LightEnable)(THIS_ DWORD Index, BOOL Enable ) { <span class="keywordflow">return</span> fD3DDevice-&gt;LightEnable( Index, Enable ); }</div>
<div class="line">    STDMETHOD(SetNPatchMode)(THIS_ FLOAT NumSegments ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetNPatchMode( NumSegments ); }</div>
<div class="line">    STDMETHOD(SetVertexShaderConstantF)(THIS_ UINT RegisterIndex, CONST FLOAT *pConstantData, UINT RegisterCount ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetVertexShaderConstantF( RegisterIndex, pConstantData, RegisterCount ); }</div>
<div class="line">    STDMETHOD(SetVertexShaderConstantI)(THIS_ UINT RegisterIndex, CONST INT *pConstantData, UINT RegisterCount ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetVertexShaderConstantI( RegisterIndex, pConstantData, RegisterCount ); }</div>
<div class="line">    STDMETHOD(SetVertexShaderConstantB)(THIS_ UINT RegisterIndex, CONST BOOL *pConstantData, UINT RegisterCount ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetVertexShaderConstantB( RegisterIndex, pConstantData, RegisterCount ); }</div>
<div class="line">    STDMETHOD(SetPixelShaderConstantF)(THIS_ UINT RegisterIndex, CONST FLOAT *pConstantData, UINT RegisterCount ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetPixelShaderConstantF( RegisterIndex, pConstantData, RegisterCount ); }</div>
<div class="line">    STDMETHOD(SetPixelShaderConstantI)(THIS_ UINT RegisterIndex, CONST INT *pConstantData, UINT RegisterCount ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetPixelShaderConstantI( RegisterIndex, pConstantData, RegisterCount ); }</div>
<div class="line">    STDMETHOD(SetPixelShaderConstantB)(THIS_ UINT RegisterIndex, CONST BOOL *pConstantData, UINT RegisterCount ) { <span class="keywordflow">return</span> fD3DDevice-&gt;SetPixelShaderConstantB( RegisterIndex, pConstantData, RegisterCount ); }</div>
<div class="line">    STDMETHOD(QueryInterface)(THIS_ REFIID iid, LPVOID *ppv) { <span class="keywordflow">if</span> (iid == IID_IUnknown || iid == IID_ID3DXEffectStateManager) { *ppv = <span class="keyword">static_cast&lt;</span>ID3DXEffectStateManager*<span class="keyword">&gt;</span>(<span class="keyword">this</span>); } <span class="keywordflow">else</span> { *ppv = NULL; <span class="keywordflow">return</span> E_NOINTERFACE; } <span class="keyword">reinterpret_cast&lt;</span>IUnknown*<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;AddRef(); <span class="keywordflow">return</span> S_OK; }</div>
<div class="line">    STDMETHOD_(ULONG, AddRef)(THIS) { <span class="comment">/*return (ULONG)InterlockedIncrement( &amp;m_lRef ); */</span> <span class="keywordflow">return</span> 1L; }</div>
<div class="line">    STDMETHOD_(ULONG, Release)(THIS) { <span class="comment">/*if( 0L == InterlockedDecrement( &amp;m_lRef ) ) { delete this; return 0L; } return m_lRef; */</span> <span class="keywordflow">return</span> 1L; }</div>
<div class="line">    LPDIRECT3DDEVICE9 fD3DDevice;</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Helper to work out the render cull setting for the current shape/shader cull modes</span></div>
<div class="line"> <span class="comment">// This code assumes that a pass render state selecting a cull direction OVERRIDES any</span></div>
<div class="line"> <span class="comment">// double-sidedness on the shape (given there's really no point in rendering a back or</span></div>
<div class="line"> <span class="comment">// front of the object when every point is part of the front and the back). You can</span></div>
<div class="line"> <span class="comment">// easily modify this code to preserve double sidedness in these cases by adding a</span></div>
<div class="line"> <span class="comment">// check for fShapeCullMode == kCullNone in the second two fShaderCullMode cases and</span></div>
<div class="line"> <span class="comment">// leave d3dCullMode as NONE to get the other behaviour.</span></div>
<div class="line"> <span class="keyword">inline</span> <span class="keywordtype">void</span> setupCulling()</div>
<div class="line">    {</div>
<div class="line">        DWORD d3dCullMode = D3DCULL_NONE;</div>
<div class="line"> <span class="keywordflow">if</span>( !fShaderSetCullMode)</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">if</span>( fShapeCullMode == <a name="a8"></a><a class="code" href="./class_m_geometry_list.html#ae8a071ea1afbb0c50330deec77c8c2c4af7b5cd77ef1ecfa1ef60046184ed6281">MGeometryList::kCullCW</a>)</div>
<div class="line">                d3dCullMode = D3DCULL_CW; </div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( fShapeCullMode == <a name="a9"></a><a class="code" href="./class_m_geometry_list.html#ae8a071ea1afbb0c50330deec77c8c2c4a8cdf8a04a488157421df1e0775ebcc5e">MGeometryList::kCullCCW</a>)</div>
<div class="line">                d3dCullMode = D3DCULL_CCW; </div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( fShaderCullMode == D3DCULL_CCW)</div>
<div class="line">        {</div>
<div class="line">            d3dCullMode = (fShapeCullMode == <a class="code" href="./class_m_geometry_list.html#ae8a071ea1afbb0c50330deec77c8c2c4a8cdf8a04a488157421df1e0775ebcc5e">MGeometryList::kCullCCW</a>) ? D3DCULL_CCW : D3DCULL_CW; </div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( fShaderCullMode == D3DCULL_CW)</div>
<div class="line">        {</div>
<div class="line">            d3dCullMode = (fShapeCullMode == <a class="code" href="./class_m_geometry_list.html#ae8a071ea1afbb0c50330deec77c8c2c4a8cdf8a04a488157421df1e0775ebcc5e">MGeometryList::kCullCCW</a>) ? D3DCULL_CW : D3DCULL_CCW; </div>
<div class="line">        }</div>
<div class="line">        fD3DDevice-&gt;SetRenderState( D3DRS_CULLMODE, d3dCullMode); </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_geometry_list.html#ae8a071ea1afbb0c50330deec77c8c2c4">MGeometryList::MCullMode</a> fShapeCullMode;</div>
<div class="line">    DWORD       fShaderCullMode;</div>
<div class="line"> <span class="keywordtype">bool</span>        fShaderSetCullMode;</div>
<div class="line">};</div>
<div class="line">HLSLStateManager HLSLStateManager::sInstance;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// A wee texture cache for our HLSL shaders</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">class </span>HLSLTextureManager : <span class="keyword">public</span> <a name="_a10"></a><a class="code" href="./class_m_hwr_callback.html">MHwrCallback</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> <span class="keyword">static</span> HLSLTextureManager sInstance;</div>
<div class="line"></div>
<div class="line">    HLSLTextureManager() </div>
<div class="line">    { </div>
<div class="line"> <a name="a11"></a><a class="code" href="./class_m_hwr_callback.html#a89455670ecab5d8cfe46ed1e1943415d">addCallback</a>( <span class="keyword">this</span>); </div>
<div class="line">        sceneCallbackIds[0] = <a name="a12"></a><a class="code" href="./class_m_scene_message.html#a0f4760368de3989378ce9cec3943ae6d">MSceneMessage::addCallback</a>( <a name="a13"></a><a class="code" href="./class_m_scene_message.html#a4f09127c805cc1f5ee20e67db7b45efaaf261bc0d5929af12c193ee3c6e451349">MSceneMessage::kBeforeNew</a>, HLSLTextureManager::newSceneCallback, (<span class="keywordtype">void</span>*)<span class="keyword">this</span>); </div>
<div class="line">        sceneCallbackIds[1] = <a class="code" href="./class_m_scene_message.html#a0f4760368de3989378ce9cec3943ae6d">MSceneMessage::addCallback</a>( <a name="a14"></a><a class="code" href="./class_m_scene_message.html#a4f09127c805cc1f5ee20e67db7b45efaac4fe9e5e85e4e962ca0366226b012d6f">MSceneMessage::kBeforeOpen</a>, HLSLTextureManager::newSceneCallback, (<span class="keywordtype">void</span>*)<span class="keyword">this</span>); </div>
<div class="line">    }</div>
<div class="line"> <span class="keyword">virtual</span> ~HLSLTextureManager() { <a name="a15"></a><a class="code" href="./class_m_hwr_callback.html#a3bd9b57cb13e6f168ce91bc5dca5954d">removeCallback</a>( <span class="keyword">this</span>); release(); <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; 2; i++) <a name="a16"></a><a class="code" href="./class_m_message.html#a50fe995add3ce133b8b56551abb4ed09">MSceneMessage::removeCallback</a>( sceneCallbackIds[ i]); }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span> bind( <span class="keyword">const</span> <a name="_a17"></a><a class="code" href="./class_m_string.html">MString</a>&amp; name, <a name="_a18"></a><a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a>&amp; uniform, LPD3DXEFFECT d3dEffect, D3DXHANDLE d3dParameter)</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Try and find an existing entry for this parameter</span></div>
<div class="line">        User* user = NULL;</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = users.length(); i--; )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">if</span>( users[ i].parameter == d3dParameter &amp;&amp; users[ i].effect == d3dEffect)</div>
<div class="line">            {</div>
<div class="line">                user = &amp;users[ i];</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If there's no existing entry and we have a texture, create a new one</span></div>
<div class="line"> <span class="keywordflow">if</span>( !user &amp;&amp; name.<a name="a19"></a><a class="code" href="./class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() &gt; 0)</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordtype">int</span> idx = users.length();</div>
<div class="line">            users.length( idx + 1);</div>
<div class="line">            user = &amp;users[ idx];</div>
<div class="line">            DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Registering user %s at %d\n"</span>, uniform.<a name="a20"></a><a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>().<a name="a21"></a><a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), (int)((<span class="keywordtype">long</span> <span class="keywordtype">long</span>)user)); )</div>
<div class="line">            user-&gt;parameter = d3dParameter;</div>
<div class="line">            user-&gt;effect = d3dEffect;</div>
<div class="line">            user-&gt;uniform = uniform;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If there is already an entry for this parameter ...</span></div>
<div class="line"> <span class="keywordflow">if</span>( user &amp;&amp; user-&gt;texture)</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// ... is it using the right texture?</span></div>
<div class="line">            Texture* texture = user-&gt;texture;</div>
<div class="line"> <span class="keywordflow">if</span>( texture-&gt;name == name)</div>
<div class="line">            {</div>
<div class="line"> <span class="comment">// Same texture means reload!</span></div>
<div class="line">                DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Reloading %s\n"</span>, name.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>()); )</div>
<div class="line"> <span class="keywordflow">if</span>( texture-&gt;texture)</div>
<div class="line">                {</div>
<div class="line">                    texture-&gt;texture-&gt;Release();</div>
<div class="line">                    texture-&gt;texture = NULL;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Now, we're going to be a little nasty here. If we have multiple shaders attached</span></div>
<div class="line"> <span class="comment">// to this texture, they're all going to be trying to reload this texture, and given</span></div>
<div class="line"> <span class="comment">// we don't pay attention to which frame the reload was performed in, we'll reload</span></div>
<div class="line"> <span class="comment">// the texture once for every user. To avoid this, the easiest solution is simply to</span></div>
<div class="line"> <span class="comment">// mark all the other users dirty (to make sure they pick up the new texture, and </span></div>
<div class="line"> <span class="comment">// then delete their usage entries in our cache, so we see them as new users requesting</span></div>
<div class="line"> <span class="comment">// the texture and don't reload the texture multiple times.</span></div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = users.length(); i--; )</div>
<div class="line">                    {</div>
<div class="line"> <span class="keywordflow">if</span>( &amp;users[ i] != user &amp;&amp; users[ i].texture == texture)</div>
<div class="line">                        {</div>
<div class="line">                            DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Breaking texture reference for shared entry %s to avoid duplicate reloads\n"</span>, users[ i].uniform.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>().<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>()); )</div>
<div class="line">                            users[ i].uniform.<a name="a22"></a><a class="code" href="./class_m_uniform_parameter.html#a92a590790db6444ca7a79eaf5fbcb0d9">setDirty</a>();</div>
<div class="line">                            users[ i].texture = NULL;</div>
<div class="line">                            texture-&gt;numUsers--;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                decUsage( texture);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Now forget our texture so the code below will search for the new one</span></div>
<div class="line">                user-&gt;texture = NULL;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If we don't have a texture try and find an existing entry we can reuse</span></div>
<div class="line"> <span class="keywordflow">if</span>( user &amp;&amp; !user-&gt;texture &amp;&amp; name.<a class="code" href="./class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() &gt; 0)</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = textures.length(); i--; )</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordflow">if</span>( textures[ i].name == name &amp;&amp; textures[ i].type == uniform.<a name="a23"></a><a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>())</div>
<div class="line">                {</div>
<div class="line">                    DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Sharing %s\n"</span>, textures[ i].name.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>()); )</div>
<div class="line">                    user-&gt;texture = &amp;textures[ i];</div>
<div class="line">                    user-&gt;texture-&gt;numUsers++;</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If we still don't have a texture, create a new entry</span></div>
<div class="line"> <span class="keywordflow">if</span>( user &amp;&amp; !user-&gt;texture &amp;&amp; name.<a class="code" href="./class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() &gt; 0)</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Remember the current memory offset in case the array gets reallocated</span></div>
<div class="line">            Texture* oldMem = &amp;textures[ 0];</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Create a new texture entry</span></div>
<div class="line">            DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Creating %s\n"</span>, name.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>()); )</div>
<div class="line"> <span class="keywordtype">int</span> idx = textures.length();</div>
<div class="line">            textures.length( idx + 1);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Repair our texture pointers if the memory got reallocated</span></div>
<div class="line">            Texture* newMem = &amp;textures[ 0];</div>
<div class="line"> <span class="keywordflow">if</span>( oldMem != newMem)</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = users.length(); i--; )</div>
<div class="line"> <span class="keywordflow">if</span>( users[ i].texture)</div>
<div class="line">                        users[ i].texture = (Texture*)((<span class="keywordtype">char</span>*)users[ i].texture + ((<span class="keywordtype">char</span>*)newMem - (<span class="keywordtype">char</span>*)oldMem));</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Now setup our new entry</span></div>
<div class="line">            Texture* texture = &amp;textures[ idx];</div>
<div class="line">            texture-&gt;name = name;</div>
<div class="line">            texture-&gt;type = uniform.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>();</div>
<div class="line">            texture-&gt;numUsers = 1;</div>
<div class="line">            user-&gt;texture = texture;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If our texture entry doesn't have a d3d texture, load one in!</span></div>
<div class="line"> <span class="keywordflow">if</span>( user &amp;&amp; user-&gt;texture &amp;&amp; !user-&gt;texture-&gt;texture)</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Create a new texture for this parameter</span></div>
<div class="line"> <a name="_a24"></a><a class="code" href="./class_m_d3_d9_renderer.html">MD3D9Renderer</a> *pRenderer = <a name="a25"></a><a class="code" href="./class_m_d3_d9_renderer.html#a7e20874dc16aef527b927346672fdbfa">MD3D9Renderer::theRenderer</a>();</div>
<div class="line"> <span class="keywordflow">if</span> (pRenderer != NULL) {</div>
<div class="line">                IDirect3DDevice9* d3dDevice = pRenderer-&gt;<a name="a26"></a>getD3D9Device();</div>
<div class="line"> <span class="keywordflow">if</span>(d3dDevice != NULL)</div>
<div class="line">                {</div>
<div class="line">                    DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Loading %s\n"</span>, name.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>()); )</div>
<div class="line"> <span class="keywordflow">if</span>( uniform.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>() == <a name="a27"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6af5ef31be5108f486d286c06c13df0578">MUniformParameter::kTypeCubeTexture</a>)</div>
<div class="line">                        {</div>
<div class="line">                            LPDIRECT3DCUBETEXTURE9 d3dTexture;</div>
<div class="line"> <span class="keywordflow">if</span>( D3DXCreateCubeTextureFromFile(d3dDevice, name.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), &amp;d3dTexture) == D3D_OK)</div>
<div class="line">                                user-&gt;texture-&gt;texture = d3dTexture;</div>
<div class="line">                        }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( uniform.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>() == <a name="a28"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a1f0476b91ae65b4ea6d0ce691f58be83">MUniformParameter::kType3DTexture</a>)</div>
<div class="line">                        {</div>
<div class="line">                            LPDIRECT3DVOLUMETEXTURE9 d3dTexture;</div>
<div class="line"> <span class="keywordflow">if</span>( D3DXCreateVolumeTextureFromFile( d3dDevice, name.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), &amp;d3dTexture) == D3D_OK)</div>
<div class="line">                                user-&gt;texture-&gt;texture = d3dTexture;</div>
<div class="line">                        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                        {</div>
<div class="line">                            LPDIRECT3DTEXTURE9 d3dTexture;</div>
<div class="line"> <span class="keywordflow">if</span>( D3DXCreateTextureFromFile(d3dDevice, name.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), &amp;d3dTexture) == D3D_OK)</div>
<div class="line">                                user-&gt;texture-&gt;texture = d3dTexture;</div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Finally, bind our texture to the parameter</span></div>
<div class="line">        d3dEffect-&gt;SetTexture( d3dParameter, (user &amp;&amp; user-&gt;texture) ? user-&gt;texture-&gt;texture : NULL);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Drop all the textures being used by the specified effect</span></div>
<div class="line"> <span class="keywordtype">void</span> release( LPD3DXEFFECT effect)</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = users.length(); i--; )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">if</span>( users[ i].effect == effect)</div>
<div class="line">            {</div>
<div class="line">                DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Releasing effect usage %s\n"</span>, users[ i].uniform.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>().<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>()); )</div>
<div class="line"> <span class="keywordflow">if</span>( users[ i].texture) decUsage( users[ i].texture);</div>
<div class="line"> <span class="keywordtype">int</span> newLength = users.length() - 1;</div>
<div class="line"> <span class="keywordflow">if</span>( i != newLength)</div>
<div class="line">                    users[ i] = users[ newLength];</div>
<div class="line">                users.length( newLength);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a name="a29"></a><a class="code" href="./class_m_hwr_callback.html#a3252d3ddda1ce16cc70ec872bd6ba500">deviceNew</a>() {}</div>
<div class="line"> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a name="a30"></a><a class="code" href="./class_m_hwr_callback.html#a302e6f42aaa50b435c7287432f6c7988">deviceLost</a>() { release(); }</div>
<div class="line"> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a name="a31"></a><a class="code" href="./class_m_hwr_callback.html#a3ae7ee9e49057e1d91837b94fe121e8b">deviceDeleted</a>() { release(); }</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">void</span> newSceneCallback( <span class="keywordtype">void</span>* ptr) { ((HLSLTextureManager*)ptr)-&gt;release(); }</div>
<div class="line"></div>
<div class="line"> <span class="keyword">struct </span>Texture</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">inline</span>          Texture() : numUsers( 0), texture( NULL) {}</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a>         name;</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6">MUniformParameter::DataType</a> type;</div>
<div class="line">        LPDIRECT3DBASETEXTURE9 texture;</div>
<div class="line"> <span class="keywordtype">int</span>             numUsers;</div>
<div class="line">    };</div>
<div class="line"> <span class="keyword">struct </span>User</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">inline</span>          User() : parameter( NULL), effect( NULL), texture( NULL) {}</div>
<div class="line">        D3DXHANDLE      parameter;</div>
<div class="line">        LPD3DXEFFECT    effect;</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> uniform;</div>
<div class="line">        Texture*        texture;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    ObjArray&lt;Texture&gt;   textures;</div>
<div class="line">    ObjArray&lt;User&gt;      users;</div>
<div class="line">    MCallbackId         sceneCallbackIds[ 2];</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span>        release()</div>
<div class="line">    {</div>
<div class="line">        DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Releasing cache with %d textures and %d users\n"</span>, textures.length(), users.length()); )</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = users.length(); i--; )</div>
<div class="line">            users[ i].uniform.<a class="code" href="./class_m_uniform_parameter.html#a92a590790db6444ca7a79eaf5fbcb0d9">setDirty</a>();</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = textures.length(); i--; )</div>
<div class="line"> <span class="keywordflow">if</span>( textures[ i].texture)</div>
<div class="line">                textures[ i].texture-&gt;Release();</div>
<div class="line">        users.length( 0);</div>
<div class="line">        textures.length( 0);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">void</span>        decUsage( Texture* texture)</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// It's currently using a different texture</span></div>
<div class="line"> <span class="keywordflow">if</span>( --texture-&gt;numUsers == 0)</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Drat! We're the last user of this texture so we need to remove it</span></div>
<div class="line">            DEBUG_TEXTURE_CACHE( printf( <span class="stringliteral">"Unloading %s\n"</span>, texture-&gt;name.asChar()); )</div>
<div class="line"> <span class="keywordflow">if</span>( texture-&gt;texture)</div>
<div class="line">                texture-&gt;texture-&gt;Release();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If this isn't the last texture in our list, we need to shuffle our</span></div>
<div class="line"> <span class="comment">// textures around to fill the hole it leaves behind</span></div>
<div class="line">            Texture* lastTexture = &amp;textures[ textures.length() - 1];</div>
<div class="line">            if( texture != lastTexture)</div>
<div class="line">            {</div>
<div class="line">                *texture = *lastTexture;</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = users.length(); i--; )</div>
<div class="line"> <span class="keywordflow">if</span>( users[ i].texture == lastTexture)</div>
<div class="line">                        users[ i].texture = texture;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Now remove the unused texture (which is now guaranteed to be at the</span></div>
<div class="line"> <span class="comment">// end of the array) from our list</span></div>
<div class="line">            textures.length( textures.length() - 1);</div>
<div class="line">        }</div>
<div class="line">        DEBUG_TEXTURE_CACHE( <span class="keywordflow">else</span> printf( <span class="stringliteral">"Unsharing %s\n"</span>, texture-&gt;name.asChar()); )</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line">HLSLTextureManager HLSLTextureManager::sInstance;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Find an annotation</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">bool</span> hlslShader::GetAnnotation( D3DXHANDLE parameter, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, LPCSTR&amp; value)</div>
<div class="line">{</div>
<div class="line">    D3DXHANDLE d3dSemantic = fD3DEffect-&gt;GetAnnotationByName( parameter, name);</div>
<div class="line"> <span class="keywordflow">return</span> d3dSemantic &amp;&amp; fD3DEffect-&gt;GetString( d3dSemantic, &amp;value) == D3D_OK &amp;&amp; value != NULL;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">bool</span> hlslShader::GetBOOLAnnotation( D3DXHANDLE parameter, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, BOOL&amp; value)</div>
<div class="line">{</div>
<div class="line">    D3DXHANDLE d3dSemantic = fD3DEffect-&gt;GetAnnotationByName( parameter, name);</div>
<div class="line"> <span class="keywordflow">return</span> d3dSemantic &amp;&amp; fD3DEffect-&gt;GetBool( d3dSemantic, &amp;value) == D3D_OK;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">bool</span> hlslShader::GetAnnotation( D3DXHANDLE parameter, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keywordtype">float</span>&amp; value)</div>
<div class="line">{</div>
<div class="line">    D3DXHANDLE d3dSemantic = fD3DEffect-&gt;GetAnnotationByName( parameter, name);</div>
<div class="line"> <span class="keywordflow">return</span> d3dSemantic &amp;&amp; fD3DEffect-&gt;GetFloat( d3dSemantic, &amp;value) == D3D_OK;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">bool</span> hlslShader::GetAnnotation( D3DXHANDLE parameter, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keywordtype">int</span>&amp; value)</div>
<div class="line">{</div>
<div class="line">    D3DXHANDLE d3dSemantic = fD3DEffect-&gt;GetAnnotationByName( parameter, name);</div>
<div class="line"> <span class="keywordflow">return</span> d3dSemantic &amp;&amp; fD3DEffect-&gt;GetInt( d3dSemantic, &amp;value) == D3D_OK;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// </span></div>
<div class="line"><span class="comment">// Convert a DX type into a Maya type</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6">MUniformParameter::DataType</a> hlslShader::ConvertType( D3DXHANDLE parameter, D3DXPARAMETER_DESC&amp; description)</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6">MUniformParameter::DataType</a> mtype = <a name="a32"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6aa3016cbceb721f8a4e567dc4d54d6dc6">MUniformParameter::kTypeUnknown</a>;</div>
<div class="line"> <span class="keywordflow">switch</span>( description.Type)</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">//case D3DXPT_VOID: break; </span></div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_BOOL: mtype = <a name="a33"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a52b0938c028df56b62bc9e9080475e7f">MUniformParameter::kTypeBool</a>; <span class="keywordflow">break</span>; </div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_INT: mtype = <a name="a34"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6ab6e6fe667e0718b58ca5f6ac419c7cf7">MUniformParameter::kTypeInt</a>; <span class="keywordflow">break</span>; </div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_FLOAT: mtype = <a name="a35"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6ae59341821f9cdc0608d1f8775fb3eb7a">MUniformParameter::kTypeFloat</a>; <span class="keywordflow">break</span>; </div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_STRING: mtype = <a name="a36"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a00d1e209478ab74cbadfbe8435e32e81">MUniformParameter::kTypeString</a>; <span class="keywordflow">break</span>; </div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_TEXTURE1D: mtype = <a name="a37"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a9eafb8c812a708ea65bcbc4cab43bb8a">MUniformParameter::kType1DTexture</a>; <span class="keywordflow">break</span>; </div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_TEXTURE2D: mtype = <a name="a38"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a7d3972f1f1ee99452d3c715b157b5cad">MUniformParameter::kType2DTexture</a>; <span class="keywordflow">break</span>; </div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_TEXTURE3D: mtype = <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a1f0476b91ae65b4ea6d0ce691f58be83">MUniformParameter::kType3DTexture</a>; <span class="keywordflow">break</span>; </div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_TEXTURECUBE: mtype = <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6af5ef31be5108f486d286c06c13df0578">MUniformParameter::kTypeCubeTexture</a>; <span class="keywordflow">break</span>; </div>
<div class="line"> <span class="keywordflow">case</span> D3DXPT_TEXTURE: </div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// The shader hasn't used a typed texture, so first see if there's an annotation</span></div>
<div class="line"> <span class="comment">// that tells us which type to use.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">            LPCSTR textureType;</div>
<div class="line"> <span class="keywordflow">if</span>( ( GetAnnotation( parameter, <span class="stringliteral">"TextureType"</span>, textureType) || GetAnnotation( parameter, <span class="stringliteral">"ResourceType"</span>, textureType)) &amp;&amp; textureType)</div>
<div class="line">            {</div>
<div class="line"> <span class="comment">// Grab the type off from the annotation</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordflow">if</span>( !_stricmp( textureType, <span class="stringliteral">"1D"</span>)) mtype = <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a9eafb8c812a708ea65bcbc4cab43bb8a">MUniformParameter::kType1DTexture</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( textureType, <span class="stringliteral">"2D"</span>)) mtype = <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a7d3972f1f1ee99452d3c715b157b5cad">MUniformParameter::kType2DTexture</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( textureType, <span class="stringliteral">"3D"</span>)) mtype = <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a1f0476b91ae65b4ea6d0ce691f58be83">MUniformParameter::kType3DTexture</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( textureType, <span class="stringliteral">"Cube"</span>)) mtype = <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6af5ef31be5108f486d286c06c13df0578">MUniformParameter::kTypeCubeTexture</a>;</div>
<div class="line"> <span class="keywordflow">else</span> </div>
<div class="line">                {</div>
<div class="line">                    fDiagnostics += <span class="stringliteral">"Unrecognised texture type semantic "</span>;</div>
<div class="line">                    fDiagnostics += textureType;</div>
<div class="line">                    fDiagnostics += <span class="stringliteral">" on parameter "</span>;</div>
<div class="line">                    fDiagnostics += description.Name;</div>
<div class="line">                    fDiagnostics += <span class="stringliteral">"\n"</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span>( mtype == <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6aa3016cbceb721f8a4e567dc4d54d6dc6">MUniformParameter::kTypeUnknown</a>)</div>
<div class="line">            {</div>
<div class="line"> <span class="comment">// No explicit type. At this stage, it would be nice to take a look at the </span></div>
<div class="line"> <span class="comment">// sampler which uses the texture and grab the type of that, but I can't see</span></div>
<div class="line"> <span class="comment">// any way to query for the sampler -&gt; texture bindings through the effect</span></div>
<div class="line"> <span class="comment">// API. </span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">                mtype = <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a7d3972f1f1ee99452d3c715b157b5cad">MUniformParameter::kType2DTexture</a>;</div>
<div class="line">                fDiagnostics += <span class="stringliteral">"No texture type provided for "</span>;</div>
<div class="line">                fDiagnostics += description.Name;</div>
<div class="line">                fDiagnostics += <span class="stringliteral">", assuming 2D\n"</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line"> <span class="keywordflow">break</span>; </div>
<div class="line">        }</div>
<div class="line"> <span class="comment">//case D3DXPT_SAMPLER: break; </span></div>
<div class="line"> <span class="comment">//case D3DXPT_SAMPLER1D: break; </span></div>
<div class="line"> <span class="comment">//case D3DXPT_SAMPLER2D: break; </span></div>
<div class="line"> <span class="comment">//case D3DXPT_SAMPLER3D: break; </span></div>
<div class="line"> <span class="comment">//case D3DXPT_SAMPLERCUBE: break; </span></div>
<div class="line"> <span class="comment">//case D3DXPT_PIXELSHADER: break; </span></div>
<div class="line"> <span class="comment">//case D3DXPT_VERTEXSHADER: break; </span></div>
<div class="line"> <span class="comment">//case D3DXPT_PIXELFRAGMENT: break; </span></div>
<div class="line"> <span class="comment">//case D3DXPT_VERTEXFRAGMENT: break; </span></div>
<div class="line"> <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> mtype;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Convert a DX space into a Maya space</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234ef">MUniformParameter::DataSemantic</a> hlslShader::ConvertSpace( D3DXHANDLE parameter, D3DXPARAMETER_DESC&amp; description, <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234ef">MUniformParameter::DataSemantic</a> defaultSpace)</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234ef">MUniformParameter::DataSemantic</a> space = defaultSpace;</div>
<div class="line">    LPCSTR ann;</div>
<div class="line"> <span class="keywordflow">if</span>( GetAnnotation( parameter, <span class="stringliteral">"Space"</span>, ann) &amp;&amp; ann)</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span>( !_stricmp( ann, <span class="stringliteral">"Object"</span>)) space = defaultSpace &gt;= <a name="a39"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad6267c9673325fa9a63cfc0bb300a315">MUniformParameter::kSemanticObjectPos</a> ? <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad6267c9673325fa9a63cfc0bb300a315">MUniformParameter::kSemanticObjectPos</a> : <a name="a40"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa09d1a594e9e76ff19ada1f447328882e">MUniformParameter::kSemanticObjectDir</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( ann, <span class="stringliteral">"World"</span>)) space = defaultSpace &gt;= <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad6267c9673325fa9a63cfc0bb300a315">MUniformParameter::kSemanticObjectPos</a> ? <a name="a41"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa49972843e25838c681f26a4f75ca69c1">MUniformParameter::kSemanticWorldPos</a> : <a name="a42"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad606c99fe89502591358e64f4f7a589b">MUniformParameter::kSemanticWorldDir</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( ann, <span class="stringliteral">"View"</span>)) space = defaultSpace &gt;= <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad6267c9673325fa9a63cfc0bb300a315">MUniformParameter::kSemanticObjectPos</a> ? <a name="a43"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa5f7f2dd48bf94ec26eba9f19290eb3ba">MUniformParameter::kSemanticViewPos</a> : <a name="a44"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efae5534556150af0c82c0bd935de2e5071">MUniformParameter::kSemanticViewDir</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( ann, <span class="stringliteral">"Camera"</span>)) space = defaultSpace &gt;= <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad6267c9673325fa9a63cfc0bb300a315">MUniformParameter::kSemanticObjectPos</a> ? <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa5f7f2dd48bf94ec26eba9f19290eb3ba">MUniformParameter::kSemanticViewPos</a> : <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efae5534556150af0c82c0bd935de2e5071">MUniformParameter::kSemanticViewDir</a>;</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            fDiagnostics += <span class="stringliteral">"Unrecognised space "</span>;</div>
<div class="line">            fDiagnostics += ann;</div>
<div class="line">            fDiagnostics += <span class="stringliteral">" on parameter "</span>;</div>
<div class="line">            fDiagnostics += description.Name;</div>
<div class="line">            fDiagnostics += <span class="stringliteral">"\n"</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> space;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Convert a DX semantic into a Maya semantic</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234ef">MUniformParameter::DataSemantic</a> hlslShader::ConvertSemantic( D3DXHANDLE parameter, D3DXPARAMETER_DESC&amp; description)</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234ef">MUniformParameter::DataSemantic</a> msemantic = <a name="a45"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad77adc4222e9872b4688930cd6920e4c">MUniformParameter::kSemanticUnknown</a>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// First try the explicit semantic</span></div>
<div class="line"> <span class="keywordflow">if</span>( description.Semantic &amp;&amp; *description.Semantic)</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"World"</span>))                             msemantic = <a name="a46"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efaebbf84be5dd7360e2bbf5eb369fc97c0">MUniformParameter::kSemanticWorldMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"WorldInverse"</span>))                      msemantic = <a name="a47"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa2b32c47f701e1aee06ad4da2308b1e5b">MUniformParameter::kSemanticWorldInverseMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"WorldInverseTranspose"</span>))             msemantic = <a name="a48"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efae4206f3e87fcc5e8aaca57f71b488f74">MUniformParameter::kSemanticWorldInverseTransposeMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"View"</span>))                              msemantic = <a name="a49"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa9286c5e650ac955bb9239a33fc8a6881">MUniformParameter::kSemanticViewMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"ViewInverse"</span>))                       msemantic = <a name="a50"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa18c403ade6b055399d73781ec5525ec8">MUniformParameter::kSemanticViewInverseMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"ViewInverseTranspose"</span>))              msemantic = <a name="a51"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efac2fd760682e8b70a19fbb00d9fbbca10">MUniformParameter::kSemanticViewInverseTransposeMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Projection"</span>))                            msemantic = <a name="a52"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa5ee9d38749ff3eecb39e8a5d7939bf12">MUniformParameter::kSemanticProjectionMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"ProjectionInverse"</span>))                 msemantic = <a name="a53"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa50da21dea2dc0c66c65447c4064aeab4">MUniformParameter::kSemanticProjectionInverseMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"ProjectionInverseTranspose"</span>))            msemantic = <a name="a54"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa2db728cf9d48ad6eef29c86811633aa2">MUniformParameter::kSemanticProjectionInverseTransposeMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"WorldView"</span>))                         msemantic = <a name="a55"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efafed2a73eecf453663e5049f7b91ab454">MUniformParameter::kSemanticWorldViewMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"WorldViewInverse"</span>))                  msemantic = <a name="a56"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa82582b0dacdb426a631d6b6d6e7bd318">MUniformParameter::kSemanticWorldViewInverseMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"WorldViewInverseTranspose"</span>))         msemantic = <a name="a57"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa882552cd5dbb4f1e79fbf6f191a519b6">MUniformParameter::kSemanticWorldViewInverseTransposeMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"WorldViewProjection"</span>))               msemantic = <a name="a58"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efac2845cd2c335834608660c432a75bfc7">MUniformParameter::kSemanticWorldViewProjectionMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"WorldViewProjectionInverse"</span>))            msemantic = <a name="a59"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa87ea4b79868f0697c3044d0e8e20c3cf">MUniformParameter::kSemanticWorldViewProjectionInverseMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"WorldViewProjectionInverseTranspose"</span>))msemantic = <a name="a60"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad5142de73b4e8966659887132402b4b0">MUniformParameter::kSemanticWorldViewProjectionInverseTransposeMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Diffuse"</span>))                           msemantic = <a name="a61"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efab83a5901dec4867950652df9bde9c87a">MUniformParameter::kSemanticColor</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Specular"</span>))                          msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efab83a5901dec4867950652df9bde9c87a">MUniformParameter::kSemanticColor</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Ambient"</span>))                           msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efab83a5901dec4867950652df9bde9c87a">MUniformParameter::kSemanticColor</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Color"</span>))                             msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efab83a5901dec4867950652df9bde9c87a">MUniformParameter::kSemanticColor</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Normal"</span>))                                msemantic = <a name="a62"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa902d41d2f20092eb5696141b60e42b25">MUniformParameter::kSemanticNormal</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Bump"</span>))                              msemantic = <a name="a63"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efae867e160beb59794a5b46005abdfec40">MUniformParameter::kSemanticBump</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Environment"</span>))                       msemantic = <a name="a64"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa37192c0f651ef717c41cbc9678d1f5d4">MUniformParameter::kSemanticEnvironment</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Time"</span>))                              msemantic = <a name="a65"></a><a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa78f71ae1aff5a5ac40249feae9951768">MUniformParameter::kSemanticTime</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Position"</span>))                          msemantic = ConvertSpace( parameter, description, <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa49972843e25838c681f26a4f75ca69c1">MUniformParameter::kSemanticWorldPos</a>);</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( description.Semantic, <span class="stringliteral">"Direction"</span>))                         msemantic = ConvertSpace( parameter, description, <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efae5534556150af0c82c0bd935de2e5071">MUniformParameter::kSemanticViewDir</a>);</div>
<div class="line"> <span class="keywordflow">else</span> </div>
<div class="line">        {</div>
<div class="line">            fDiagnostics += <span class="stringliteral">"Unrecognised semantic "</span>;</div>
<div class="line">            fDiagnostics += description.Semantic;</div>
<div class="line">            fDiagnostics += <span class="stringliteral">" on parameter "</span>;</div>
<div class="line">            fDiagnostics += description.Name;</div>
<div class="line">            fDiagnostics += <span class="stringliteral">"\n"</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Next, try annotation semantic</span></div>
<div class="line"> <span class="keywordflow">if</span>( msemantic == <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad77adc4222e9872b4688930cd6920e4c">MUniformParameter::kSemanticUnknown</a>)</div>
<div class="line">    {</div>
<div class="line">        LPCSTR sasSemantic;</div>
<div class="line"> <span class="keywordflow">if</span>( GetAnnotation( parameter, <span class="stringliteral">"SasBindAddress"</span>, sasSemantic) &amp;&amp; *sasSemantic)</div>
<div class="line">        {</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> str( sasSemantic);</div>
<div class="line"> <span class="keywordflow">if</span>( !_stricmp( sasSemantic, <span class="stringliteral">"Sas.Skeleton.MeshToJointToWorld[0]"</span>)) msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efaebbf84be5dd7360e2bbf5eb369fc97c0">MUniformParameter::kSemanticWorldMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( sasSemantic, <span class="stringliteral">"Sas.Camera.WorldToView"</span>))             msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa9286c5e650ac955bb9239a33fc8a6881">MUniformParameter::kSemanticViewMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( sasSemantic, <span class="stringliteral">"Sas.Camera.Projection"</span>))              msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa5ee9d38749ff3eecb39e8a5d7939bf12">MUniformParameter::kSemanticProjectionMatrix</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !_stricmp( sasSemantic, <span class="stringliteral">"Sas.Time.Now"</span>))                       msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa78f71ae1aff5a5ac40249feae9951768">MUniformParameter::kSemanticTime</a>;</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( str.rindexW( <span class="stringliteral">".Position"</span>) &gt;= 0)                                msemantic = ConvertSpace( parameter, description, <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa49972843e25838c681f26a4f75ca69c1">MUniformParameter::kSemanticWorldPos</a>);</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( str.rindexW( <span class="stringliteral">".Direction"</span>) &gt;= 0 &amp;&amp; str.rindexW( <span class="stringliteral">".Direction"</span>) != str.rindexW( <span class="stringliteral">".Directional"</span>)) msemantic = ConvertSpace( parameter, description, <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efae5534556150af0c82c0bd935de2e5071">MUniformParameter::kSemanticViewDir</a>);</div>
<div class="line"> <span class="keywordflow">else</span> </div>
<div class="line">            {</div>
<div class="line">                fDiagnostics += <span class="stringliteral">"Unrecognised semantic "</span>;</div>
<div class="line">                fDiagnostics += sasSemantic;</div>
<div class="line">                fDiagnostics += <span class="stringliteral">" on parameter "</span>;</div>
<div class="line">                fDiagnostics += description.Name;</div>
<div class="line">                fDiagnostics += <span class="stringliteral">"\n"</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Next try control type</span></div>
<div class="line"> <span class="keywordflow">if</span>( msemantic == <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad77adc4222e9872b4688930cd6920e4c">MUniformParameter::kSemanticUnknown</a>)</div>
<div class="line">    {</div>
<div class="line">        LPCSTR sasSemantic;</div>
<div class="line"> <span class="keywordflow">if</span>( GetAnnotation( parameter, <span class="stringliteral">"SasUiControl"</span>, sasSemantic) &amp;&amp; *sasSemantic)</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">if</span>( !_stricmp( sasSemantic, <span class="stringliteral">"ColorPicker"</span>))                            msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efab83a5901dec4867950652df9bde9c87a">MUniformParameter::kSemanticColor</a>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// As a last ditch effort, look for an obvious parameter name</span></div>
<div class="line"> <span class="keywordflow">if</span>( msemantic == <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad77adc4222e9872b4688930cd6920e4c">MUniformParameter::kSemanticUnknown</a>)</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> name( description.Name);</div>
<div class="line"> <span class="keywordflow">if</span>( name.rindexW( <span class="stringliteral">"Position"</span>) &gt;= 0)                                 msemantic = ConvertSpace( parameter, description, <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efa49972843e25838c681f26a4f75ca69c1">MUniformParameter::kSemanticWorldPos</a>);</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( name.rindexW( <span class="stringliteral">"Direction"</span>) &gt;= 0 &amp;&amp; name.rindexW( <span class="stringliteral">"Direction"</span>) != name.rindexW( <span class="stringliteral">"Directional"</span>)) msemantic = ConvertSpace( parameter, description, <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efad606c99fe89502591358e64f4f7a589b">MUniformParameter::kSemanticWorldDir</a>);</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( name.rindexW( <span class="stringliteral">"Color"</span>) &gt;= 0 || name.rindexW( <span class="stringliteral">"Colour"</span>) &gt;= 0 || name.rindexW( <span class="stringliteral">"Diffuse"</span>) &gt;= 0 || name.rindexW( <span class="stringliteral">"Specular"</span>) &gt;= 0 || name.rindexW( <span class="stringliteral">"Ambient"</span>) &gt;= 0)</div>
<div class="line">                                                                                    msemantic = <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234efab83a5901dec4867950652df9bde9c87a">MUniformParameter::kSemanticColor</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> msemantic;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// This typeid must be unique across the universe of Maya plug-ins.  </span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line"><a name="_a66"></a><a class="code" href="./class_m_type_id.html">MTypeId</a>     hlslShader::sId( 0xF3560C30 );</div>
<div class="line"></div>
<div class="line"><span class="comment">// Our rendering profile</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a name="_a67"></a><a class="code" href="./class_m_render_profile.html">MRenderProfile</a> hlslShader::sProfile;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Attribute declarations</span></div>
<div class="line"><span class="comment">// </span></div>
<div class="line"><a name="_a68"></a><a class="code" href="./class_m_object.html">MObject</a>     hlslShader::sShader;</div>
<div class="line"><a class="code" href="./class_m_object.html">MObject</a>     hlslShader::sTechnique;</div>
<div class="line"><a class="code" href="./class_m_object.html">MObject</a>     hlslShader::sTechniques;</div>
<div class="line"><a class="code" href="./class_m_object.html">MObject</a>     hlslShader::sDescription;</div>
<div class="line"><a class="code" href="./class_m_object.html">MObject</a>     hlslShader::sDiagnostics;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define M_CHECK(assertion)  if (assertion) ; else throw ((hlsl::InternalError*)__LINE__)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>hlsl</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#ifdef _WIN32</span></div>
<div class="line"> <span class="keyword">class </span>InternalError;    <span class="comment">// Never defined.  Used like this:</span></div>
<div class="line"> <span class="comment">//   throw (InternalError*)__LINE__;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"> <span class="keyword">struct </span>InternalError</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordtype">char</span>* message;</div>
<div class="line">    };</div>
<div class="line"> <span class="comment">//   throw (InternalError*)__LINE__;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//--------------------------------------------------------------------//</span></div>
<div class="line"><span class="comment">// Constructor:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">hlslShader::hlslShader()</div>
<div class="line">: fErrorCount( 0), fD3DEffect( NULL), fD3DTechnique( NULL), </div>
<div class="line">  fD3DVertexDeclaration( NULL), fVertexStructure( <span class="stringliteral">"VertexStructure"</span>, <a name="_a69"></a><a class="code" href="./class_m_varying_parameter.html">MVaryingParameter</a>::kStructure), </div>
<div class="line">  fDeviceManager( me()),</div>
<div class="line">  fTechniqueHasBlending( false ),</div>
<div class="line">  fPostDuplicateCallbackId( NULL )</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Post-constructor</span></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">hlslShader::postConstructor()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Don't create any default varying parameters (e.g. position + normal) for empty</span></div>
<div class="line"> <span class="comment">// shaders as this just bloats the cache with a useless structure that is currently</span></div>
<div class="line"> <span class="comment">// not flushed out of the cache until the geometry changes. Instead, just render</span></div>
<div class="line"> <span class="comment">// the default geometry directly off the position array in the cache</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Destructor:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">hlslShader::~hlslShader()</div>
<div class="line">{</div>
<div class="line">    release();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Release all our device handles</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> hlslShader::release()</div>
<div class="line">{</div>
<div class="line">    releaseVertexDeclaration();</div>
<div class="line"> <span class="keywordflow">if</span>( fD3DEffect) </div>
<div class="line">    {</div>
<div class="line">        HLSLTextureManager::sInstance.release( fD3DEffect);</div>
<div class="line">        fD3DEffect-&gt;Release();</div>
<div class="line">        fD3DEffect = NULL;</div>
<div class="line">    }</div>
<div class="line">    fD3DTechnique = NULL;</div>
<div class="line">    fTechniqueHasBlending = <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Release our vertex declaration</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> hlslShader::releaseVertexDeclaration()</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span>( fD3DVertexDeclaration) </div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p = 0; p &lt; fD3DTechniqueDesc.Passes; p++)</div>
<div class="line"> <span class="keywordflow">if</span>( fD3DVertexDeclaration[ p])</div>
<div class="line">                fD3DVertexDeclaration[ p]-&gt;Release();</div>
<div class="line"> <span class="keyword">delete</span>[] fD3DVertexDeclaration;</div>
<div class="line">        fD3DVertexDeclaration = NULL;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// ========== hlslShader::creator ==========</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  Description:</span></div>
<div class="line"><span class="comment">//      this method exists to give Maya a way to create new objects</span></div>
<div class="line"><span class="comment">//      of this type.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  Return Value:</span></div>
<div class="line"><span class="comment">//      a new object of this type.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">/* static */</span></div>
<div class="line"><span class="keywordtype">void</span>* hlslShader::creator()</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">new</span> hlslShader();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// ========== hlslShader::initialize ==========</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  Description:</span></div>
<div class="line"><span class="comment">//      This method is called to create and initialize all of the attributes</span></div>
<div class="line"><span class="comment">//      and attribute dependencies for this node type.  This is only called </span></div>
<div class="line"><span class="comment">//      once when the node type is registered with Maya.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//  Return Values:</span></div>
<div class="line"><span class="comment">//      MS::kSuccess</span></div>
<div class="line"><span class="comment">//      MS::kFailure</span></div>
<div class="line"><span class="comment">//      </span></div>
<div class="line"><span class="comment">/* static */</span></div>
<div class="line"><a name="_a70"></a><a class="code" href="./class_m_status.html">MStatus</a></div>
<div class="line">hlslShader::initialize()</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> ms;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">        initializeNodeAttrs();</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">catch</span> ( ... )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// [mashworth] Don't forget I18N</span></div>
<div class="line"> <a name="a71"></a><a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( <span class="stringliteral">"hlslShader internal error: Unhandled exception in initialize"</span> );</div>
<div class="line">        ms = <a name="a72"></a><a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    sProfile.addRenderer( <a name="a73"></a><a class="code" href="./class_m_render_profile.html#a7f20c37a8a7dba81b35df0f8d841129ba9b232cce89de80d357dce779509fc75a">MRenderProfile::kMayaD3D</a>);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> ms;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Create all the attributes. </span></div>
<div class="line"><span class="comment">/* static */</span></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">hlslShader::initializeNodeAttrs()</div>
<div class="line">{</div>
<div class="line"> <a name="_a74"></a><a class="code" href="./class_m_fn_typed_attribute.html">MFnTypedAttribute</a>   typedAttr;</div>
<div class="line"> <a name="_a75"></a><a class="code" href="./class_m_fn_string_data.html">MFnStringData</a>       stringData;</div>
<div class="line"> <a name="_a76"></a><a class="code" href="./class_m_fn_string_array_data.html">MFnStringArrayData</a>  stringArrayData;</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a>             stat, stat2;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// The shader attribute holds the name of the .fx file that defines</span></div>
<div class="line"> <span class="comment">// the shader</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    sShader = typedAttr.<a name="a77"></a><a class="code" href="./class_m_fn_typed_attribute.html#af785af0a66bd4a4da1d9f7bd74d4de0a">create</a>(<span class="stringliteral">"shader"</span>, <span class="stringliteral">"s"</span>, <a name="a78"></a><a class="code" href="./class_m_fn_data.html#a1d1cfd8ffb84e947f82999c682b666a7afab53ea4a643325262b9c140af093279">MFnData::kString</a>, stringData.<a name="a79"></a><a class="code" href="./class_m_fn_string_data.html#a2a76d6e5a305b483c5d9b8444fb79126">create</a>(&amp;stat2), &amp;stat); </div>
<div class="line">    M_CHECK( stat );</div>
<div class="line">    typedAttr.<a name="a80"></a><a class="code" href="./class_m_fn_attribute.html#ae27cf2fd28a3c69b880b1096ea9e0103">setInternal</a>( <span class="keyword">true</span>); </div>
<div class="line">    typedAttr.<a name="a81"></a><a class="code" href="./class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>( <span class="keyword">false</span>); </div>
<div class="line">    stat = addAttribute(sShader); </div>
<div class="line">    M_CHECK( stat );</div>
<div class="line"></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="comment">// technique</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    sTechnique = typedAttr.<a class="code" href="./class_m_fn_typed_attribute.html#af785af0a66bd4a4da1d9f7bd74d4de0a">create</a>(<span class="stringliteral">"technique"</span>, <span class="stringliteral">"t"</span>, <a class="code" href="./class_m_fn_data.html#a1d1cfd8ffb84e947f82999c682b666a7afab53ea4a643325262b9c140af093279">MFnData::kString</a>, stringData.<a class="code" href="./class_m_fn_string_data.html#a2a76d6e5a305b483c5d9b8444fb79126">create</a>(&amp;stat2), &amp;stat); </div>
<div class="line">    M_CHECK( stat );</div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#ae27cf2fd28a3c69b880b1096ea9e0103">setInternal</a>( <span class="keyword">true</span>);</div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>( <span class="keyword">true</span>);</div>
<div class="line">    stat = addAttribute(sTechnique);</div>
<div class="line">    M_CHECK( stat );</div>
<div class="line"></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="comment">// technique list</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    sTechniques = typedAttr.<a class="code" href="./class_m_fn_typed_attribute.html#af785af0a66bd4a4da1d9f7bd74d4de0a">create</a>(<span class="stringliteral">"techniques"</span>, <span class="stringliteral">"ts"</span>, <a name="a82"></a><a class="code" href="./class_m_fn_data.html#a1d1cfd8ffb84e947f82999c682b666a7a7f61c3f7033fde37de0e63f291c9e834">MFnData::kStringArray</a>, stringArrayData.<a name="a83"></a><a class="code" href="./class_m_fn_string_array_data.html#af1adb4abaf5243c6c0749bcca7b5c418">create</a>(&amp;stat2), &amp;stat); </div>
<div class="line">    M_CHECK( stat );</div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#ae27cf2fd28a3c69b880b1096ea9e0103">setInternal</a>( <span class="keyword">true</span>);</div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>( <span class="keyword">false</span>);</div>
<div class="line">    typedAttr.<a name="a84"></a><a class="code" href="./class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>( <span class="keyword">false</span>);</div>
<div class="line">    typedAttr.<a name="a85"></a><a class="code" href="./class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>( <span class="keyword">false</span>);</div>
<div class="line">    stat = addAttribute(sTechniques);</div>
<div class="line">    M_CHECK( stat );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// The description field where we pass compile errors etc back for the user to see</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    sDescription = typedAttr.<a class="code" href="./class_m_fn_typed_attribute.html#af785af0a66bd4a4da1d9f7bd74d4de0a">create</a>(<span class="stringliteral">"description"</span>, <span class="stringliteral">"desc"</span>, <a class="code" href="./class_m_fn_data.html#a1d1cfd8ffb84e947f82999c682b666a7afab53ea4a643325262b9c140af093279">MFnData::kString</a>, stringData.<a class="code" href="./class_m_fn_string_data.html#a2a76d6e5a305b483c5d9b8444fb79126">create</a>(&amp;stat2), &amp;stat); </div>
<div class="line">    M_CHECK( stat );</div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>( <span class="keyword">false</span>); </div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>( <span class="keyword">false</span>); </div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>( <span class="keyword">false</span>); </div>
<div class="line">    stat = addAttribute(sDescription); </div>
<div class="line">    M_CHECK( stat );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// The feedback field where we pass compile errors etc back for the user to see</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    sDiagnostics = typedAttr.<a class="code" href="./class_m_fn_typed_attribute.html#af785af0a66bd4a4da1d9f7bd74d4de0a">create</a>(<span class="stringliteral">"diagnostics"</span>, <span class="stringliteral">"diag"</span>, <a class="code" href="./class_m_fn_data.html#a1d1cfd8ffb84e947f82999c682b666a7afab53ea4a643325262b9c140af093279">MFnData::kString</a>, stringData.<a class="code" href="./class_m_fn_string_data.html#a2a76d6e5a305b483c5d9b8444fb79126">create</a>(&amp;stat2), &amp;stat); </div>
<div class="line">    M_CHECK( stat );</div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#a9e68a8b4af016b37f6567cfa6d68e551">setKeyable</a>( <span class="keyword">false</span>); </div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#a98bb3089ec3b7442383da68a5ef424c7">setWritable</a>( <span class="keyword">false</span>); </div>
<div class="line">    typedAttr.<a class="code" href="./class_m_fn_attribute.html#a8d2be80de133a200a455bf9e2ac1b709">setStorable</a>( <span class="keyword">false</span>); </div>
<div class="line">    stat = addAttribute(sDiagnostics); </div>
<div class="line">    M_CHECK( stat );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// </span></div>
<div class="line"> <span class="comment">// Specify our dependencies</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    attributeAffects( sShader, sTechniques);</div>
<div class="line">    attributeAffects( sShader, sTechnique);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">hlslShader::copyInternalData( <a name="_a86"></a><a class="code" href="./class_m_px_node.html">MPxNode</a>* pSrc )</div>
<div class="line">{</div>
<div class="line"> <span class="keyword">const</span> hlslShader&amp; src = *(hlslShader*)pSrc;</div>
<div class="line">    fTechnique = src.fTechnique;</div>
<div class="line">    fTechniqueHasBlending = src.fTechniqueHasBlending;</div>
<div class="line">    fShader = src.fShader;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// It's too early to reload the shader. Maya has not completely duplicate</span></div>
<div class="line"> <span class="comment">// the internal data structures. We delay the reload a little.</span></div>
<div class="line">    fPostDuplicateCallbackId = <a name="a87"></a><a class="code" href="./class_m_model_message.html#a74cd7260902a3dd9aa27950385408735">MModelMessage::addAfterDuplicateCallback</a>(postDuplicateCB, <span class="keyword">this</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> hlslShader::setInternalValueInContext( <span class="keyword">const</span> <a name="_a88"></a><a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug,</div>
<div class="line"> <span class="keyword">const</span> <a name="_a89"></a><a class="code" href="./class_m_data_handle.html">MDataHandle</a>&amp; handle,</div>
<div class="line"> <a name="_a90"></a><a class="code" href="./class_m_d_g_context.html">MDGContext</a>&amp; context)</div>
<div class="line">{</div>
<div class="line"> <span class="keywordtype">bool</span> retVal = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> (plug == sShader)</div>
<div class="line">        {</div>
<div class="line">            setShader( handle.<a name="a91"></a><a class="code" href="./class_m_data_handle.html#a858b071eda071f265c130e30d0b98622">asString</a>());</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> (plug == sTechnique)</div>
<div class="line">        {</div>
<div class="line">            setTechnique( handle.<a class="code" href="./class_m_data_handle.html#a858b071eda071f265c130e30d0b98622">asString</a>());</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            retVal = <a name="a92"></a><a class="code" href="./class_m_px_node.html#a1274aa85381b268a398ae8929b8f4ad1">MPxHardwareShader::setInternalValue</a>(plug, handle);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">catch</span> ( ... )</div>
<div class="line">    {</div>
<div class="line">        reportInternalError( __FILE__, __LINE__ );</div>
<div class="line">        retVal = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> retVal;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* virtual */</span></div>
<div class="line"><span class="keywordtype">bool</span> hlslShader::getInternalValueInContext( <span class="keyword">const</span> <a class="code" href="./class_m_plug.html">MPlug</a>&amp; plug,</div>
<div class="line"> <a class="code" href="./class_m_data_handle.html">MDataHandle</a>&amp; handle,</div>
<div class="line"> <a class="code" href="./class_m_d_g_context.html">MDGContext</a>&amp;)</div>
<div class="line">{</div>
<div class="line"> <span class="keywordtype">bool</span> retVal = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> (plug == sShader)</div>
<div class="line">        {</div>
<div class="line">            handle.<a name="a93"></a><a class="code" href="./class_m_data_handle.html#a2a75482f517f405a641c0eee0bd995ac">set</a>( fShader);</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> (plug == sTechnique)</div>
<div class="line">        {</div>
<div class="line">            handle.<a class="code" href="./class_m_data_handle.html#a2a75482f517f405a641c0eee0bd995ac">set</a>( fTechnique);</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> (plug == sTechniques)</div>
<div class="line">        {</div>
<div class="line">            handle.<a class="code" href="./class_m_data_handle.html#a2a75482f517f405a641c0eee0bd995ac">set</a>( <a class="code" href="./class_m_fn_string_array_data.html">MFnStringArrayData</a>().create( fTechniques));</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            retVal = <a name="a94"></a><a class="code" href="./class_m_px_node.html#a4d71aa2b223bea98e4997d86992933a7">MPxHardwareShader::getInternalValue</a>(plug, handle);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">catch</span> ( ... )</div>
<div class="line">    {</div>
<div class="line">        reportInternalError( __FILE__, __LINE__ );</div>
<div class="line">        retVal = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> retVal;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Override geometry rendering</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> hlslShader::render( <a class="code" href="./class_m_geometry_list.html">MGeometryList</a>&amp; iter)</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_d3_d9_renderer.html">MD3D9Renderer</a> *pRenderer = <a class="code" href="./class_m_d3_d9_renderer.html#a7e20874dc16aef527b927346672fdbfa">MD3D9Renderer::theRenderer</a>();</div>
<div class="line"> <span class="keywordflow">if</span> (pRenderer == NULL) </div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// If there isn't a render, we can't render anything</span></div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MStatus::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    IDirect3DDevice9* d3dDevice = pRenderer-&gt;getD3D9Device();   </div>
<div class="line"> <span class="keywordflow">if</span> ( NULL == d3dDevice ) </div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// If there isn't a valid device, we can't render anything</span></div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MStatus::kFailure</a>;   </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (fDeviceManager.deviceState() == hlslDeviceManager::kReset)</div>
<div class="line">    {</div>
<div class="line">        fDeviceManager.resetShader();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// We have a device, now do we have a valid effect, or should we render </span></div>
<div class="line"> <span class="comment">// some stand-in geometry?</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    HLSLStateManager::sInstance.fD3DDevice = d3dDevice;</div>
<div class="line"> <span class="keywordflow">if</span>( fD3DEffect &amp;&amp; fD3DVertexDeclaration)</div>
<div class="line">    {</div>
<div class="line">        UINT numPasses = 0;</div>
<div class="line"></div>
<div class="line">        fD3DEffect-&gt;Begin( &amp;numPasses, 0); <span class="comment">// The 0 tells DX to save and restore all state modified by the effect ... hmmmm perf hit?</span></div>
<div class="line"> <span class="keywordtype">bool</span> firstShape = <span class="keyword">true</span>;</div>
<div class="line"> <span class="keywordflow">for</span>( ; !iter.<a name="a95"></a><a class="code" href="./class_m_geometry_list.html#add4bf50abae421d88b5549de6c11fc75">isDone</a>(); iter.<a name="a96"></a><a class="code" href="./class_m_geometry_list.html#a041249f802c5bf4c2deae666610e03c4">next</a>())</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Setup our shape dependent parameters</span></div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> u = fUniformParameters.length(); u--; )</div>
<div class="line">            {</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> uniform = fUniformParameters.getElement( u);</div>
<div class="line"> <span class="keywordflow">if</span>( uniform.<a name="a97"></a><a class="code" href="./class_m_uniform_parameter.html#a9d4d257e5bb7e85eb9fdeca499dc9361">hasChanged</a>( iter))</div>
<div class="line">                {</div>
<div class="line">                    D3DXHANDLE d3dParameter = (D3DXHANDLE)uniform.<a name="a98"></a><a class="code" href="./class_m_uniform_parameter.html#aabc6dea98709831626d182f1bce0c69a">userData</a>();</div>
<div class="line"> <span class="keywordflow">if</span>( d3dParameter)</div>
<div class="line">                    {</div>
<div class="line"> <span class="keywordflow">switch</span>( uniform.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>())</div>
<div class="line">                        {</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6ae59341821f9cdc0608d1f8775fb3eb7a">MUniformParameter::kTypeFloat</a>: </div>
<div class="line">                                {</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">float</span>* data = uniform.<a name="a99"></a><a class="code" href="./class_m_uniform_parameter.html#adeb3f26c0cb456d9028fb6e6d71cc51a">getAsFloatArray</a>( iter);</div>
<div class="line"> <span class="keywordflow">if</span>( data) fD3DEffect-&gt;SetValue( d3dParameter, data, uniform.<a name="a100"></a><a class="code" href="./class_m_uniform_parameter.html#ac7fba35931cc9a520837b0a752352e16">numElements</a>() * <span class="keyword">sizeof</span>( float));</div>
<div class="line">                                }</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6ab6e6fe667e0718b58ca5f6ac419c7cf7">MUniformParameter::kTypeInt</a>: </div>
<div class="line">                                fD3DEffect-&gt;SetInt( d3dParameter, uniform.<a name="a101"></a><a class="code" href="./class_m_uniform_parameter.html#ac4394d7d6b3a9352b2aa83b77b3cac8e">getAsInt</a>( iter));</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a52b0938c028df56b62bc9e9080475e7f">MUniformParameter::kTypeBool</a>: </div>
<div class="line">                                fD3DEffect-&gt;SetBool( d3dParameter, uniform.<a name="a102"></a><a class="code" href="./class_m_uniform_parameter.html#a528943f9cbfb601fc64e343a3e7072ec">getAsBool</a>( iter));</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a00d1e209478ab74cbadfbe8435e32e81">MUniformParameter::kTypeString</a>: </div>
<div class="line">                                fD3DEffect-&gt;SetString( d3dParameter, uniform.<a name="a103"></a><a class="code" href="./class_m_uniform_parameter.html#ae9f61935fee5d55a0df8bd4b2013a679">getAsString</a>( iter).<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>());</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">default</span>:</div>
<div class="line"> <span class="keywordflow">if</span>( uniform.<a name="a104"></a><a class="code" href="./class_m_uniform_parameter.html#a37357b066d4c628b1fae2f1ee08b2b12">isATexture</a>())</div>
<div class="line">                                    HLSLTextureManager::sInstance.bind( uniform.<a class="code" href="./class_m_uniform_parameter.html#ae9f61935fee5d55a0df8bd4b2013a679">getAsString</a>( iter).<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), uniform, fD3DEffect, d3dParameter);</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <a name="_a105"></a><a class="code" href="./class_m_geometry.html">MGeometry</a>&amp; geometry = iter.<a name="a106"></a><a class="code" href="./class_m_geometry_list.html#a80965170c5e6cc6da53676b54de22630">geometry</a>( <a name="a107"></a><a class="code" href="./class_m_geometry_list.html#a385c44f6fb256e5716a2302a5b940388a634ee767a8e90ff4d56e140459cca31f">MGeometryList::kNone</a>);</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">void</span>* data;</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elements, count;</div>
<div class="line"> <span class="keywordflow">if</span>( fVertexStructure.numElements() &amp;&amp; fVertexStructure.getBuffer( geometry, data, elements, count) == <a name="a108"></a><a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>)</div>
<div class="line">            {</div>
<div class="line"> <a name="_a109"></a><a class="code" href="./class_m_geometry_primitive.html">MGeometryPrimitive</a> primitives = geometry.<a name="a110"></a><a class="code" href="./class_m_geometry.html#ad0b84023dd720ca2b0b8b05893dab358">primitiveArray</a>( 0);</div>
<div class="line">                HLSLStateManager::sInstance.shapeCullMode( iter.<a name="a111"></a><a class="code" href="./class_m_geometry_list.html#abadce204d1b2b8fab91dcad7581a359d">cullMode</a>());</div>
<div class="line"> <span class="keywordflow">for</span>( UINT p = 0; p &lt; numPasses; p++)</div>
<div class="line">                {</div>
<div class="line"> <span class="keywordflow">if</span>( !fD3DVertexDeclaration[ p]) <span class="keywordflow">continue</span>;</div>
<div class="line"> <span class="keywordflow">if</span>( numPasses &gt; 1 || firstShape) </div>
<div class="line">                        HLSLStateManager::sInstance.BeginPass( fD3DEffect, p);</div>
<div class="line"> <span class="keywordflow">else</span> </div>
<div class="line">                        fD3DEffect-&gt;CommitChanges(); <span class="comment">// Make sure any shape-dependent uniforms get sent down the to effect when rendering a single pass effect!</span></div>
<div class="line">                    firstShape = <span class="keyword">false</span>;</div>
<div class="line">                    d3dDevice-&gt;SetVertexDeclaration( fD3DVertexDeclaration[ p]); </div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef MAX_SEGMENTED_BATCH_SIZE</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numPrimitives = primitives.<a name="a112"></a><a class="code" href="./class_m_geometry_primitive.html#ac9580a2ec3ad9690d0fb0ea0b3179fec">elementCount</a>() / 3;</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> batchSize = numPrimitives / (numPrimitives / MAX_SEGMENTED_BATCH_SIZE + 1) + 1;</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> start = 0; start &lt; numPrimitives; )</div>
<div class="line">                    {</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> end = start + batchSize;</div>
<div class="line"> <span class="keywordflow">if</span>( end &gt; numPrimitives) end = numPrimitives;</div>
<div class="line">                        d3dDevice-&gt;DrawIndexedPrimitiveUP( D3DPT_TRIANGLELIST, 0, count, end - start, ((<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)primitives.<a name="a113"></a><a class="code" href="./class_m_geometry_primitive.html#ad3b74abc0bab69f337c70783e73f5bef">data</a>()) + (start * 3), D3DFMT_INDEX32, data, elements);</div>
<div class="line">                        start = end;</div>
<div class="line">                    }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">                    d3dDevice-&gt;DrawIndexedPrimitiveUP( D3DPT_TRIANGLELIST, 0, count, primitives.<a class="code" href="./class_m_geometry_primitive.html#ac9580a2ec3ad9690d0fb0ea0b3179fec">elementCount</a>() / 3, primitives.<a class="code" href="./class_m_geometry_primitive.html#ad3b74abc0bab69f337c70783e73f5bef">data</a>(), D3DFMT_INDEX32, data, elements);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> <span class="keywordflow">if</span>( numPasses &gt; 1) fD3DEffect-&gt;EndPass();</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">if</span>( numPasses == 1) fD3DEffect-&gt;EndPass();</div>
<div class="line">        fD3DEffect-&gt;End();</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Hokey DX draw</span></div>
<div class="line"> <span class="comment">// There is no lighting so the only color will be the emissive color</span></div>
<div class="line">        D3DMATERIAL9 Material;</div>
<div class="line">        Material.Emissive.r = 0.0f; </div>
<div class="line">        Material.Emissive.g = 0.6f; </div>
<div class="line">        Material.Emissive.b = 0.0f; </div>
<div class="line">        Material.Emissive.a = 1.0f; </div>
<div class="line"></div>
<div class="line">        d3dDevice-&gt;SetMaterial( &amp;Material);</div>
<div class="line">        d3dDevice-&gt;LightEnable( 0, <span class="keyword">false</span>);</div>
<div class="line">        d3dDevice-&gt;LightEnable( 1, <span class="keyword">false</span>);</div>
<div class="line">        d3dDevice-&gt;SetFVF( D3DFVF_XYZ );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span>( ; !iter.<a class="code" href="./class_m_geometry_list.html#add4bf50abae421d88b5549de6c11fc75">isDone</a>(); iter.<a class="code" href="./class_m_geometry_list.html#a041249f802c5bf4c2deae666610e03c4">next</a>())</div>
<div class="line">        {</div>
<div class="line"> <a class="code" href="./class_m_geometry.html">MGeometry</a>&amp; geometry = iter.<a class="code" href="./class_m_geometry_list.html#a80965170c5e6cc6da53676b54de22630">geometry</a>( <a class="code" href="./class_m_geometry_list.html#a385c44f6fb256e5716a2302a5b940388a634ee767a8e90ff4d56e140459cca31f">MGeometryList::kNone</a> );</div>
<div class="line"> <span class="keyword">const</span> <a name="_a114"></a><a class="code" href="./class_m_geometry_data.html">MGeometryData</a> position = geometry.<a name="a115"></a><a class="code" href="./class_m_geometry.html#a117087d6021defde4f3202650c48f3ce">position</a>();</div>
<div class="line"> <span class="keywordflow">if</span>( position.<a name="a116"></a><a class="code" href="./class_m_geometry_data.html#ac73113f892730ec6fce5da7e3273c9cd">data</a>())</div>
<div class="line">            {</div>
<div class="line"> <span class="comment">// set up the matrices as this aren't picked up automatically as may be</span></div>
<div class="line"> <span class="comment">// different in the case of swatch rendering from the current directX state.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keyword">const</span> <a name="_a117"></a><a class="code" href="./class_m_matrix.html">MMatrix</a>&amp; mtm = iter.<a name="a118"></a><a class="code" href="./class_m_geometry_list.html#acd8c4aab0285c0e0077b1c12d8cfda9a">objectToWorldMatrix</a>();</div>
<div class="line">                D3DXMATRIXA16 tm( (<span class="keywordtype">float</span>)mtm.<a name="a119"></a><a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][0], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][1], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][2], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][0], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][1], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][2], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][0], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][1], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][2], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][0], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][1], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][2], (<span class="keywordtype">float</span>)mtm.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][3]);</div>
<div class="line"> </div>
<div class="line">                d3dDevice-&gt;SetTransform( D3DTS_WORLD, &amp;tm);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Setup the camera for drawing new stuff</span></div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_matrix.html">MMatrix</a>&amp; mproject = iter.<a name="a120"></a><a class="code" href="./class_m_geometry_list.html#ab1858a6f233c72075f40621f70f137b5">projectionMatrix</a>();</div>
<div class="line">                D3DXMATRIXA16 projection( (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][0], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][1], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][2], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][0], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][1], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][2], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][0], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][1], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][2], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][0], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][1], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][2], (<span class="keywordtype">float</span>)mproject.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][3]);</div>
<div class="line">                d3dDevice-&gt;SetTransform( D3DTS_PROJECTION, &amp;projection );</div>
<div class="line"></div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_matrix.html">MMatrix</a>&amp; mview = iter.<a name="a121"></a><a class="code" href="./class_m_geometry_list.html#a53c16ec1239d17f326fb7216ba8b91d8">viewMatrix</a>();</div>
<div class="line">                D3DXMATRIXA16 view( (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][0], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][1], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][2], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[0][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][0], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][1], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][2], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[1][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][0], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][1], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][2], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[2][3], </div>
<div class="line">                                  (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][0], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][1], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][2], (<span class="keywordtype">float</span>)mview.<a class="code" href="./class_m_matrix.html#a527b102f4eb0951cf4f391f828d3ca34">matrix</a>[3][3]);</div>
<div class="line">                d3dDevice-&gt;SetTransform( D3DTS_VIEW, &amp;view );</div>
<div class="line"></div>
<div class="line">                HLSLStateManager::sInstance.shapeCullMode( iter.<a class="code" href="./class_m_geometry_list.html#abadce204d1b2b8fab91dcad7581a359d">cullMode</a>(), <span class="keyword">true</span>);</div>
<div class="line"> <a class="code" href="./class_m_geometry_primitive.html">MGeometryPrimitive</a> primitives = geometry.<a class="code" href="./class_m_geometry.html#ad0b84023dd720ca2b0b8b05893dab358">primitiveArray</a>( 0);</div>
<div class="line">                d3dDevice-&gt;DrawIndexedPrimitiveUP( D3DPT_TRIANGLELIST, 0, position.<a name="a122"></a><a class="code" href="./class_m_geometry_data.html#ac9580a2ec3ad9690d0fb0ea0b3179fec">elementCount</a>(), primitives.<a class="code" href="./class_m_geometry_primitive.html#ac9580a2ec3ad9690d0fb0ea0b3179fec">elementCount</a>() / 3, primitives.<a class="code" href="./class_m_geometry_primitive.html#ad3b74abc0bab69f337c70783e73f5bef">data</a>(), D3DFMT_INDEX32, position.<a class="code" href="./class_m_geometry_data.html#ac73113f892730ec6fce5da7e3273c9cd">data</a>(), 3 * <span class="keyword">sizeof</span>( float));</div>
<div class="line">            } </div>
<div class="line"> <span class="keywordflow">else</span> </div>
<div class="line">            {</div>
<div class="line"> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MStatus::kFailure</a>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* virtual */</span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hlslShader::transparencyOptions()</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span> (fTechniqueHasBlending)</div>
<div class="line"> <span class="keywordflow">return</span> ( kIsTransparent | kNoTransparencyFrontBackCull | kNoTransparencyPolygonSort );</div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Query the renderers supported by this shader</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="./class_m_render_profile.html">MRenderProfile</a>&amp; hlslShader::profile() { <span class="keywordflow">return</span> sProfile; }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> hlslShader::setupUniform( D3DXHANDLE d3dParameter, <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; prefix)</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span>( d3dParameter)</div>
<div class="line">    {</div>
<div class="line">        D3DXPARAMETER_DESC parameterDesc;</div>
<div class="line">        fD3DEffect-&gt;GetParameterDesc( d3dParameter, &amp;parameterDesc);</div>
<div class="line"> <span class="keywordflow">if</span>( parameterDesc.Class == D3DXPC_STRUCT)</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p = 0; p &lt; parameterDesc.StructMembers; p++)</div>
<div class="line">            {</div>
<div class="line">                setupUniform( fD3DEffect-&gt;GetParameter( d3dParameter, p), prefix + <a class="code" href="./class_m_string.html">MString</a>( parameterDesc.Name) + <span class="stringliteral">"."</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Is this a special parameter?</span></div>
<div class="line"> <span class="keywordflow">if</span>( parameterDesc.Semantic &amp;&amp; !_stricmp( parameterDesc.Semantic, <span class="stringliteral">"SasGlobal"</span>))</div>
<div class="line">            {</div>
<div class="line">                LPCSTR sasDescription;</div>
<div class="line"> <span class="keywordflow">if</span>( GetAnnotation( d3dParameter, <span class="stringliteral">"SasEffectDescription"</span>, sasDescription) &amp;&amp; *sasDescription)</div>
<div class="line">                    fDescription += sasDescription;</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( parameterDesc.Name &amp;&amp; !_stricmp( parameterDesc.Name, <span class="stringliteral">"description"</span>) &amp;&amp; parameterDesc.Type == D3DXPT_STRING)</div>
<div class="line">            {</div>
<div class="line">                LPCSTR Value; </div>
<div class="line"> <span class="keywordflow">if</span>( fD3DEffect-&gt;GetString( d3dParameter, &amp;Value) == D3D_OK) </div>
<div class="line">                    fDescription += Value;</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6">MUniformParameter::DataType</a> type = ConvertType( d3dParameter, parameterDesc);</div>
<div class="line"> <span class="keywordflow">if</span>( type != <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6aa3016cbceb721f8a4e567dc4d54d6dc6">MUniformParameter::kTypeUnknown</a>)</div>
<div class="line">            {</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html#ae2d1a7ca98deaf6f6acd790af2e234ef">MUniformParameter::DataSemantic</a> semantic = ConvertSemantic( d3dParameter, parameterDesc);</div>
<div class="line"> <span class="keywordtype">int</span> rows = parameterDesc.Rows;</div>
<div class="line"> <span class="keywordtype">int</span> columns = parameterDesc.Columns;</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> uiName = prefix + parameterDesc.Name;</div>
<div class="line"> <span class="comment">//Try replacing name by the uiname if it is specified</span></div>
<div class="line">                LPCSTR uiNameValue = NULL ;</div>
<div class="line"> <span class="keywordtype">bool</span> hasUIName = GetAnnotation(d3dParameter, <span class="stringliteral">"UIName"</span>, uiNameValue) &amp;&amp; uiNameValue;</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> uniform( uiName, type, semantic, rows, columns, (<span class="keywordtype">void</span>*)d3dParameter);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If shader author has provided a UIName, then</span></div>
<div class="line"> <span class="comment">// tell Maya to use the UIName for the attribute's 'Nice Name':</span></div>
<div class="line"> <span class="keywordflow">if</span> (hasUIName)</div>
<div class="line">                    uniform.<a name="a123"></a><a class="code" href="./class_m_uniform_parameter.html#ae6a07a795a6f2ad194e14c6735f44450">setUINiceName</a>( uiNameValue );</div>
<div class="line"></div>
<div class="line">                updateUIVisibilityFromAnnotation( d3dParameter, uniform );</div>
<div class="line">                updateRangeFromAnnotation( d3dParameter, uniform );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">switch</span>( type)</div>
<div class="line">                {</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6ae59341821f9cdc0608d1f8775fb3eb7a">MUniformParameter::kTypeFloat</a>: </div>
<div class="line">                        { </div>
<div class="line"> <span class="keywordtype">int</span> length = rows * columns;</div>
<div class="line">                            FLOAT* Value = <span class="keyword">new</span> FLOAT[ length];</div>
<div class="line"> <span class="keywordflow">if</span>( Value)</div>
<div class="line">                            {</div>
<div class="line"> <span class="keywordflow">if</span>( fD3DEffect-&gt;GetFloatArray( d3dParameter, Value, length) == D3D_OK) </div>
<div class="line">                                    uniform.<a name="a124"></a><a class="code" href="./class_m_uniform_parameter.html#a71c021490db45149a9bb635bfe04cddd">setAsFloatArray</a>( Value, length); </div>
<div class="line"> <span class="keyword">delete</span> [] Value;</div>
<div class="line">                            }</div>
<div class="line"> <span class="keywordflow">break</span>; </div>
<div class="line">                        }</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a00d1e209478ab74cbadfbe8435e32e81">MUniformParameter::kTypeString</a>: { LPCSTR Value; <span class="keywordflow">if</span>( fD3DEffect-&gt;GetString( d3dParameter, &amp;Value) == D3D_OK) uniform.<a name="a125"></a><a class="code" href="./class_m_uniform_parameter.html#a702414289a74bf62b6ef182c64378292">setAsString</a>( <a class="code" href="./class_m_string.html">MString</a>( Value)); <span class="keywordflow">break</span>; }</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a52b0938c028df56b62bc9e9080475e7f">MUniformParameter::kTypeBool</a>: { BOOL Value; <span class="keywordflow">if</span>( fD3DEffect-&gt;GetBool( d3dParameter, &amp;Value) == D3D_OK) uniform.<a name="a126"></a><a class="code" href="./class_m_uniform_parameter.html#adce6ab6521852e06df1e9ac4a5cda02d">setAsBool</a>( Value ? <span class="keyword">true</span> : <span class="keyword">false</span>); <span class="keywordflow">break</span>; }</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6ab6e6fe667e0718b58ca5f6ac419c7cf7">MUniformParameter::kTypeInt</a>: { INT Value; <span class="keywordflow">if</span>( fD3DEffect-&gt;GetInt( d3dParameter, &amp;Value) == D3D_OK) uniform.<a name="a127"></a><a class="code" href="./class_m_uniform_parameter.html#ad71d705cfb54ef95d43a83d555115f43">setAsInt</a>( Value); <span class="keywordflow">break</span>; }</div>
<div class="line"> <span class="keywordflow">default</span>:</div>
<div class="line"> <span class="keywordflow">if</span>( type &gt;= <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a9eafb8c812a708ea65bcbc4cab43bb8a">MUniformParameter::kType1DTexture</a> &amp;&amp; type &lt;= <a name="a128"></a><a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a098a1abcb5c2e8a76899d650a6425562">MUniformParameter::kTypeEnvTexture</a>)</div>
<div class="line">                        {</div>
<div class="line">                            LPCSTR resource;</div>
<div class="line"> <span class="keywordflow">if</span>( GetAnnotation( d3dParameter, <span class="stringliteral">"ResourceName"</span>, resource) &amp;&amp; *resource)</div>
<div class="line">                                uniform.<a class="code" href="./class_m_uniform_parameter.html#a702414289a74bf62b6ef182c64378292">setAsString</a>( findResource( <a class="code" href="./class_m_string.html">MString</a>( resource), fShader));</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>( GetAnnotation( d3dParameter, <span class="stringliteral">"SasResourceAddress"</span>, resource) &amp;&amp; *resource)</div>
<div class="line">                                uniform.<a class="code" href="./class_m_uniform_parameter.html#a702414289a74bf62b6ef182c64378292">setAsString</a>( findResource( <a class="code" href="./class_m_string.html">MString</a>( resource), fShader));</div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line">                fUniformParameters.append( uniform);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> hlslShader::updateUIVisibilityFromAnnotation( D3DXHANDLE d3dParameter, <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a>&amp; uniform )</div>
<div class="line">{</div>
<div class="line">    BOOL visible = <span class="keyword">true</span>;</div>
<div class="line"> <span class="keywordflow">if</span>( GetBOOLAnnotation( d3dParameter, <span class="stringliteral">"SasUiVisible"</span>, visible) )</div>
<div class="line">    {</div>
<div class="line">        uniform.<a name="a129"></a><a class="code" href="./class_m_uniform_parameter.html#ab5ef06b49e994b093b442788b96167d5">setUIHidden</a>(!visible);</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        LPCSTR uiTypeValue = NULL;</div>
<div class="line"> <span class="keywordtype">bool</span>  foundUIType = GetAnnotation( d3dParameter, <span class="stringliteral">"UIType"</span>, uiTypeValue);</div>
<div class="line"> <span class="keywordflow">if</span> (foundUIType &amp;&amp; !_stricmp(uiTypeValue, <span class="stringliteral">"None"</span>))</div>
<div class="line">        {</div>
<div class="line">            uniform.<a class="code" href="./class_m_uniform_parameter.html#ab5ef06b49e994b093b442788b96167d5">setUIHidden</a>(<span class="keyword">true</span>);</div>
<div class="line">        }</div>
<div class="line"> <span class="comment">// As per NVidia SAS docs v1.0.3:</span></div>
<div class="line">        LPCSTR uiWidgetValue = NULL;</div>
<div class="line">        foundUIType = GetAnnotation( d3dParameter, <span class="stringliteral">"UIWidget"</span>, uiWidgetValue);</div>
<div class="line"> <span class="keywordflow">if</span> (foundUIType &amp;&amp; !_stricmp(uiWidgetValue, <span class="stringliteral">"None"</span>))</div>
<div class="line">        {</div>
<div class="line">            uniform.<a class="code" href="./class_m_uniform_parameter.html#ab5ef06b49e994b093b442788b96167d5">setUIHidden</a>(<span class="keyword">true</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> hlslShader::updateRangeFromAnnotation( D3DXHANDLE d3dParameter, <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a>&amp; uniform)</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">switch</span>(uniform.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>())</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6ae59341821f9cdc0608d1f8775fb3eb7a">MUniformParameter::kTypeFloat</a>:</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordtype">float</span> uiMinFloat = NULL;</div>
<div class="line"> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"SasUiMin"</span>,uiMinFloat))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMin = uiMinFloat;</div>
<div class="line">                uniform.<a name="a130"></a><a class="code" href="./class_m_uniform_parameter.html#a85e791f9ffcc0664e26d39249e9f3576">setRangeMin</a>(uiMin);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"UIMin"</span>,uiMinFloat))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMin = uiMinFloat;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#a85e791f9ffcc0664e26d39249e9f3576">setRangeMin</a>(uiMin);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"uimin"</span>,uiMinFloat))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMin = uiMinFloat;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#a85e791f9ffcc0664e26d39249e9f3576">setRangeMin</a>(uiMin);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">float</span> uiMaxFloat = NULL;</div>
<div class="line"> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"SasUiMax"</span>,uiMaxFloat))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMax = uiMaxFloat;</div>
<div class="line">                uniform.<a name="a131"></a><a class="code" href="./class_m_uniform_parameter.html#aa5e8b1737ecebe3761c33ba56454849c">setRangeMax</a>(uiMax);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"UIMax"</span>,uiMaxFloat))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMax = uiMaxFloat;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#aa5e8b1737ecebe3761c33ba56454849c">setRangeMax</a>(uiMax);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"uimax"</span>,uiMaxFloat))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMax = uiMaxFloat;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#aa5e8b1737ecebe3761c33ba56454849c">setRangeMax</a>(uiMax);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6ab6e6fe667e0718b58ca5f6ac419c7cf7">MUniformParameter::kTypeInt</a>:</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordtype">int</span> uiMinInt = NULL;</div>
<div class="line"> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"SasUiMin"</span>,uiMinInt))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMin = uiMinInt;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#a85e791f9ffcc0664e26d39249e9f3576">setRangeMin</a>(uiMin);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"UIMin"</span>,uiMinInt))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMin = uiMinInt;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#a85e791f9ffcc0664e26d39249e9f3576">setRangeMin</a>(uiMin);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"uimin"</span>,uiMinInt))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMin = uiMinInt;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#a85e791f9ffcc0664e26d39249e9f3576">setRangeMin</a>(uiMin);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> uiMaxInt = NULL;</div>
<div class="line"> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"SasUiMax"</span>,uiMaxInt))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMax = uiMaxInt;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#aa5e8b1737ecebe3761c33ba56454849c">setRangeMax</a>(uiMax);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"UIMax"</span>,uiMaxInt))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMax = uiMaxInt;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#aa5e8b1737ecebe3761c33ba56454849c">setRangeMax</a>(uiMax);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span>(GetAnnotation(d3dParameter, <span class="stringliteral">"uimax"</span>,uiMaxInt))</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordtype">double</span> uiMax = uiMaxInt;</div>
<div class="line">                uniform.<a class="code" href="./class_m_uniform_parameter.html#aa5e8b1737ecebe3761c33ba56454849c">setRangeMax</a>(uiMax);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">default</span>:</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">    };</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> hlslShader::postDuplicateCB(<span class="keywordtype">void</span>* data)</div>
<div class="line">{</div>
<div class="line">    hlslShader* shader = (hlslShader*)data;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Remove the callback.</span></div>
<div class="line"> <a class="code" href="./class_m_message.html#a50fe995add3ce133b8b56551abb4ed09">MMessage::removeCallback</a>(shader-&gt;fPostDuplicateCallbackId);</div>
<div class="line">    shader-&gt;fPostDuplicateCallbackId = NULL;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Reload the shader file.</span></div>
<div class="line">    shader-&gt;setShader(shader-&gt;fShader);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Set the shader we're using</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> hlslShader::setShader( <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; shader)</div>
<div class="line">{</div>
<div class="line">    fDiagnostics = <span class="stringliteral">""</span>;</div>
<div class="line">    fDescription = <span class="stringliteral">""</span>;</div>
<div class="line">    fShader = shader;</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_d3_d9_renderer.html">MD3D9Renderer</a> *pRenderer = <a class="code" href="./class_m_d3_d9_renderer.html#a7e20874dc16aef527b927346672fdbfa">MD3D9Renderer::theRenderer</a>();</div>
<div class="line"> <span class="keywordflow">if</span> (pRenderer != NULL) {</div>
<div class="line">        IDirect3DDevice9* pDevice = pRenderer-&gt;getD3D9Device();</div>
<div class="line"> <span class="keywordflow">if</span>( pDevice )</div>
<div class="line">        {</div>
<div class="line"></div>
<div class="line">            release();</div>
<div class="line">            fTechniques.setLength( 0);</div>
<div class="line">            LPD3DXBUFFER errors = NULL;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Make sure the shader's directory is current, as the compiler will try and resolve</span></div>
<div class="line"> <span class="comment">// everything relative to that</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a name="_a132"></a><a class="code" href="./class_m_file_object.html">MFileObject</a> fileObject;</div>
<div class="line"> <span class="comment">// we remove "/" or "\\" at the beginning of variable shader </span></div>
<div class="line"> <span class="comment">// if it is relative path</span></div>
<div class="line"> <span class="keyword">struct </span>stat statBuf;</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> shaderSimpleName;</div>
<div class="line"> <span class="keywordflow">if</span> (stat(shader.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), &amp;statBuf) == -1)</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordflow">if</span>(shader.<a name="a133"></a><a class="code" href="./class_m_string.html#a7487f32861d955d3ac0d8722cc5797b2">index</a>(<span class="charliteral">'/'</span>) == 0 || shader.<a class="code" href="./class_m_string.html#a7487f32861d955d3ac0d8722cc5797b2">index</a>(<span class="charliteral">'\\'</span>) == 0)</div>
<div class="line">                    shaderSimpleName = shader.<a name="a134"></a><a class="code" href="./class_m_string.html#a41ba57372bc1082383b4f1929a8030fa">substring</a>(1, shader.<a class="code" href="./class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() - 1);</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                    shaderSimpleName = shader;</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                shaderSimpleName = shader;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            fileObject.<a name="a135"></a><a class="code" href="./class_m_file_object.html#a4b3d5deec3dc9475f712c8e0f2f4d9a2">setResolveMethod</a>( <a name="a136"></a><a class="code" href="./class_m_file_object.html#af71e719034e8e9a4c69adcc174ca9049ac1ce1604eaae6e61df873510a9254fb3">MFileObject::kInputFile</a>);</div>
<div class="line">            fileObject.<a name="a137"></a><a class="code" href="./class_m_file_object.html#ac14aefbfe38c2711256eb8c14a3194ee">setRawFullName</a>( shaderSimpleName);</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> resolvedPath ;</div>
<div class="line">            resolvedPath = fileObject.<a name="a138"></a><a class="code" href="./class_m_file_object.html#a7a4d2fada6eb436c6e74f1e62212c218">resolvedPath</a>();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// for bug 275673</span></div>
<div class="line"> <span class="comment">// if shader include directory name, for example /shader/...</span></div>
<div class="line"> <span class="comment">// resolvePath will combine the directory, so directory name in variable shader</span></div>
<div class="line"> <span class="comment">// is redundant. We remove directory name in variable shader</span></div>
<div class="line"> <span class="keywordtype">int</span> idx = shaderSimpleName.<a name="a139"></a><a class="code" href="./class_m_string.html#a2f0c58e22c8c209d0ea924de9913993a">rindex</a>(<span class="charliteral">'/'</span>);</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> shaderName;</div>
<div class="line"> <span class="keywordflow">if</span>(idx == -1)</div>
<div class="line">            {</div>
<div class="line">                shaderName = shaderSimpleName;</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                shaderName = shaderSimpleName.<a class="code" href="./class_m_string.html#a41ba57372bc1082383b4f1929a8030fa">substring</a>(idx + 1, shaderSimpleName.length() - 1);</div>
<div class="line">            }</div>
<div class="line">            TCHAR pwd[ MAX_PATH];</div>
<div class="line"> <span class="keywordflow">if</span>( resolvedPath.<a class="code" href="./class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() &gt; 0)</div>
<div class="line">            {</div>
<div class="line">                ::GetCurrentDirectory( MAX_PATH, pwd);</div>
<div class="line">                ::SetCurrentDirectory( resolvedPath.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>());</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Note that for some strange reason, DX9 doesn't support D3DXSHADER_ENABLE_BACKWARDS_COMPATIBILITY,</span></div>
<div class="line"> <span class="comment">// so we try the old DX9 compiler separately. We can remove the second attempt once we move to DX10</span></div>
<div class="line"> <span class="comment">// (which doesn't support the D3DXSHADER_USE_LEGACY_D3DX9_31_DLL  flag)</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"><span class="preprocessor">#ifndef D3DXSHADER_ENABLE_BACKWARDS_COMPATIBILITY</span></div>
<div class="line"><span class="preprocessor">#define D3DXSHADER_ENABLE_BACKWARDS_COMPATIBILITY 0</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> <span class="keywordflow">if</span>( FAILED( D3DXCreateEffectFromFile( pDevice, shaderName.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), NULL, NULL, D3DXSHADER_ENABLE_BACKWARDS_COMPATIBILITY, NULL, &amp;fD3DEffect, &amp;errors)) </div>
<div class="line"><span class="preprocessor">#ifdef D3DXSHADER_USE_LEGACY_D3DX9_31_DLL</span></div>
<div class="line">             &amp;&amp; FAILED( D3DXCreateEffectFromFile( pDevice, shaderName.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), NULL, NULL, D3DXSHADER_USE_LEGACY_D3DX9_31_DLL, NULL, &amp;fD3DEffect, NULL))</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">                )</div>
<div class="line">            {</div>
<div class="line">                fDiagnostics += <span class="stringliteral">"Error trying to create effect "</span> + shader + <span class="stringliteral">":\n\t"</span>;</div>
<div class="line"> <span class="keywordflow">if</span>( errors)</div>
<div class="line">                    fDiagnostics += (<span class="keyword">const</span> <span class="keywordtype">char</span>*)errors-&gt;GetBufferPointer();</div>
<div class="line">                fDiagnostics += <span class="stringliteral">"\n"</span>;</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line"> <span class="keywordflow">if</span>( errors)</div>
<div class="line">                    fDiagnostics += (<span class="keyword">const</span> <span class="keywordtype">char</span>*)errors-&gt;GetBufferPointer();</div>
<div class="line">                fD3DEffect-&gt;SetStateManager( &amp;HLSLStateManager::sInstance);</div>
<div class="line">                fD3DEffect-&gt;GetDesc( &amp;fD3DEffectDesc);</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> t = 0; t &lt; fD3DEffectDesc.Techniques; t++)</div>
<div class="line">                {</div>
<div class="line">                    D3DXHANDLE technique = fD3DEffect-&gt;GetTechnique( t);</div>
<div class="line"> <span class="keywordflow">if</span>( technique)</div>
<div class="line">                    {</div>
<div class="line"><span class="preprocessor">#ifdef VALIDATE_TECHNIQUE_LIST</span></div>
<div class="line"> <span class="keywordflow">if</span>( fD3DEffect-&gt;ValidateTechnique( technique))</div>
<div class="line">#endif</div>
<div class="line">                        {</div>
<div class="line">                            D3DXTECHNIQUE_DESC techniqueDesc;</div>
<div class="line">                            fD3DEffect-&gt;GetTechniqueDesc( technique, &amp;techniqueDesc);</div>
<div class="line">                            fTechniques.append( techniqueDesc.Name);</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Restore the previous working directory if we changed it</span></div>
<div class="line"> <span class="keywordflow">if</span>( resolvedPath.<a class="code" href="./class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() &gt; 0)</div>
<div class="line">            {</div>
<div class="line">                ::SetCurrentDirectory( pwd);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Update our uniform parameters</span></div>
<div class="line"> <span class="keywordflow">if</span>( fD3DEffect)</div>
<div class="line">            {</div>
<div class="line">                fUniformParameters.setLength( 0);</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p = 0; p &lt; fD3DEffectDesc.Parameters; p++)</div>
<div class="line">                {</div>
<div class="line">                    setupUniform( fD3DEffect-&gt;GetParameter( NULL, p), <span class="stringliteral">""</span>);</div>
<div class="line">                }</div>
<div class="line">                setUniformParameters( fUniformParameters);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// And re-select our current technique (which triggers a UI change</span></div>
<div class="line"> <span class="comment">// and also handles the case where the current technique doesn't </span></div>
<div class="line"> <span class="comment">// exist in this effect</span></div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a>( thisMObject(), sTechnique).<a name="a140"></a><a class="code" href="./class_m_plug.html#a53cf2b4f13eb9faf2e8f2548ebd8b138">setValue</a>( fTechnique);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Update our shader info attributes</span></div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a> diagnosticsPlug( thisMObject(), sDiagnostics);</div>
<div class="line">    diagnosticsPlug.setValue( fDiagnostics);</div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a> descriptionPlug( thisMObject(), sDescription);</div>
<div class="line">    descriptionPlug.setValue( fDescription);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> hlslShader::passHasTranparency( D3DXHANDLE d3dPass )</div>
<div class="line">{</div>
<div class="line"> <span class="keywordtype">bool</span> hasTransparency = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">//printf("Pass %s has %d annotations\n", passDesc.Name, passDesc.Annotations);</span></div>
<div class="line">    BOOL boolParameter;</div>
<div class="line">    INT intParameter1, intParameter2;</div>
<div class="line">    boolParameter = <span class="keyword">false</span>;</div>
<div class="line">    {</div>
<div class="line">        BOOL getAnnot = GetBOOLAnnotation( d3dPass, <span class="stringliteral">"Zenable"</span>, boolParameter);</div>
<div class="line"> <span class="comment">//printf("Get zenable %d, %d\n", getAnnot, boolParameter);</span></div>
<div class="line">        getAnnot = GetBOOLAnnotation( d3dPass, <span class="stringliteral">"ZWriteEnable"</span>, boolParameter);</div>
<div class="line"> <span class="comment">//printf("Get zwriteenable %d, %d\n", getAnnot, boolParameter);</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    BOOL getAnnot = <span class="keyword">false</span>;</div>
<div class="line">    {</div>
<div class="line">        D3DXHANDLE d3dSemantic = fD3DEffect-&gt;GetAnnotationByName( d3dPass, <span class="stringliteral">"AlphaBlendEnable"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (d3dSemantic)</div>
<div class="line">        {</div>
<div class="line">            fD3DEffect-&gt;GetBool( d3dSemantic, &amp;boolParameter);</div>
<div class="line">            getAnnot = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">//printf("Alpha blend found %d, is enabled %d !\n", getAnnot, boolParameter);</span></div>
<div class="line"> <span class="keywordflow">if</span> (getAnnot &amp;&amp; boolParameter)</div>
<div class="line">    {</div>
<div class="line">        hasTransparency = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            D3DXHANDLE d3dSemantic = fD3DEffect-&gt;GetAnnotationByName( d3dPass, <span class="stringliteral">"SrcBlend"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (d3dSemantic)</div>
<div class="line">                fD3DEffect-&gt;GetInt( d3dSemantic, &amp;intParameter1);</div>
<div class="line">        }</div>
<div class="line">        {</div>
<div class="line">            D3DXHANDLE d3dSemantic = fD3DEffect-&gt;GetAnnotationByName( d3dPass, <span class="stringliteral">"DestBlend"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (d3dSemantic)</div>
<div class="line">                fD3DEffect-&gt;GetInt( d3dSemantic, &amp;intParameter2);</div>
<div class="line">        }</div>
<div class="line">    }               </div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> hasTransparency;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Set the technique we're using</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> hlslShader::setTechnique( <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; technique)</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// We're changing technique, blow away any existing vertex declaration</span></div>
<div class="line">    releaseVertexDeclaration();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Now, if we have an effect update our internal data and parameter list</span></div>
<div class="line"> <span class="comment">// (otherwise just leave the current parameters in place)</span></div>
<div class="line"> <span class="keywordflow">if</span>( fD3DEffect &amp;&amp; fTechniques.length())</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Try and switch to this technique</span></div>
<div class="line">        fD3DTechnique = fD3DEffect-&gt;GetTechniqueByName( technique.<a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>());</div>
<div class="line"><span class="preprocessor">#ifdef VALIDATE_TECHNIQUES</span></div>
<div class="line"> <span class="keywordflow">if</span>( !fD3DTechnique || !fD3DEffect-&gt;ValidateTechnique( fD3DTechnique))</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line"> <span class="keywordflow">if</span>( !fD3DTechnique)</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        {</div>
<div class="line">            fD3DTechnique = fD3DEffect-&gt;GetTechniqueByName( fTechnique.asChar());</div>
<div class="line"><span class="preprocessor">#ifdef VALIDATE_TECHNIQUES</span></div>
<div class="line"> <span class="keywordflow">if</span>( !fD3DTechnique || !fD3DEffect-&gt;ValidateTechnique( fD3DTechnique))</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line"> <span class="keywordflow">if</span>( !fD3DTechnique)</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">            {</div>
<div class="line"><span class="preprocessor">#ifdef VALIDATE_TECHNIQUES</span></div>
<div class="line"> <span class="keywordflow">if</span>( FAILED( fD3DEffect-&gt;FindNextValidTechnique( fD3DTechnique, &amp;fD3DTechnique)))</div>
<div class="line">                {</div>
<div class="line">                    fD3DTechnique = NULL;</div>
<div class="line">                }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">                fD3DTechnique = fD3DEffect-&gt;GetTechnique( 0);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Now suck the name back out</span></div>
<div class="line">        fD3DEffect-&gt;GetTechniqueDesc( fD3DTechnique, &amp;fD3DTechniqueDesc);</div>
<div class="line">        fTechnique = fD3DTechniqueDesc.Name;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Make this the active technique</span></div>
<div class="line">        fD3DEffect-&gt;SetTechnique( fD3DTechnique);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Update our passes and varying parameters</span></div>
<div class="line">        fVertexStructure.removeElements();</div>
<div class="line">        fD3DVertexDeclaration = <span class="keyword">new</span> IDirect3DVertexDeclaration9*[ fD3DTechniqueDesc.Passes];</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> offset = 0;</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p = 0; p &lt; fD3DTechniqueDesc.Passes; p++)</div>
<div class="line">        {</div>
<div class="line">            D3DXHANDLE d3dPass = fD3DEffect-&gt;GetPass( fD3DTechnique, p);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(_BLENDPARSING_READY_)</span></div>
<div class="line"> <span class="keywordflow">if</span> (p == 0)</div>
<div class="line">                fTechniqueHasBlending = passHasTranparency( d3dPass );</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">            D3DXPASS_DESC passDesc;</div>
<div class="line">            fD3DEffect-&gt;GetPassDesc( d3dPass, &amp;passDesc);</div>
<div class="line"></div>
<div class="line">            D3DXSEMANTIC Semantics[ MAXD3DDECLLENGTH];</div>
<div class="line">            D3DVERTEXELEMENT9 VertexElements[ MAXD3DDECLLENGTH + 1];</div>
<div class="line">            UINT NumSemantics = 0;</div>
<div class="line">            D3DXGetShaderInputSemantics( passDesc.pVertexShaderFunction, Semantics, &amp;NumSemantics);</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> s = 0; s &lt; NumSemantics; s++)</div>
<div class="line">            {</div>
<div class="line"> <span class="keyword">const</span> SemanticInfo&amp; Info = gSemanticInfo[ Semantics[ s].Usage];</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> Name = Info.Name; <span class="comment">// Can't get the name through DX so use a semantic based name =(</span></div>
<div class="line"> <span class="keywordflow">if</span>( Info.Type != <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321aa20581584e5f9447cb96afb4f2e10703">MVaryingParameter::kPosition</a> &amp;&amp; Info.Type != <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321a227e8416235cd3b43077ca91504a463f">MVaryingParameter::kNormal</a>)</div>
<div class="line">                    Name += Semantics[ s].UsageIndex;</div>
<div class="line"> <a class="code" href="./class_m_varying_parameter.html">MVaryingParameter</a> varying( Name, <a name="a141"></a><a class="code" href="./class_m_varying_parameter.html#a4ea19e67748f44a8d29cf34474b0a7d3a5686197bafb177bdc82550848416a1ad">MVaryingParameter::kFloat</a>, Info.MinElements, Info.MaxElements, Info.Type, Info.Type == <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321a45b7096916b12a78e94c62bba9d50739">MVaryingParameter::kTexCoord</a> ? <span class="keyword">true</span> : <span class="keyword">false</span>);</div>
<div class="line">                fVertexStructure.addElement( varying);</div>
<div class="line"></div>
<div class="line">                VertexElements[ s].Stream = 0;</div>
<div class="line">                VertexElements[ s].Offset = (WORD)offset;</div>
<div class="line">                VertexElements[ s].Type = Info.D3DType;</div>
<div class="line">                VertexElements[ s].Method = D3DDECLMETHOD_DEFAULT;</div>
<div class="line">                VertexElements[ s].Usage = (BYTE)Semantics[ s].Usage;</div>
<div class="line">                VertexElements[ s].UsageIndex = (BYTE)Semantics[ s].UsageIndex;</div>
<div class="line">                offset += varying.getMaximumStride();</div>
<div class="line">            }</div>
<div class="line"> <span class="keyword">static</span> D3DVERTEXELEMENT9 VertexElementEnd = D3DDECL_END();</div>
<div class="line">            VertexElements[ NumSemantics] = VertexElementEnd;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Make sure that the point is initialized in case something fails</span></div>
<div class="line">            fD3DVertexDeclaration[p] = NULL;</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_d3_d9_renderer.html">MD3D9Renderer</a>* pRenderer = <a class="code" href="./class_m_d3_d9_renderer.html#a7e20874dc16aef527b927346672fdbfa">MD3D9Renderer::theRenderer</a>();</div>
<div class="line"> <span class="keywordflow">if</span> (pRenderer != NULL) {</div>
<div class="line">                IDirect3DDevice9* d3dDevice = pRenderer-&gt;getD3D9Device();</div>
<div class="line"> <span class="keywordflow">if</span>( d3dDevice) {</div>
<div class="line">                    d3dDevice-&gt;CreateVertexDeclaration( VertexElements, &amp;fD3DVertexDeclaration[ p]);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> <a name="_a142"></a><a class="code" href="./class_m_varying_parameter_list.html">MVaryingParameterList</a> list;</div>
<div class="line"> <span class="keywordflow">if</span>( fVertexStructure.numElements() &gt; 0)</div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Only add our parameters if we have some - otherwise the empty structure</span></div>
<div class="line"> <span class="comment">// shows up in the UI which is a bit ugly</span></div>
<div class="line">            list.<a name="a143"></a><a class="code" href="./class_m_varying_parameter_list.html#a5dca32aa8a764505aba6f29d1acf37c4">append</a>( fVertexStructure);</div>
<div class="line">        }</div>
<div class="line">        setVaryingParameters( list);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Error reporting</span></div>
<div class="line"><span class="keywordtype">void</span> hlslShader::reportInternalError( <span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="keyword">function</span>, <span class="keywordtype">size_t</span> errcode )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> es = <span class="stringliteral">"hlslShader"</span>;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">if</span> ( <span class="keyword">this</span> )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">if</span> ( ++fErrorCount &gt; ERROR_LIMIT ) </div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> s;</div>
<div class="line">            s += <span class="stringliteral">"\""</span>;</div>
<div class="line">            s += name();</div>
<div class="line">            s += <span class="stringliteral">"\": "</span>;</div>
<div class="line">            s += typeName();</div>
<div class="line">            es = s;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">catch</span> ( ... )</div>
<div class="line">    {}</div>
<div class="line">    es += <span class="stringliteral">" internal error "</span>;</div>
<div class="line">    es += (int)errcode;</div>
<div class="line">    es += <span class="stringliteral">" in "</span>;</div>
<div class="line">    es += <span class="keyword">function</span>;</div>
<div class="line"> <a class="code" href="./class_m_global.html#a4ddbe97e58a90e1ab05d45a62c006cf0">MGlobal::displayError</a>( es );</div>
<div class="line">}                                      <span class="comment">// hlslShader::reportInternalError</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> parameterRequirements(<span class="keyword">const</span> <a class="code" href="./class_m_varying_parameter.html">MVaryingParameter</a>&amp; parameter, <a name="_a144"></a><a class="code" href="./class_m_geometry_requirements.html">MGeometryRequirements</a>&amp; requirements)</div>
<div class="line"><span class="comment">// recursive requirements </span></div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span> (parameter.<a name="a145"></a><a class="code" href="./class_m_varying_parameter.html#ac7fba35931cc9a520837b0a752352e16">numElements</a>() == 0) {</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">switch</span>( parameter.<a name="a146"></a><a class="code" href="./class_m_varying_parameter.html#aa54f29a363de8795281d2e6e978e894c">semantic</a>())</div>
<div class="line">        {</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">case</span> (<a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321a45b7096916b12a78e94c62bba9d50739">MVaryingParameter::kTexCoord</a>) :</div>
<div class="line">            requirements.<a name="a147"></a><a class="code" href="./class_m_geometry_requirements.html#afd5a8b1052778de698bfce452630541c">addTexCoord</a>(parameter.<a name="a148"></a><a class="code" href="./class_m_varying_parameter.html#a2e8d4c38a60806df8c2ffd6d09e70b96">name</a>()); </div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> (<a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321aa20581584e5f9447cb96afb4f2e10703">MVaryingParameter::kPosition</a>) :</div>
<div class="line">            requirements.<a name="a149"></a><a class="code" href="./class_m_geometry_requirements.html#ac06310a311e21853120d0cc6f0e10fa1">addPosition</a>();</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> (<a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321a227e8416235cd3b43077ca91504a463f">MVaryingParameter::kNormal</a>) :</div>
<div class="line">            requirements.<a name="a150"></a><a class="code" href="./class_m_geometry_requirements.html#ac225c13948fae1c5058e28da27fb1cc4">addNormal</a>();</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">case</span> (<a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321afc0133ebaa6c307b2388ecf5f72f6fdf">MVaryingParameter::kColor</a>) :</div>
<div class="line">            requirements.<a name="a151"></a><a class="code" href="./class_m_geometry_requirements.html#a41fbeecafb7fc5f4aca13539dc008d07">addColor</a>(parameter.<a class="code" href="./class_m_varying_parameter.html#a2e8d4c38a60806df8c2ffd6d09e70b96">name</a>());</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line"> <span class="keywordflow">default</span>:</div>
<div class="line"> <span class="comment">// don't know what it is.</span></div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> {</div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; parameter.<a class="code" href="./class_m_varying_parameter.html#ac7fba35931cc9a520837b0a752352e16">numElements</a>(); ++i) {</div>
<div class="line">            parameterRequirements(parameter.<a name="a152"></a><a class="code" href="./class_m_varying_parameter.html#a40cde1a792fb9a978d3a3a68414fb865">getElement</a>(i), requirements);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"></div>
<div class="line"><span class="comment">/* virtual */</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> hlslShader::renderSwatchImage(<a name="_a153"></a><a class="code" href="./class_m_image.html">MImage</a>&amp; image)</div>
<div class="line"><span class="comment">// Override this method to draw a image for swatch rendering.</span></div>
<div class="line"><span class="comment"></span>{</div>
<div class="line"></div>
<div class="line"><span class="comment">// #define _USE_OPENGL_</span></div>
<div class="line"><span class="preprocessor">#if defined _USE_OPENGL_    // </span></div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status = <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MStatus::kFailure</a>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get the hardware openGL renderer utility class</span></div>
<div class="line"> <a name="_a154"></a><a class="code" href="./class_m_hardware_renderer.html">MHardwareRenderer</a> *pRenderer = MHardwareRenderer::theRenderer();</div>
<div class="line"> <span class="keywordflow">if</span> (pRenderer)</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; backEndStr = pRenderer-&gt;<a name="a155"></a><a class="code" href="./class_m_hardware_renderer.html#afd786038730d9c301a6b3a489d22d816">backEndString</a>();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// get the geometry requirements</span></div>
<div class="line"> <a name="_a156"></a><a class="code" href="./class_m_dag_path.html">MDagPath</a> path;                          <span class="comment">// NULL path</span></div>
<div class="line"> <a class="code" href="./class_m_geometry_requirements.html">MGeometryRequirements</a> requirements;</div>
<div class="line">        requirements.<a class="code" href="./class_m_geometry_requirements.html#ac06310a311e21853120d0cc6f0e10fa1">addPosition</a>();</div>
<div class="line">        requirements.<a class="code" href="./class_m_geometry_requirements.html#ac225c13948fae1c5058e28da27fb1cc4">addNormal</a>();</div>
<div class="line">        requirements.<a class="code" href="./class_m_geometry_requirements.html#afd5a8b1052778de698bfce452630541c">addTexCoord</a>(<a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"map1"</span>));  </div>
<div class="line">        requirements.<a name="a157"></a><a class="code" href="./class_m_geometry_requirements.html#a616c12d042fee6c914771c9c6b599d77">addComponentId</a>();</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_geometry_manager.html#a5f45789e2294fc128af5b04595d96505">MGeometryManager::GeometricShape</a> shape = <a name="a158"></a><a class="code" href="./class_m_geometry_manager.html#a5f45789e2294fc128af5b04595d96505acb4a5f68a3b6cd8c05b1dc9c5a487c88">MGeometryManager::kDefaultSphere</a>;</div>
<div class="line"> <a class="code" href="./class_m_geometry_list.html">MGeometryList</a>* geomIter = <a name="a159"></a><a class="code" href="./class_m_geometry_manager.html#a2ca963e158461194b1840050f88f1917">MGeometryManager::referenceDefaultGeometry</a>(shape, requirements);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span>(geomIter == NULL) {</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MStatus::kFailure</a>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Make the swatch context current</span></div>
<div class="line"> <span class="comment">// ===============================</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width, height;</div>
<div class="line">        image.<a name="a160"></a><a class="code" href="./class_m_image.html#acab1f6acf34fc74e4d717322fa35241a">getSize</a>(width, height);</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status2 = pRenderer-&gt;<a name="a161"></a><a class="code" href="./class_m_hardware_renderer.html#a4d85f022b09d72ce1f6a17ad4fa41be4">makeSwatchContextCurrent</a>( backEndStr, width, height );</div>
<div class="line"></div>
<div class="line">        glPushAttrib(GL_ALL_ATTRIB_BITS);</div>
<div class="line">        glPushClientAttrib(GL_CLIENT_VERTEX_ARRAY_BIT);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span>( status2 != <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> ) {</div>
<div class="line"> <a name="a162"></a><a class="code" href="./class_m_geometry_manager.html#af5a7f7bce62d712ed57586e6cf9c43f0">MGeometryManager::dereferenceDefaultGeometry</a>(geomIter);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get the light direction from the API, and use it</span></div>
<div class="line"> <span class="comment">// =============================================</span></div>
<div class="line">        {    </div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">float</span>  specular[] = { 0.7f, 0.7f, 0.7f, 1.0f};</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">float</span>  shine[] = { 100.0f };</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">float</span>  ambient[] = { 0.2f, 0.2f, 0.2f, 1.0f };</div>
<div class="line"></div>
<div class="line">            glEnable(GL_LIGHTING);</div>
<div class="line">            glColorMaterial(GL_FRONT_AND_BACK, GL_DIFFUSE);</div>
<div class="line">            glMaterialfv(GL_FRONT_AND_BACK, GL_SPECULAR, specular);</div>
<div class="line">            glMaterialfv(GL_FRONT_AND_BACK, GL_SHININESS, shine);</div>
<div class="line">            glMaterialfv(GL_FRONT_AND_BACK, GL_AMBIENT, ambient);</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">float</span> lightPos[4];</div>
<div class="line">            pRenderer-&gt;<a name="a163"></a><a class="code" href="./class_m_hardware_renderer.html#a4fa0ae8729daf1a0125906fad0fc1704">getSwatchLightDirection</a>( lightPos[0], lightPos[1], lightPos[2], lightPos[3] );</div>
<div class="line"></div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">float</span> default_ambient_light[]={0.4f, 0.4f, 0.4f, 1.0f};</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">float</span> default_diffuse_light[]={0.8f, 0.8f, 0.8f, 1.0f};</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">float</span> default_specular_light[]={1.0f, 1.0f, 1.0f, 1.0f};</div>
<div class="line"></div>
<div class="line">            glLightfv(GL_LIGHT0, GL_AMBIENT, default_ambient_light);</div>
<div class="line">            glLightfv(GL_LIGHT0, GL_DIFFUSE, default_diffuse_light);</div>
<div class="line">            glLightfv(GL_LIGHT0, GL_SPECULAR, default_specular_light);</div>
<div class="line"></div>
<div class="line">            glPushMatrix();</div>
<div class="line">            glLoadIdentity();</div>
<div class="line">            glLightfv(GL_LIGHT0, GL_POSITION, lightPos);</div>
<div class="line">            glEnable(GL_LIGHT0);</div>
<div class="line">            glPopMatrix();</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get camera</span></div>
<div class="line"> <span class="comment">// ==========</span></div>
<div class="line">        {</div>
<div class="line"> <span class="comment">// Get the camera frustum from the API</span></div>
<div class="line">            glMatrixMode(GL_PROJECTION);</div>
<div class="line">            glLoadIdentity();</div>
<div class="line"> <span class="keywordtype">double</span> l, r, b, t, n, f;</div>
<div class="line">            pRenderer-&gt;<a name="a164"></a><a class="code" href="./class_m_hardware_renderer.html#a14d1484740450d30fa540baf31f47a09">getSwatchPerspectiveCameraSetting</a>( l, r, b, t, n, f );</div>
<div class="line">            glFrustum( l, r, b, t, n, f );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// want to store these into the </span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get the default background color and clear the background</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordtype">float</span> r, g, b, a;</div>
<div class="line"> <a name="a165"></a><a class="code" href="./class_m_h_w_shader_swatch_generator.html#a95a6855572205246f2741796ed8c5bdc">MHWShaderSwatchGenerator::getSwatchBackgroundColor</a>( r, g, b, a );</div>
<div class="line">        glClearColor( r, g, b, a );</div>
<div class="line">        glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</div>
<div class="line"></div>
<div class="line">        glShadeModel(GL_SMOOTH);</div>
<div class="line">        glEnable(GL_DEPTH_TEST);</div>
<div class="line">        glDepthFunc(GL_LEQUAL);</div>
<div class="line">        glHint(GL_PERSPECTIVE_CORRECTION_HINT, GL_NICEST);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span>( ; !geomIter-&gt;<a class="code" href="./class_m_geometry_list.html#add4bf50abae421d88b5549de6c11fc75">isDone</a>(); geomIter-&gt;<a class="code" href="./class_m_geometry_list.html#a041249f802c5bf4c2deae666610e03c4">next</a>())</div>
<div class="line">        {</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_geometry.html">MGeometry</a>&amp; geometry = geomIter-&gt;<a class="code" href="./class_m_geometry_list.html#a80965170c5e6cc6da53676b54de22630">geometry</a>(<a class="code" href="./class_m_geometry_list.html#a385c44f6fb256e5716a2302a5b940388a634ee767a8e90ff4d56e140459cca31f">MGeometryList::kNone</a>);</div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_matrix.html">MMatrix</a>&amp; mtm = geomIter-&gt;<a class="code" href="./class_m_geometry_list.html#acd8c4aab0285c0e0077b1c12d8cfda9a">objectToWorldMatrix</a>();</div>
<div class="line"></div>
<div class="line">            glMatrixMode(GL_MODELVIEW);</div>
<div class="line">            glLoadMatrixd(mtm[0]);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// TO DO the geomIterator needs to give up the project matrix.</span></div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_geometry_primitive.html">MGeometryPrimitive</a> primitives = geometry.<a class="code" href="./class_m_geometry.html#ad0b84023dd720ca2b0b8b05893dab358">primitiveArray</a>(0);</div>
<div class="line"></div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_geometry_data.html">MGeometryData</a> pos = geometry.<a class="code" href="./class_m_geometry.html#a117087d6021defde4f3202650c48f3ce">position</a>();</div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_geometry_data.html">MGeometryData</a> normal = geometry.<a name="a166"></a><a class="code" href="./class_m_geometry.html#aa6680785c2ecf1772013b55775fbcc2d">normal</a>();</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Draw The Swatch</span></div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (pos.<a class="code" href="./class_m_geometry_data.html#ac73113f892730ec6fce5da7e3273c9cd">data</a>() != NULL &amp;&amp; primitives.<a class="code" href="./class_m_geometry_primitive.html#ad3b74abc0bab69f337c70783e73f5bef">data</a>() != NULL) {</div>
<div class="line"></div>
<div class="line">                glEnableClientState(GL_VERTEX_ARRAY);</div>
<div class="line">                glVertexPointer(3, GL_FLOAT, 0, (<span class="keywordtype">float</span>*) pos.<a class="code" href="./class_m_geometry_data.html#ac73113f892730ec6fce5da7e3273c9cd">data</a>());</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (normal.<a class="code" href="./class_m_geometry_data.html#ac73113f892730ec6fce5da7e3273c9cd">data</a>()) {</div>
<div class="line">                    glEnableClientState(GL_NORMAL_ARRAY);</div>
<div class="line">                    glNormalPointer(GL_FLOAT, 0,  normal.<a class="code" href="./class_m_geometry_data.html#ac73113f892730ec6fce5da7e3273c9cd">data</a>());</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// get the first texture and blind it</span></div>
<div class="line"> <span class="keywordtype">bool</span> boundTexture = <span class="keyword">false</span>;</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> defaultMap(<span class="stringliteral">"map1"</span>);</div>
<div class="line"> <a class="code" href="./class_m_geometry_data.html">MGeometryData</a> uvCoord = geometry.<a name="a167"></a><a class="code" href="./class_m_geometry.html#a6a5f2937533ee58b7c2c7c1d64c203c2">texCoord</a>(defaultMap);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Setup our shape dependent parameters</span></div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">int</span> u = fUniformParameters.length(); u--; ){</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> uniform = fUniformParameters.getElement( u);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> ( uniform.<a class="code" href="./class_m_uniform_parameter.html#a37357b066d4c628b1fae2f1ee08b2b12">isATexture</a>()) {</div>
<div class="line"> <span class="comment">// make sure that it a 2d texture as we can't handle anything else.</span></div>
<div class="line"> <span class="keywordflow">if</span>( uniform.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>() == <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a7d3972f1f1ee99452d3c715b157b5cad">MUniformParameter::kType2DTexture</a>) </div>
<div class="line">                        {</div>
<div class="line"> <span class="comment">// Get the plug used for the first texture - but be careful to preserve</span></div>
<div class="line"> <span class="comment">// the hasChanged state so that the shader correctly updates this parameter</span></div>
<div class="line"> <span class="comment">// (otherwise it may never setup the texture parameter because we suppressed</span></div>
<div class="line"> <span class="comment">// the initial hasChanged trigger)</span></div>
<div class="line"> <span class="keywordtype">bool</span> wasDirty = uniform.<a class="code" href="./class_m_uniform_parameter.html#a9d4d257e5bb7e85eb9fdeca499dc9361">hasChanged</a>( *geomIter);</div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a> plug = uniform.<a name="a168"></a><a class="code" href="./class_m_uniform_parameter.html#a000c434a3beb6c2cc9681d9e445cf0eb">getSource</a>();</div>
<div class="line"> <span class="keywordflow">if</span>( wasDirty) uniform.<a class="code" href="./class_m_uniform_parameter.html#a92a590790db6444ca7a79eaf5fbcb0d9">setDirty</a>();</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_image_file_info.html#a9b0c9320a802a00a718bcab75ba40550">MImageFileInfo::MHwTextureType</a> hwType;</div>
<div class="line"> <span class="keywordflow">if</span> (<a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> == <a name="a169"></a><a class="code" href="./class_m_hw_texture_manager.html#a1135feb4729cedcfc70935c196fd0448">MHwTextureManager::glBind</a>(plug, hwType))</div>
<div class="line">                            {</div>
<div class="line">                                boundTexture = <span class="keyword">true</span>;</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (uvCoord.<a class="code" href="./class_m_geometry_data.html#ac73113f892730ec6fce5da7e3273c9cd">data</a>() &amp;&amp; boundTexture) {</div>
<div class="line"></div>
<div class="line">                    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);</div>
<div class="line">                    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);</div>
<div class="line">                    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</div>
<div class="line">                    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</div>
<div class="line"></div>
<div class="line">                    glEnableClientState(GL_TEXTURE_COORD_ARRAY);</div>
<div class="line">                    glTexCoordPointer(2, GL_FLOAT, 0, uvCoord.<a class="code" href="./class_m_geometry_data.html#ac73113f892730ec6fce5da7e3273c9cd">data</a>());</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Base colour is always white</span></div>
<div class="line">                    glColor4f(1.0f, 1.0f, 1.0f, 1.0f);</div>
<div class="line">                }</div>
<div class="line"> <span class="keywordflow">else</span> {</div>
<div class="line"></div>
<div class="line">                    glDisable(GL_TEXTURE_2D);</div>
<div class="line">                    glBindTexture(GL_TEXTURE_2D, 0);</div>
<div class="line">                    glColor4f(0.1f, 0.7f, 0.7f, 1.0f);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_geometry_primitive.html">MGeometryPrimitive</a> primitives = geometry.<a class="code" href="./class_m_geometry.html#ad0b84023dd720ca2b0b8b05893dab358">primitiveArray</a>(0);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// renderer</span></div>
<div class="line">                glDrawElements(GL_TRIANGLES, primitives.<a class="code" href="./class_m_geometry_primitive.html#ac9580a2ec3ad9690d0fb0ea0b3179fec">elementCount</a>(), GL_UNSIGNED_INT, primitives.<a class="code" href="./class_m_geometry_primitive.html#ad3b74abc0bab69f337c70783e73f5bef">data</a>());</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Read pixels back from swatch context to MImage</span></div>
<div class="line">                pRenderer-&gt;<a name="a170"></a><a class="code" href="./class_m_hardware_renderer.html#ae2bc38072d14c1b8e1988e1f2ae73066">readSwatchContextPixels</a>( backEndStr, image );</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Double check the outing going image size as image resizing</span></div>
<div class="line"> <span class="comment">// was required to properly read from the swatch context</span></div>
<div class="line">                image.<a class="code" href="./class_m_image.html#acab1f6acf34fc74e4d717322fa35241a">getSize</a>( width, height );</div>
<div class="line"></div>
<div class="line">                glPopAttrib();</div>
<div class="line">                glPopClientAttrib();</div>
<div class="line"></div>
<div class="line">                status = <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_geometry_manager.html#af5a7f7bce62d712ed57586e6cf9c43f0">MGeometryManager::dereferenceDefaultGeometry</a>(geomIter);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status = <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MStatus::kFailure</a>;</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width, height;</div>
<div class="line">    image.<a name="a171"></a><a class="code" href="./class_m_image.html#ac5d25e7e2d395f432b5a8077024e34c4">setRGBA</a>(<span class="keyword">true</span>);</div>
<div class="line">    image.<a class="code" href="./class_m_image.html#acab1f6acf34fc74e4d717322fa35241a">getSize</a>(width, height);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// get the geometry requirements</span></div>
<div class="line">    ShaderContext context;                  <span class="comment">// NULL path and shading engine</span></div>
<div class="line"> <a class="code" href="./class_m_geometry_requirements.html">MGeometryRequirements</a> requirements;</div>
<div class="line">    populateRequirements(context, requirements);</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_d3_d9_renderer.html">MD3D9Renderer</a>*  Render = <a class="code" href="./class_m_d3_d9_renderer.html#a7e20874dc16aef527b927346672fdbfa">MD3D9Renderer::theRenderer</a>();</div>
<div class="line"> <span class="keywordflow">if</span> (Render != NULL) {</div>
<div class="line"></div>
<div class="line">        Render-&gt;<a name="a172"></a><a class="code" href="./class_m_d3_d9_renderer.html#a365d315999f5037edaa24368fe70dcdc">makeSwatchContextCurrent</a>(width, height);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// render the back ground</span></div>
<div class="line">        Render-&gt;<a name="a173"></a><a class="code" href="./class_m_d3_d9_renderer.html#a18b658ea5bf9d773516baaa2ab849659">setBackgroundColor</a>(<a name="_a174"></a><a class="code" href="./class_m_color.html">MColor</a>(0.1f, 0.1f, 0.1f));</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_geometry_list.html">MGeometryList</a>* geomIter = <a class="code" href="./class_m_geometry_manager.html#a2ca963e158461194b1840050f88f1917">MGeometryManager::referenceDefaultGeometry</a>(<a class="code" href="./class_m_geometry_manager.html#a5f45789e2294fc128af5b04595d96505acb4a5f68a3b6cd8c05b1dc9c5a487c88">MGeometryManager::kDefaultSphere</a>, </div>
<div class="line">            requirements);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (geomIter == NULL) {</div>
<div class="line"> <span class="keywordflow">return</span> status;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// set up lighting</span></div>
<div class="line"> <span class="comment">// TO DO</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// render the object this the shader and defaulting geometry</span></div>
<div class="line"> <span class="keywordflow">if</span> (render(*geomIter) != <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>) {</div>
<div class="line"> <span class="comment">// revert to a simple fixed color material render</span></div>
<div class="line"> <span class="comment">// TO DO</span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// read back the image</span></div>
<div class="line">        Render-&gt;<a name="a175"></a><a class="code" href="./class_m_d3_d9_renderer.html#a7c665a339c86e26197266d74975e083e">readSwatchContextPixels</a>(image);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// let go of the geoemtry</span></div>
<div class="line"> <a class="code" href="./class_m_geometry_manager.html#af5a7f7bce62d712ed57586e6cf9c43f0">MGeometryManager::dereferenceDefaultGeometry</a>(geomIter);</div>
<div class="line"></div>
<div class="line">        status = <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> status;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* virtual */</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> hlslShader::getAvailableImages( <span class="keyword">const</span> <a name="_a176"></a><a class="code" href="./struct_m_px_hardware_shader_1_1_shader_context.html">MPxHardwareShader::ShaderContext</a> &amp;context,</div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a> &amp;uvSetName,</div>
<div class="line"> <a name="_a177"></a><a class="code" href="./class_m_string_array.html">MStringArray</a> &amp;imageNames )</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Only scan for available images if we have a valid effect.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordflow">if</span>( !fD3DEffect )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span> <a name="a178"></a><a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a598e4c5d4c234c1bf09367d64487519c">MStatus::kNotImplemented</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Locate the varying parameters whose source is 'uvSetName'</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a class="code" href="./class_m_string_array.html">MStringArray</a> uvParams;</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nVarying = fVertexStructure.numElements();</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; nVarying; i++ )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_varying_parameter.html">MVaryingParameter</a> elem = fVertexStructure.<a class="code" href="./class_m_varying_parameter.html#a40cde1a792fb9a978d3a3a68414fb865">getElement</a>(i);</div>
<div class="line"> <span class="keywordflow">if</span>( elem.<a name="a179"></a><a class="code" href="./class_m_varying_parameter.html#ad72ff2b3fb20052e4a2455dad5c10682">getSourceType</a>() == <a class="code" href="./class_m_varying_parameter.html#afb0ef1fa13fbda77e55c3b59adcae321a45b7096916b12a78e94c62bba9d50739">MVaryingParameter::kTexCoord</a> &amp;&amp;</div>
<div class="line">            elem.<a name="a180"></a><a class="code" href="./class_m_varying_parameter.html#a45e2132632639698f9c4f668be933a70">getSourceSetName</a>() == uvSetName )</div>
<div class="line">        {</div>
<div class="line">            uvParams.<a name="a181"></a><a class="code" href="./class_m_string_array.html#a18d06b3d0af1426e654ac2cc1dc86c60">append</a>( elem.<a class="code" href="./class_m_varying_parameter.html#a2e8d4c38a60806df8c2ffd6d09e70b96">name</a>() );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Determine the default texture.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> defaultTex;</div>
<div class="line"> <span class="keywordflow">if</span>( uvParams.<a name="a182"></a><a class="code" href="./class_m_string_array.html#a580388f31f60c46fac867ca48a48da1e">length</a>() &gt; 0 )</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Only process the first entry of this UV set (if multiple exist).</span></div>
<div class="line"> <span class="comment">// There can only be one default, so we'll only consider the default</span></div>
<div class="line"> <span class="comment">// of the first varying input of this UV set.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a name="_a183"></a><a class="code" href="./class_m_fn_dependency_node.html">MFnDependencyNode</a> depFn( thisMObject() );</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> attrName( uvParams[0] );</div>
<div class="line">        attrName += <span class="stringliteral">"_DefaultTexture"</span>;</div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a> defaultTexPlug = depFn.findPlug( attrName );</div>
<div class="line"> <span class="keywordflow">if</span>( !defaultTexPlug.<a name="a184"></a><a class="code" href="./class_m_plug.html#a1c18142e8f09680711f472aa2ddf8ac6">isNull</a>() )</div>
<div class="line">        {</div>
<div class="line">            defaultTexPlug.<a name="a185"></a><a class="code" href="./class_m_plug.html#a64f7093bfde5c5eb9d89b32635b772aa">getValue</a>( defaultTex );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Locate any texture UVLinks that point to these uvParams and record</span></div>
<div class="line"> <span class="comment">// those textures.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nUniform = fUniformParameters.length();</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nUVParams = uvParams.<a class="code" href="./class_m_string_array.html#a580388f31f60c46fac867ca48a48da1e">length</a>();</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; nUVParams; i++ )</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; varName = uvParams[i];</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; nUniform; j++ )</div>
<div class="line">        {</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> elem = fUniformParameters.<a class="code" href="./class_m_varying_parameter.html#a40cde1a792fb9a978d3a3a68414fb865">getElement</a>(j);</div>
<div class="line"> <span class="keywordflow">if</span>( elem.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>() != <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a7d3972f1f1ee99452d3c715b157b5cad">MUniformParameter::kType2DTexture</a> )</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            LPCSTR uvLinkAnnot;</div>
<div class="line">            D3DXHANDLE d3dParameter = (D3DXHANDLE) elem.<a class="code" href="./class_m_uniform_parameter.html#aabc6dea98709831626d182f1bce0c69a">userData</a>();</div>
<div class="line"> <span class="keywordflow">if</span>( !GetAnnotation(d3dParameter, <span class="stringliteral">"UVLink"</span>, uvLinkAnnot) )</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> uvLink( uvLinkAnnot );</div>
<div class="line"> <span class="keywordflow">if</span>( uvLink == varName )</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordflow">if</span>( elem.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>() == defaultTex )</div>
<div class="line">                {</div>
<div class="line">                    imageNames.<a name="a186"></a><a class="code" href="./class_m_string_array.html#a3db31367f989449bb9b121cd734dc0df">insert</a>( elem.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>(), 0 );</div>
<div class="line">                }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    imageNames.<a class="code" href="./class_m_string_array.html#a18d06b3d0af1426e654ac2cc1dc86c60">append</a>( elem.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>() );</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// If no UVLinks found, display all 2D textures.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordflow">if</span>( imageNames.<a class="code" href="./class_m_string_array.html#a580388f31f60c46fac867ca48a48da1e">length</a>() == 0 )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; nUniform; i++ )</div>
<div class="line">        {</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> elem = fUniformParameters.getElement(i);</div>
<div class="line"> <span class="keywordflow">if</span>( elem.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>() == <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a7d3972f1f1ee99452d3c715b157b5cad">MUniformParameter::kType2DTexture</a> )</div>
<div class="line">            {</div>
<div class="line"> <span class="keywordflow">if</span>( elem.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>() == defaultTex )</div>
<div class="line">                {</div>
<div class="line">                    imageNames.<a class="code" href="./class_m_string_array.html#a3db31367f989449bb9b121cd734dc0df">insert</a>( elem.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>(), 0 );</div>
<div class="line">                }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    imageNames.<a class="code" href="./class_m_string_array.html#a18d06b3d0af1426e654ac2cc1dc86c60">append</a>( elem.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>() );</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> (imageNames.<a class="code" href="./class_m_string_array.html#a580388f31f60c46fac867ca48a48da1e">length</a>() &gt; 0) ? <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a> : <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a598e4c5d4c234c1bf09367d64487519c">MStatus::kNotImplemented</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* virtual */</span></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> hlslShader::renderImage( <span class="keyword">const</span> <a class="code" href="./struct_m_px_hardware_shader_1_1_shader_context.html">MPxHardwareShader::ShaderContext</a> &amp;context,</div>
<div class="line"> <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a> &amp;imageName,</div>
<div class="line">                                floatRegion region,</div>
<div class="line"> <span class="keyword">const</span> <a name="_a187"></a><a class="code" href="./struct_m_px_hardware_shader_1_1_render_parameters.html">MPxHardwareShader::RenderParameters</a>&amp; <span class="comment">/*parameters*/</span>,</div>
<div class="line"> <span class="keywordtype">int</span> &amp;imageWidth,</div>
<div class="line"> <span class="keywordtype">int</span> &amp;imageHeight )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> imageParam;</div>
<div class="line"> <span class="keywordtype">bool</span> foundParam = <span class="keyword">false</span>;</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nUniform = fUniformParameters.length();</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; nUniform; i++ )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> elem = fUniformParameters.getElement(i);</div>
<div class="line"> <span class="keywordflow">if</span>( elem.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>() == imageName )</div>
<div class="line">        {</div>
<div class="line">            imageParam = elem;</div>
<div class="line">            foundParam = <span class="keyword">true</span>;</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span>( !foundParam )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a598e4c5d4c234c1bf09367d64487519c">MStatus::kNotImplemented</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Only supports 2D textures.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordflow">if</span>( imageParam.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>() != <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a7d3972f1f1ee99452d3c715b157b5cad">MUniformParameter::kType2DTexture</a> )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a598e4c5d4c234c1bf09367d64487519c">MStatus::kNotImplemented</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Draw the texture (in OpenGL)</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line">    glPushAttrib( GL_ALL_ATTRIB_BITS );</div>
<div class="line">    glPushClientAttrib( GL_CLIENT_VERTEX_ARRAY_BIT);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Use MHwTextureManager for our texture cache, since we need to</span></div>
<div class="line"> <span class="comment">// render in OpenGL.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a class="code" href="./class_m_plug.html">MPlug</a> plug = imageParam.<a class="code" href="./class_m_uniform_parameter.html#a000c434a3beb6c2cc9681d9e445cf0eb">getSource</a>();</div>
<div class="line"> <a class="code" href="./class_m_image_file_info.html#a9b0c9320a802a00a718bcab75ba40550">MImageFileInfo::MHwTextureType</a> hwType;</div>
<div class="line"> <span class="keywordflow">if</span>( <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> != <a class="code" href="./class_m_hw_texture_manager.html#a1135feb4729cedcfc70935c196fd0448">MHwTextureManager::glBind</a>(plug, hwType) )</div>
<div class="line">    {</div>
<div class="line">        glPopAttrib();</div>
<div class="line">        glPopClientAttrib();</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_fn_dependency_node.html">MFnDependencyNode</a> fnNode( thisMObject() );</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> sMsg = <span class="stringliteral">"hlslShader "</span>;</div>
<div class="line">        sMsg += fnNode.name();</div>
<div class="line">        sMsg += <span class="stringliteral">" : failed to load texture \""</span>;</div>
<div class="line">        sMsg += imageName;</div>
<div class="line">        sMsg += <span class="stringliteral">"\"."</span>;</div>
<div class="line"> <a name="a188"></a><a class="code" href="./class_m_global.html#acb043e7fc4eb7fc0f39833d31364b8a4">MGlobal::displayWarning</a>( sMsg );</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a598e4c5d4c234c1bf09367d64487519c">MStatus::kNotImplemented</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    GLint width = 0;</div>
<div class="line">    GLint height = 0;</div>
<div class="line">    glGetTexLevelParameteriv(GL_TEXTURE_2D, 0, GL_TEXTURE_WIDTH, &amp;width);</div>
<div class="line">    glGetTexLevelParameteriv(GL_TEXTURE_2D, 0, GL_TEXTURE_HEIGHT, &amp;height);</div>
<div class="line"></div>
<div class="line">    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);</div>
<div class="line">    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);</div>
<div class="line"></div>
<div class="line">    glBegin( GL_QUADS );</div>
<div class="line">    glTexCoord2f(region[0][0], region[0][1]);</div>
<div class="line">    glVertex2f(region[0][0], region[0][1]);</div>
<div class="line">    glTexCoord2f(region[0][0], region[1][1]);</div>
<div class="line">    glVertex2f(region[0][0], region[1][1]);</div>
<div class="line">    glTexCoord2f(region[1][0], region[1][1]);</div>
<div class="line">    glVertex2f(region[1][0], region[1][1]);</div>
<div class="line">    glTexCoord2f(region[1][0], region[0][1]);</div>
<div class="line">    glVertex2f(region[1][0], region[0][1]);</div>
<div class="line">    glEnd();</div>
<div class="line"></div>
<div class="line">    glPopAttrib();</div>
<div class="line">    glPopClientAttrib();</div>
<div class="line"></div>
<div class="line">    imageWidth = (int) width;</div>
<div class="line">    imageHeight = (int) height;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MStatus::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> hlslShader::uvLinks( <span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; varyingParamName,</div>
<div class="line"> <a class="code" href="./class_m_string_array.html">MStringArray</a>&amp; uniformTextureNames )</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">if</span>( !fD3DEffect )</div>
<div class="line">    {</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Parse through the uniform parameters for UVLink annotations</span></div>
<div class="line"> <span class="comment">// against 'varyingParamName'.</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nUniform = fUniformParameters.length();</div>
<div class="line"> <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; nUniform; i++ )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_uniform_parameter.html">MUniformParameter</a> elem = fUniformParameters.getElement(i);</div>
<div class="line"> <span class="keywordflow">if</span>( elem.<a class="code" href="./class_m_uniform_parameter.html#ac52395416dfb965501c67061d7198c1c">type</a>() != <a class="code" href="./class_m_uniform_parameter.html#ad8ed01ff3ff33333d8e19db4d2818bb6a7d3972f1f1ee99452d3c715b157b5cad">MUniformParameter::kType2DTexture</a> )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        LPCSTR uvLinkAnnot;</div>
<div class="line">        D3DXHANDLE d3dParameter = (D3DXHANDLE) elem.<a class="code" href="./class_m_uniform_parameter.html#aabc6dea98709831626d182f1bce0c69a">userData</a>();</div>
<div class="line"> <span class="keywordflow">if</span>( !GetAnnotation(d3dParameter, <span class="stringliteral">"UVLink"</span>, uvLinkAnnot) )</div>
<div class="line">        {</div>
<div class="line"> <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> uvLink( uvLinkAnnot );</div>
<div class="line"> <span class="keywordflow">if</span>( uvLink == varyingParamName )</div>
<div class="line">        {</div>
<div class="line">            uniformTextureNames.<a class="code" href="./class_m_string_array.html#a18d06b3d0af1426e654ac2cc1dc86c60">append</a>( elem.<a class="code" href="./class_m_uniform_parameter.html#aca2cba4630391c78dcf1a828986160da">name</a>() );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// hlslShaderCmd</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="preprocessor">#define kUVLinkFlag         "-uvl"</span></div>
<div class="line"><span class="preprocessor">#define kUVLinkFlagLong     "-uvLink"</span></div>
<div class="line"></div>
<div class="line">hlslShaderCmd::hlslShaderCmd()</div>
<div class="line">{}</div>
<div class="line"></div>
<div class="line">hlslShaderCmd::~hlslShaderCmd()</div>
<div class="line">{}</div>
<div class="line"></div>
<div class="line"><a class="code" href="./class_m_status.html">MStatus</a> hlslShaderCmd::doIt( <span class="keyword">const</span> <a name="_a189"></a><a class="code" href="./class_m_arg_list.html">MArgList</a>&amp; args )</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_status.html">MStatus</a> status;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Parse the shader node</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <a name="_a190"></a><a class="code" href="./class_m_arg_parser.html">MArgParser</a> parser( syntax(), args );</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> nodeName;</div>
<div class="line">    parser.getCommandArgument( 0, nodeName );</div>
<div class="line"></div>
<div class="line"> <a name="_a191"></a><a class="code" href="./class_m_selection_list.html">MSelectionList</a> list;</div>
<div class="line">    status = list.<a name="a192"></a><a class="code" href="./class_m_selection_list.html#a23929aeafb29672f2652128eac9c4dec">add</a>( nodeName );</div>
<div class="line"> <a class="code" href="./class_m_object.html">MObject</a> shaderNode;</div>
<div class="line">    status = list.<a name="a193"></a><a class="code" href="./class_m_selection_list.html#a72d8cd9c78fd234dcf68cd2fb70bc432">getDependNode</a>( 0, shaderNode );</div>
<div class="line"> <span class="keywordflow">if</span>( status != <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a> )</div>
<div class="line">    {</div>
<div class="line">        displayError( <span class="stringliteral">"Invalid hlslShader node: "</span> + nodeName );</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> <a class="code" href="./class_m_fn_dependency_node.html">MFnDependencyNode</a> depFn( shaderNode );</div>
<div class="line"> <span class="keywordflow">if</span>( depFn.typeId() != hlslShader::sId )</div>
<div class="line">    {</div>
<div class="line">        displayError( <span class="stringliteral">"Invalid hlslShader node: "</span> + nodeName );</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    hlslShader* shader = (hlslShader*) depFn.userNode();</div>
<div class="line"> <span class="keywordflow">if</span>( !shader )</div>
<div class="line">    {</div>
<div class="line">        displayError( <span class="stringliteral">"Invalid hlslShader node: "</span> + nodeName );</div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80a1ef6c2d725fb4bec3e7e840d28adbc00">MS::kFailure</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Process flag arguments</span></div>
<div class="line"> <span class="comment">//</span></div>
<div class="line"> <span class="keywordflow">if</span>( parser.isFlagSet(kUVLinkFlag) )</div>
<div class="line">    {</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> paramName;</div>
<div class="line">        parser.getFlagArgument( kUVLinkFlag, 0, paramName );</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_string_array.html">MStringArray</a> textures;</div>
<div class="line">        shader-&gt;uvLinks( paramName, textures );</div>
<div class="line">        setResult( textures );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> <a class="code" href="./class_m_status.html#a02ab596f4febca68da503aaf8dde3a80af0536797208144380691e2b376ffc1d1">MS::kSuccess</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a name="_a194"></a><a class="code" href="./class_m_syntax.html">MSyntax</a> hlslShaderCmd::newSyntax()</div>
<div class="line">{</div>
<div class="line"> <a class="code" href="./class_m_syntax.html">MSyntax</a> syntax;</div>
<div class="line">    syntax.<a name="a195"></a><a class="code" href="./class_m_syntax.html#aeaeaac3794bb4de8004afb1ac1829488">addFlag</a>( kUVLinkFlag, kUVLinkFlagLong, <a name="a196"></a><a class="code" href="./class_m_syntax.html#ae6f2057f0d0419845a48c1eb6813f2adafab53ea4a643325262b9c140af093279">MSyntax::kString</a> );</div>
<div class="line">    syntax.<a name="a197"></a><a class="code" href="./class_m_syntax.html#a1d306e0ce61954dd7cbdcd0e74a905a6">addArg</a>( <a class="code" href="./class_m_syntax.html#ae6f2057f0d0419845a48c1eb6813f2adafab53ea4a643325262b9c140af093279">MSyntax::kString</a> );</div>
<div class="line"> <span class="keywordflow">return</span> syntax;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span>* hlslShaderCmd::creator()</div>
<div class="line">{</div>
<div class="line"> <span class="keywordflow">return</span> <span class="keyword">new</span> hlslShaderCmd;</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="footer-block"><a class="comments-anchor" href="../html/ac.cmtdialog.htm" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div><br/></div>
</link></link></link></link></div></body>
</html>
