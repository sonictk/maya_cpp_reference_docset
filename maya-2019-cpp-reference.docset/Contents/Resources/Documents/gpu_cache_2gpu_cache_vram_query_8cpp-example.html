<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
<head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><script src="../scripts/utils/adsk.redirect.js" type="text/javascript"></script>
<title>gpuCache/gpuCacheVramQuery.cpp</title>
<meta content="C++" name="topic-subtype"/></head>
<body height="100%"><div class="body_content" id="body-content"><link href="cpp_ref/navtree.css" rel="stylesheet" type="text/css"/><link href="cpp_ref/doxygen.css" rel="stylesheet" type="text/css"/><link href="cpp_ref/tabs.css" rel="stylesheet" type="text/css"/><link href="style/adsk.cpm.css" rel="stylesheet" type="text/css"/><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('gpu_cache_2gpu_cache_vram_query_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>$("div#WidgetFloaterPanels,link[href*='microsofttranslator.com'],script[src*='microsofttranslator.com'],script[src*='bing.com']").remove();</script><script type="text/javascript">$("div#navigation,div#breadcrumbs,div#banner").attr("translate","no"); var mtLocation = ((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?ctf=True&ui=true&settings=Manual&from=en&hidelanguages='; yepnope.injectJs(mtLocation, function() {}, { charset:'utf-8', type:'text/javascript' } );</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script><!-- begin MT -->
<div class="Dark" id="MicrosoftTranslatorWidget" style="float:right;z-index:100;color:white;background-color:#bbbbbb;height:58px;overflow:hidden"></div>
<div>
<div class="head">
<h1>gpuCache/gpuCacheVramQuery.cpp</h1>
</div>
<div id="top"><!-- Generated by Doxygen 1.8.10 -->
<div class="tabs" id="navrow1">
<ul class="tablist">
<li><a href="./index.html"><span>MainÂ Page</span></a></li>
<li><a href="./pages.html"><span>Topics</span></a></li>
<li><a href="./modules.html"><span>Modules</span></a></li>
<li><a href="./namespaces.html"><span>Namespaces</span></a></li>
<li><a href="./annotated.html"><span>Classes</span></a></li>
<li><a href="./files.html"><span>Files</span></a></li>
<li><a href="./examples.html"><span>Examples</span></a></li>
</ul>
</div>
</div><!-- top -->
<div class="ui-resizable side-nav-resizable" id="side-nav">
<div id="nav-tree">
<div id="nav-tree-contents">
<div class="sync" id="nav-sync"></div>
</div>
</div>
<div class="ui-resizable-handle" id="splitbar" style="-moz-user-select:none;">
</div>
</div>
<div id="doc-content">
<div class="header">
<div class="headertitle">
<div class="title">gpuCache/gpuCacheVramQuery.cpp</div> </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">//-</span></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"><span class="comment">// Copyright 2015 Autodesk, Inc.  All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk </span></div>
<div class="line"><span class="comment">// license agreement provided at the time of installation or download, </span></div>
<div class="line"><span class="comment">// or which otherwise accompanies this software in either electronic </span></div>
<div class="line"><span class="comment">// or hard copy form.</span></div>
<div class="line"><span class="comment">//**************************************************************************/</span></div>
<div class="line"><span class="comment">//+</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include "gpuCacheVramQuery.h"</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include "gpuCacheGLFT.h"</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGlobal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MHardwareRenderer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MString.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"><span class="preprocessor">    #define INITGUID</span></div>
<div class="line"><span class="preprocessor">    #include &lt;windows.h&gt;</span></div>
<div class="line"><span class="preprocessor">    #include &lt;oleauto.h&gt;</span></div>
<div class="line"><span class="preprocessor">    #include &lt;initguid.h&gt;</span></div>
<div class="line"><span class="preprocessor">    #include &lt;wbemidl.h&gt;</span></div>
<div class="line"><span class="preprocessor">    #include &lt;dxgi.h&gt;</span></div>
<div class="line"><span class="preprocessor">#elif defined(__APPLE__) || defined(__MACH__)</span></div>
<div class="line"><span class="preprocessor">    #include &lt;ApplicationServices/ApplicationServices.h&gt;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">    #include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">    #include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">    #include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">    #include &lt;xcb/xcb.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGL.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>GPUCache;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//==============================================================================</span></div>
<div class="line"><span class="comment">// LOCAL FUNCTIONS</span></div>
<div class="line"><span class="comment">//==============================================================================</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>{</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Windows-specific helper functions.</span></div>
<div class="line"></div>
<div class="line"> <span class="keyword">typedef</span> BOOL (WINAPI *PfnCoSetProxyBlanket)(</div>
<div class="line">        IUnknown* pProxy, DWORD dwAuthnSvc, DWORD dwAuthzSvc,</div>
<div class="line">        OLECHAR* pServerPrincName, DWORD dwAuthnLevel, DWORD dwImpLevel,</div>
<div class="line">        RPC_AUTH_IDENTITY_HANDLE pAuthInfo, DWORD dwCapabilities);</div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>CoInitializeHelper</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">        CoInitializeHelper() {</div>
<div class="line">            fResult = CoInitialize(0);</div>
<div class="line">        }</div>
<div class="line">        ~CoInitializeHelper() {</div>
<div class="line">            CoUninitialize();</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">operator</span> bool() {</div>
<div class="line"> <span class="keywordflow">return</span> (SUCCEEDED(fResult));</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">        HRESULT fResult;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>Win32LibraryHelper</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">        Win32LibraryHelper(<span class="keyword">const</span> <span class="keywordtype">wchar_t</span>* library) {</div>
<div class="line">            fModule = LoadLibraryW(library);</div>
<div class="line">        }</div>
<div class="line">        ~Win32LibraryHelper() {</div>
<div class="line"> <span class="keywordflow">if</span> (fModule) {</div>
<div class="line">                FreeLibrary(fModule);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">operator</span> HINSTANCE()<span class="keyword"> const </span>{</div>
<div class="line"> <span class="keywordflow">return</span> fModule;</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">        HINSTANCE fModule;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">template</span>&lt;<span class="keyword">class</span> CoObjectType&gt;</div>
<div class="line"> <span class="keyword">class </span>CoObjectCreator</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line"> <span class="keyword">virtual</span> ~CoObjectCreator() {}</div>
<div class="line"> <span class="keyword">virtual</span> CoObjectType* operator() () <span class="keyword">const</span> = NULL;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">template</span>&lt;<span class="keyword">class</span> CoObjectType&gt;</div>
<div class="line"> <span class="keyword">class </span>CoObjectHelper</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">        CoObjectHelper(<span class="keyword">const</span> CoObjectCreator&lt;CoObjectType&gt;&amp; creator) {</div>
<div class="line">            fObject = creator();</div>
<div class="line">        }</div>
<div class="line">        CoObjectHelper(CoObjectType* <span class="keywordtype">object</span>) {</div>
<div class="line">            fObject = object;</div>
<div class="line">        }</div>
<div class="line">        ~CoObjectHelper() {</div>
<div class="line"> <span class="keywordflow">if</span> (fObject) {</div>
<div class="line">                fObject-&gt;Release();</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        CoObjectType* operator-&gt; ()<span class="keyword"> const </span>{</div>
<div class="line"> <span class="keywordflow">return</span> fObject;</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">operator</span> bool()<span class="keyword"> const </span>{</div>
<div class="line"> <span class="keywordflow">return</span> (fObject != NULL);</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">operator</span> CoObjectType*() <span class="keyword">const</span> {</div>
<div class="line"> <span class="keywordflow">return</span> fObject;</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">        CoObjectType* fObject;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>CoStringHelper</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">        CoStringHelper(<span class="keyword">const</span> <span class="keywordtype">wchar_t</span>* str) {</div>
<div class="line">            fString = SysAllocString(str);</div>
<div class="line">        }</div>
<div class="line">        ~CoStringHelper() {</div>
<div class="line"> <span class="keywordflow">if</span> (fString) {</div>
<div class="line">                SysFreeString(fString);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">operator</span> BSTR()<span class="keyword"> const </span>{</div>
<div class="line"> <span class="keywordflow">return</span> fString;</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">        BSTR fString;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>WbemLocatorHelper : <span class="keyword">public</span> CoObjectCreator&lt;IWbemLocator&gt;</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line"> <span class="keyword">virtual</span> IWbemLocator* operator() ()<span class="keyword"> const </span>{</div>
<div class="line">            IWbemLocator* wbemLocator = NULL;</div>
<div class="line">            HRESULT hres = CoCreateInstance(CLSID_WbemLocator, NULL, CLSCTX_INPROC_SERVER,</div>
<div class="line">                IID_IWbemLocator, (LPVOID*)&amp;wbemLocator);</div>
<div class="line"> <span class="keywordflow">return</span> SUCCEEDED(hres) ? wbemLocator : NULL;</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>WbemServicesHelper : <span class="keyword">public</span> CoObjectCreator&lt;IWbemServices&gt;</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">        WbemServicesHelper(IWbemLocator* wbemLocator) : fWbemLocator(wbemLocator) {}</div>
<div class="line"> <span class="keyword">virtual</span> IWbemServices* operator() ()<span class="keyword"> const </span>{</div>
<div class="line">            CoStringHelper ns(L<span class="stringliteral">"\\\\.\\root\\cimv2"</span>);</div>
<div class="line">            IWbemServices* wbemServices = NULL;</div>
<div class="line">            HRESULT hres = fWbemLocator-&gt;ConnectServer(ns, NULL, NULL, 0L, 0L, NULL, NULL, &amp;wbemServices);</div>
<div class="line"> <span class="keywordflow">return</span> SUCCEEDED(hres) ? wbemServices : NULL;</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">        IWbemLocator* fWbemLocator;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>EnumVideoCtrlHelper : <span class="keyword">public</span> CoObjectCreator&lt;IEnumWbemClassObject&gt;</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">        EnumVideoCtrlHelper(IWbemServices* wbemServices) : fWbemServices(wbemServices) {}</div>
<div class="line"> <span class="keyword">virtual</span> IEnumWbemClassObject* operator() ()<span class="keyword"> const </span>{</div>
<div class="line">            CoStringHelper className(L<span class="stringliteral">"Win32_VideoController"</span>);</div>
<div class="line">            IEnumWbemClassObject* enumVideoControllers = NULL;</div>
<div class="line">            HRESULT hres = fWbemServices-&gt;CreateInstanceEnum(className, 0, NULL, &amp;enumVideoControllers);</div>
<div class="line"> <span class="keywordflow">return</span> SUCCEEDED(hres) ? enumVideoControllers : NULL;</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">        IWbemServices* fWbemServices;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">typedef</span> HRESULT ( WINAPI* LPCREATEDXGIFACTORY )( REFIID, <span class="keywordtype">void</span>** );</div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>DXGIFactoryHelper : <span class="keyword">public</span> CoObjectCreator&lt;IDXGIFactory&gt;</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">        DXGIFactoryHelper(HINSTANCE dxgiModule) : fDXGIModule(dxgiModule) {}</div>
<div class="line"> <span class="keyword">virtual</span> IDXGIFactory* operator() ()<span class="keyword"> const </span>{</div>
<div class="line">            LPCREATEDXGIFACTORY createDXGIFactory = (LPCREATEDXGIFACTORY)</div>
<div class="line">                GetProcAddress(fDXGIModule, <span class="stringliteral">"CreateDXGIFactory"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (!createDXGIFactory) {</div>
<div class="line"> <span class="keywordflow">return</span> NULL;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            IDXGIFactory* dxgiFactory = NULL;</div>
<div class="line">            createDXGIFactory(__uuidof(IDXGIFactory), (LPVOID*)&amp;dxgiFactory);</div>
<div class="line"> <span class="keywordflow">return</span> dxgiFactory;</div>
<div class="line">        }</div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">        HINSTANCE fDXGIModule;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"> <span class="keyword">class </span>DXGIAdapterHelper : <span class="keyword">public</span> CoObjectCreator&lt;IDXGIAdapter&gt;</div>
<div class="line">    {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">        DXGIAdapterHelper(IDXGIFactory* dxgiFactory, UINT index)</div>
<div class="line">            : fDXGIFactory(dxgiFactory), fIndex(index) {}</div>
<div class="line"> <span class="keyword">virtual</span> IDXGIAdapter* operator() ()<span class="keyword"> const </span>{</div>
<div class="line">            IDXGIAdapter* dxgiAdapter = NULL;</div>
<div class="line">            HRESULT result = fDXGIFactory-&gt;EnumAdapters(fIndex, &amp;dxgiAdapter);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// End of enumeration</span></div>
<div class="line"> <span class="keywordflow">if</span> (FAILED(result)) {</div>
<div class="line"> <span class="keywordflow">return</span> NULL;</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">return</span> dxgiAdapter;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">        IDXGIFactory* fDXGIFactory;</div>
<div class="line">        UINT          fIndex;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#elif defined(__APPLE__) || defined(__MACH__)</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// OSX-specific helper functions.</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Nothing for now.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// Linux-specific helper functions.</span></div>
<div class="line"></div>
<div class="line">    std::string getXorgLogFilePath()</div>
<div class="line">    {</div>
<div class="line"> <span class="comment">// Provide a workaround to specify the Xorg log path in the case of a weird</span></div>
<div class="line"> <span class="comment">// installation.</span></div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">char</span>* xorgLogFilePathOverride = ::getenv(<span class="stringliteral">"MAYA_XORG_LOG_FILE_PATH_OVERRIDE"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (xorgLogFilePathOverride)</div>
<div class="line"> <span class="keywordflow">return</span> xorgLogFilePathOverride;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Default string on most systems.</span></div>
<div class="line">        constexpr <span class="keywordtype">char</span>* kDefaultFilePath = <span class="stringliteral">"/var/log/Xorg.0.log"</span>;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Get the current display in case the X server was started on a display number</span></div>
<div class="line"> <span class="comment">// different than 0.</span></div>
<div class="line"> <span class="keywordtype">char</span>* host = <span class="keyword">nullptr</span>;</div>
<div class="line"> <span class="keywordtype">int</span> display = 0;</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">int</span> xcbSuccess = xcb_parse_display(<span class="keyword">nullptr</span>, &amp;host, &amp;display, <span class="keyword">nullptr</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (!xcbSuccess)</div>
<div class="line"> <span class="keywordflow">return</span> kDefaultFilePath;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// We don't care about the returned host.  However, the approach of parsing</span></div>
<div class="line"> <span class="comment">// the local Xorg log file to determine access to graphics hardware will not</span></div>
<div class="line"> <span class="comment">// work if the X server is on a remote host.  However, I'm guessing a lot of</span></div>
<div class="line"> <span class="comment">// other stuff will be broken in that case as well, and the host could still</span></div>
<div class="line"> <span class="comment">// be referring to something like "localhost" or "127.0.0.1" and we don't</span></div>
<div class="line"> <span class="comment">// want to handle these possibilities.</span></div>
<div class="line">        ::free(host);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// In a similar way, the default location for the Xorg log can be set in</span></div>
<div class="line"> <span class="comment">// many ways:</span></div>
<div class="line"> <span class="comment">// - Default path at server compilation time</span></div>
<div class="line"> <span class="comment">// - Configuration file</span></div>
<div class="line"> <span class="comment">// - Command line argument</span></div>
<div class="line"> <span class="comment">// - Etc.</span></div>
<div class="line"> <span class="comment">// We don't really have a way to query for it, so we assume the default;</span></div>
<div class="line"> <span class="comment">// we only adjust for display number.</span></div>
<div class="line">        std::ostringstream o;</div>
<div class="line">        o &lt;&lt; <span class="stringliteral">"/var/log/Xorg."</span> &lt;&lt; display &lt;&lt; <span class="stringliteral">".log"</span>;</div>
<div class="line"> <span class="keywordflow">return</span> o.str();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>GPUCache {</div>
<div class="line"></div>
<div class="line"><span class="comment">//==============================================================================</span></div>
<div class="line"><span class="comment">// CLASS VramQuery</span></div>
<div class="line"><span class="comment">//==============================================================================</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">MUint64 VramQuery::queryVram()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Initialized in constructor</span></div>
<div class="line"> <span class="keywordflow">return</span> VramQuery::getInstance().fVram;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">bool</span> VramQuery::isGeforce()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Initialized in constructor</span></div>
<div class="line"> <span class="keywordflow">return</span> VramQuery::getInstance().fIsGeforce;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">bool</span> VramQuery::isQuadro()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Initialized in constructor</span></div>
<div class="line"> <span class="keywordflow">return</span> VramQuery::getInstance().fIsQuadro;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">const</span> <a name="_a0"></a><a class="code" href="./class_m_string.html">MString</a>&amp; VramQuery::manufacturer()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Initialized in constructor</span></div>
<div class="line"> <span class="keywordflow">return</span> VramQuery::getInstance().fManufacturer;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="./class_m_string.html">MString</a>&amp; VramQuery::model()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Initialized in constructor</span></div>
<div class="line"> <span class="keywordflow">return</span> VramQuery::getInstance().fModel;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> VramQuery::driverVersion(<span class="keywordtype">int</span> version[3])</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Initialized in constructor</span></div>
<div class="line"> <span class="keyword">const</span> VramQuery&amp; query = VramQuery::getInstance();</div>
<div class="line">    version[0] = query.fDriverVersion[0];</div>
<div class="line">    version[1] = query.fDriverVersion[1];</div>
<div class="line">    version[2] = query.fDriverVersion[2];</div>
<div class="line"></div>
<div class="line"> <span class="comment">//assert(version[0] != 0 || version[1] != 0 || version[2] != 0);</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"><span class="keywordtype">void</span> VramQuery::queryVramAndDriverWMI(MUint64&amp; vram, <span class="keywordtype">int</span> driverVersion[3], <a class="code" href="./class_m_string.html">MString</a>&amp; manufacturer, <a class="code" href="./class_m_string.html">MString</a>&amp; model)</div>
<div class="line">{</div>
<div class="line">    vram = driverVersion[0] = driverVersion[1] = driverVersion[2] = 0;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Initialize COM</span></div>
<div class="line">    CoInitializeHelper coInit;</div>
<div class="line"> <span class="keywordflow">if</span> (!coInit) {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// create WMI COM instance</span></div>
<div class="line">    WbemLocatorHelper wbemLocatorCreator;</div>
<div class="line">    CoObjectHelper&lt;IWbemLocator&gt; wbemLocator(wbemLocatorCreator);</div>
<div class="line"> <span class="keywordflow">if</span> (!wbemLocator) {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// connect to WMI</span></div>
<div class="line">    WbemServicesHelper wbemServiceCreator(wbemLocator);</div>
<div class="line">    CoObjectHelper&lt;IWbemServices&gt; wbemServices(wbemServiceCreator);</div>
<div class="line"> <span class="keywordflow">if</span> (!wbemServices) {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// switch security level to IMPERSONATE </span></div>
<div class="line">    Win32LibraryHelper ole32Library(L<span class="stringliteral">"ole32.dll"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (ole32Library) {</div>
<div class="line">        PfnCoSetProxyBlanket pfnCoSetProxyBlanket = </div>
<div class="line">            (PfnCoSetProxyBlanket)GetProcAddress(ole32Library, <span class="stringliteral">"CoSetProxyBlanket"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (pfnCoSetProxyBlanket) {</div>
<div class="line">            pfnCoSetProxyBlanket(wbemServices, RPC_C_AUTHN_WINNT, RPC_C_AUTHZ_NONE,</div>
<div class="line">                NULL, RPC_C_AUTHN_LEVEL_CALL, RPC_C_IMP_LEVEL_IMPERSONATE, NULL, 0);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// create video controller enum</span></div>
<div class="line">    EnumVideoCtrlHelper enumVideoCtrlCreator(wbemServices);</div>
<div class="line">    CoObjectHelper&lt;IEnumWbemClassObject&gt; enumVideoCtrls(enumVideoCtrlCreator);</div>
<div class="line"> <span class="keywordflow">if</span> (!enumVideoCtrls) {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// get the first 10 video controllers</span></div>
<div class="line">    IWbemClassObject* videoCtrls[10] = {0};</div>
<div class="line">    DWORD returned = 0;</div>
<div class="line">    enumVideoCtrls-&gt;Reset();</div>
<div class="line">    HRESULT hres = enumVideoCtrls-&gt;Next(5000, 10, videoCtrls, &amp;returned);</div>
<div class="line"> <span class="keywordflow">if</span> (FAILED(hres) || returned == 0) {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// query the video memory</span></div>
<div class="line">    VARIANT var;</div>
<div class="line">    VariantInit(&amp;var);</div>
<div class="line">    CoStringHelper vramPropName(L<span class="stringliteral">"AdapterRAM"</span>);</div>
<div class="line">    CoStringHelper compatPropName(L<span class="stringliteral">"AdapterCompatibility"</span>);</div>
<div class="line">    CoStringHelper driverVersionPropName(L<span class="stringliteral">"DriverVersion"</span>);</div>
<div class="line">    CoStringHelper modelPropName(L<span class="stringliteral">"Name"</span>);</div>
<div class="line">    MUint64 maxVidMem = 0;</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> driverVersionStr;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span> (UINT ctrlIndex = 0; ctrlIndex &lt; returned; ctrlIndex++) {</div>
<div class="line">        CoObjectHelper&lt;IWbemClassObject&gt; videoCtrl(videoCtrls[ctrlIndex]);</div>
<div class="line">        hres = videoCtrl-&gt;Get(vramPropName, 0L, &amp;var, NULL, NULL);</div>
<div class="line"> <span class="keywordflow">if</span> (SUCCEEDED(hres)) {</div>
<div class="line"> <span class="keywordflow">if</span> (var.ulVal &gt; maxVidMem) {</div>
<div class="line">                maxVidMem = var.ulVal;</div>
<div class="line"></div>
<div class="line">                VariantClear(&amp;var);</div>
<div class="line">                videoCtrl-&gt;Get(compatPropName, 0L, &amp;var, NULL, NULL);</div>
<div class="line">                manufacturer = var.bstrVal;</div>
<div class="line"></div>
<div class="line">                VariantClear(&amp;var);</div>
<div class="line">                videoCtrl-&gt;Get(driverVersionPropName, 0L, &amp;var, NULL, NULL);</div>
<div class="line">                driverVersionStr = var.bstrVal;</div>
<div class="line"></div>
<div class="line">                VariantClear(&amp;var);</div>
<div class="line">                videoCtrl-&gt;Get(modelPropName, 0L, &amp;var, NULL, NULL);</div>
<div class="line">                model = var.bstrVal;</div>
<div class="line"></div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        VariantClear(&amp;var);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    vram = maxVidMem;</div>
<div class="line"> <span class="keywordflow">if</span> (manufacturer == <span class="stringliteral">"NVIDIA"</span></div>
<div class="line">        || manufacturer == <span class="stringliteral">"NVIDIA "</span> <span class="comment">// beta drivers</span></div>
<div class="line">        ) {</div>
<div class="line"> <span class="comment">// e.g. 8.17.12.8026 = 280.26</span></div>
<div class="line"> <a name="_a1"></a><a class="code" href="./class_m_string_array.html">MStringArray</a> versions;</div>
<div class="line">        driverVersionStr.<a name="a2"></a><a class="code" href="./class_m_string.html#ac914d138fc96d7065c687a4f8b40c263">split</a>(<span class="charliteral">'.'</span>, versions);</div>
<div class="line"> <span class="keywordflow">if</span> (versions.<a name="a3"></a><a class="code" href="./class_m_string_array.html#a580388f31f60c46fac867ca48a48da1e">length</a>() == 4) {</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numChars2 = versions[2].numChars();</div>
<div class="line"> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numChars3 = versions[3].numChars();</div>
<div class="line"> <span class="keywordflow">if</span> (numChars2 &gt;= 1 &amp;&amp; numChars3 &gt;= 2) {</div>
<div class="line"> <span class="keywordflow">while</span> (numChars3 &lt; 4) {</div>
<div class="line"> <span class="comment">// If it has less than 4 digits, patch it with leading zeros.</span></div>
<div class="line"> <span class="comment">// e.g. 9.18.13.529 = 305.29</span></div>
<div class="line">                    versions[3] = <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"0"</span>) + versions[3];</div>
<div class="line">                    numChars3++;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> major1 = versions[2].substringW(numChars2-1, numChars2-1);</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> major2 = versions[3].substringW(0, 1);</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> major = major1 + major2;</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> minor = versions[3].substringW(2, numChars3-1);</div>
<div class="line"> <span class="keywordflow">if</span> (major.<a name="a4"></a><a class="code" href="./class_m_string.html#a36f5e915ae736395c577cf32724af3bf">isUnsigned</a>() &amp;&amp; minor.<a class="code" href="./class_m_string.html#a36f5e915ae736395c577cf32724af3bf">isUnsigned</a>()) {</div>
<div class="line">                    driverVersion[0] = major.<a name="a5"></a><a class="code" href="./class_m_string.html#a33a3313205686174bef095f523f9408b">asUnsigned</a>();</div>
<div class="line">                    driverVersion[1] = minor.<a class="code" href="./class_m_string.html#a33a3313205686174bef095f523f9408b">asUnsigned</a>();</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> (manufacturer == <span class="stringliteral">"ATI Technologies Inc."</span> || </div>
<div class="line">        manufacturer == <span class="stringliteral">"Advanced Micro Devices, Inc."</span>) {</div>
<div class="line"> <span class="comment">// e.g. 8.861.0.0 = 8.861</span></div>
<div class="line"> <span class="keywordtype">int</span> version[4], ret;</div>
<div class="line">        ret = sscanf_s(driverVersionStr.<a name="a6"></a><a class="code" href="./class_m_string.html#aa9ab612f356c53479afc4c648c9ef94d">asChar</a>(), <span class="stringliteral">"%d.%d.%d.%d"</span>,</div>
<div class="line">                &amp;version[0], &amp;version[1], &amp;version[2], &amp;version[3]);</div>
<div class="line"> <span class="keywordflow">if</span> (ret == 4) {</div>
<div class="line">            driverVersion[0] = version[0];</div>
<div class="line">            driverVersion[1] = version[1];</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">MUint64 VramQuery::queryVramDXGI()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Initialize COM</span></div>
<div class="line">    CoInitializeHelper coInit;</div>
<div class="line"> <span class="keywordflow">if</span> (!coInit) {</div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Load dxgi.dll (need Vista or later)</span></div>
<div class="line">    Win32LibraryHelper dxgiLibrary(L<span class="stringliteral">"dxgi.dll"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (!dxgiLibrary) {</div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Create DXGI Factory</span></div>
<div class="line">    DXGIFactoryHelper dxgiFactoryCreator(dxgiLibrary);</div>
<div class="line">    CoObjectHelper&lt;IDXGIFactory&gt; dxgiFactory(dxgiFactoryCreator);</div>
<div class="line"> <span class="keywordflow">if</span> (!dxgiFactory) {</div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    MUint64 maxVidMem = 0;</div>
<div class="line"> <span class="keywordflow">for</span> (UINT index = 0; ; ++index) {</div>
<div class="line">        DXGIAdapterHelper dxgiAdapterCreator(dxgiFactory, index);</div>
<div class="line">        CoObjectHelper&lt;IDXGIAdapter&gt; dxgiAdapter(dxgiAdapterCreator);</div>
<div class="line"> <span class="keywordflow">if</span> (!dxgiAdapter) {</div>
<div class="line"> <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        DXGI_ADAPTER_DESC dxgiAdapterDesc;</div>
<div class="line">        ZeroMemory(&amp;dxgiAdapterDesc, <span class="keyword">sizeof</span>(DXGI_ADAPTER_DESC));</div>
<div class="line"> </div>
<div class="line">        HRESULT result = dxgiAdapter-&gt;GetDesc(&amp;dxgiAdapterDesc);</div>
<div class="line"> <span class="keywordflow">if</span> (SUCCEEDED(result)) {</div>
<div class="line">            SIZE_T vidMem = dxgiAdapterDesc.DedicatedVideoMemory;</div>
<div class="line">            maxVidMem = (vidMem &gt; maxVidMem) ? vidMem : maxVidMem;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> maxVidMem;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#elif defined(__APPLE__) || defined(__MACH__)</span></div>
<div class="line"><span class="keywordtype">void</span> VramQuery::queryVramAndDriverMAC(MUint64&amp; vram, <span class="keywordtype">int</span> driverVersion[3], <a class="code" href="./class_m_string.html">MString</a>&amp; manufacturer, <a class="code" href="./class_m_string.html">MString</a>&amp; model)</div>
<div class="line">{</div>
<div class="line">    vram = 0;</div>
<div class="line">    driverVersion[0] = driverVersion[1] = driverVersion[2] = 0;</div>
<div class="line"></div>
<div class="line">    CGError res = CGDisplayNoErr;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// query active displays</span></div>
<div class="line">    CGDisplayCount dspCount = 0;</div>
<div class="line">    res = CGGetActiveDisplayList(0, NULL, &amp;dspCount);</div>
<div class="line"> <span class="keywordflow">if</span> (res || dspCount == 0) {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// use boost here</span></div>
<div class="line">    CGDirectDisplayID* displays = (CGDirectDisplayID*)calloc((<span class="keywordtype">size_t</span>)dspCount, <span class="keyword">sizeof</span>(CGDirectDisplayID));</div>
<div class="line">    res = CGGetActiveDisplayList(dspCount, displays, &amp;dspCount);</div>
<div class="line"> <span class="keywordflow">if</span> (res || dspCount == 0) {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    SInt64 maxVramTotal = 0;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; dspCount; i++) {</div>
<div class="line"> <span class="comment">// get the service port for the display</span></div>
<div class="line">        io_service_t dspPort = CGDisplayIOServicePort(displays[i]);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// ask IOKit for the VRAM size property</span></div>
<div class="line"> <span class="comment">/* HD 2600: IOFBMemorySize = 256MB. VRAM,totalsize = 256MB</span></div>
<div class="line"><span class="comment">           HD 5770: IOFBMemorySize = 512MB. VRAM,totalsize = 1024MB</span></div>
<div class="line"><span class="comment">           Apple's QA page is not correct. We should search for IOPCIDevice's VRAM,totalsize property.</span></div>
<div class="line"><span class="comment">        CFTypeRef typeCode = IORegistryEntryCreateCFProperty(dspPort,</span></div>
<div class="line"><span class="comment">            CFSTR(kIOFBMemorySizeKey),</span></div>
<div class="line"><span class="comment">            kCFAllocatorDefault,</span></div>
<div class="line"><span class="comment">            kNilOptions);</span></div>
<div class="line"><span class="comment">        */</span></div>
<div class="line">        SInt64 vramScale = 1;</div>
<div class="line">        CFTypeRef typeCode = IORegistryEntrySearchCFProperty(dspPort,</div>
<div class="line">            kIOServicePlane,</div>
<div class="line">            CFSTR(<span class="stringliteral">"VRAM,totalsize"</span>),</div>
<div class="line">            kCFAllocatorDefault,</div>
<div class="line">            kIORegistryIterateRecursively | kIORegistryIterateParents);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (!typeCode) {</div>
<div class="line"> <span class="comment">// On the new Mac Pro, we have VRAM,totalMB instead.</span></div>
<div class="line">            typeCode = IORegistryEntrySearchCFProperty(dspPort,</div>
<div class="line">                kIOServicePlane,</div>
<div class="line">                CFSTR(<span class="stringliteral">"VRAM,totalMB"</span>),</div>
<div class="line">                kCFAllocatorDefault,</div>
<div class="line">                kIORegistryIterateRecursively | kIORegistryIterateParents);</div>
<div class="line"> <span class="keywordflow">if</span> (typeCode) {</div>
<div class="line">                vramScale = 1024 * 1024;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// ensure we have valid data from IOKit</span></div>
<div class="line"> <span class="keywordflow">if</span> (typeCode) {</div>
<div class="line">            SInt64 vramTotal = 0;</div>
<div class="line"> <span class="keywordflow">if</span> (CFGetTypeID(typeCode) == CFNumberGetTypeID()) {</div>
<div class="line"> <span class="comment">// AMD, VRAM,totalsize is CFNumber</span></div>
<div class="line">                CFNumberGetValue((<span class="keyword">const</span> __CFNumber*)typeCode, kCFNumberSInt64Type, &amp;vramTotal);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CFGetTypeID(typeCode) == CFDataGetTypeID()) {</div>
<div class="line"> <span class="comment">// NVIDIA, VRAM,totalsize is CFData</span></div>
<div class="line">                CFIndex      length = CFDataGetLength((<span class="keyword">const</span> __CFData*)typeCode);</div>
<div class="line"> <span class="keyword">const</span> UInt8* data   = CFDataGetBytePtr((<span class="keyword">const</span> __CFData*)typeCode);</div>
<div class="line"> <span class="keywordflow">if</span> (length == 4) {</div>
<div class="line">                    vramTotal = *(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)data;</div>
<div class="line">                }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> (length == 8) {</div>
<div class="line">                    vramTotal = *(<span class="keyword">const</span> SInt64*)data;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            vramTotal *= vramScale;</div>
<div class="line">            CFRelease(typeCode);</div>
<div class="line"> </div>
<div class="line"> <span class="keywordflow">if</span> (vramTotal &gt; maxVramTotal) {</div>
<div class="line">                maxVramTotal = vramTotal;</div>
<div class="line"></div>
<div class="line">                typeCode = IORegistryEntrySearchCFProperty(dspPort,</div>
<div class="line">                            kIOServicePlane,</div>
<div class="line">                            CFSTR(<span class="stringliteral">"NVDA,Features"</span>),</div>
<div class="line">                            kCFAllocatorDefault,</div>
<div class="line">                            kIORegistryIterateRecursively | kIORegistryIterateParents);</div>
<div class="line"> <span class="keywordflow">if</span> (typeCode) {</div>
<div class="line">                    manufacturer = <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"NVIDIA"</span>);</div>
<div class="line">                    CFRelease(typeCode);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                typeCode = IORegistryEntrySearchCFProperty(dspPort,</div>
<div class="line">                            kIOServicePlane,</div>
<div class="line">                            CFSTR(<span class="stringliteral">"ATY,Copyright"</span>),</div>
<div class="line">                            kCFAllocatorDefault,</div>
<div class="line">                            kIORegistryIterateRecursively | kIORegistryIterateParents);</div>
<div class="line"> <span class="keywordflow">if</span> (typeCode) {</div>
<div class="line">                    manufacturer = <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"Advanced Micro Devices, Inc."</span>);</div>
<div class="line">                    CFRelease(typeCode);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// GPU model</span></div>
<div class="line">                typeCode = IORegistryEntrySearchCFProperty(dspPort,</div>
<div class="line">                            kIOServicePlane,</div>
<div class="line">                            CFSTR(<span class="stringliteral">"model"</span>),</div>
<div class="line">                            kCFAllocatorDefault,</div>
<div class="line">                            kIORegistryIterateRecursively | kIORegistryIterateParents);</div>
<div class="line"> <span class="keywordflow">if</span> (typeCode) {</div>
<div class="line"> <span class="keywordflow">if</span> (CFGetTypeID(typeCode) == CFDataGetTypeID()) {</div>
<div class="line">                        model = <a class="code" href="./class_m_string.html">MString</a>((<span class="keyword">const</span> <span class="keywordtype">char</span>*)CFDataGetBytePtr((<span class="keyword">const</span> __CFData*)typeCode));</div>
<div class="line">                    }</div>
<div class="line">                    CFRelease(typeCode);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    vram = (MUint64)maxVramTotal;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Query the display driver version.</span></div>
<div class="line"> <span class="comment">// e.g. 2.1 NVIDIA-7.2.9</span></div>
<div class="line"> <span class="comment">// e.g. 1.5 ATI-1.4.18</span></div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">char</span>* glVersion = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)gGLFT-&gt;glGetString(MGL_VERSION);</div>
<div class="line"> <span class="keywordflow">if</span> (glVersion) {</div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">char</span>* implVersion = strstr(glVersion, <span class="stringliteral">"-"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (implVersion) {</div>
<div class="line"> <span class="keywordtype">int</span> version[3], ret;</div>
<div class="line">            ret = sscanf(implVersion+1, <span class="stringliteral">"%d.%d.%d"</span>,</div>
<div class="line">                &amp;version[0], &amp;version[1], &amp;version[2]);</div>
<div class="line"> <span class="keywordflow">if</span> (ret == 3) {</div>
<div class="line">                driverVersion[0] = version[0];</div>
<div class="line">                driverVersion[1] = version[1];</div>
<div class="line">                driverVersion[2] = version[2];</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="keywordtype">void</span> VramQuery::queryVramAndDriverXORG(MUint64&amp; vram, <span class="keywordtype">int</span> driverVersion[3], <a class="code" href="./class_m_string.html">MString</a>&amp; manufacturer, <a class="code" href="./class_m_string.html">MString</a>&amp; model)</div>
<div class="line">{</div>
<div class="line">    vram = 0;</div>
<div class="line">    driverVersion[0] = driverVersion[1] = driverVersion[2] = 0;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// open the Xorg.0.log</span></div>
<div class="line">    std::string   line;</div>
<div class="line">    std::ifstream xorgLog(getXorgLogFilePath());</div>
<div class="line"> <span class="keywordflow">if</span> (!xorgLog.is_open()) {</div>
<div class="line"> <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordtype">int</span> maxVidMemKb = 0;</div>
<div class="line"> <span class="keywordtype">int</span> version[3] = {0, 0, 0}, versionSize = 0;</div>
<div class="line"> <span class="keywordflow">while</span> (xorgLog.good()) {</div>
<div class="line"> <span class="comment">// read a line</span></div>
<div class="line">        std::getline(xorgLog, line);</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Try to detect card model in the pattern of the following line:</span></div>
<div class="line"> <span class="comment">// "(--) PCI:*(0:15:0:0) 10de:061a:10de:055f nVidia Corporation G92 [Quadro FX 3700] rev 162, Mem @ 0xfa000000/16777216, 0xe0000000/268435456, 0xf8000000/33554432, I/O @ 0x0000d000/128"</span></div>
<div class="line"> <span class="keywordtype">size_t</span> initPos = line.find(<span class="stringliteral">"(--) PCI:"</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (model.<a name="a7"></a><a class="code" href="./class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() == 0 &amp;&amp;</div>
<div class="line">            initPos != std::string::npos &amp;&amp;</div>
<div class="line">            line.find(<span class="stringliteral">"Mem @"</span>) != std::string::npos &amp;&amp;</div>
<div class="line">            line.find(<span class="stringliteral">"I/O @"</span>) != std::string::npos</div>
<div class="line">            ) {</div>
<div class="line"> <span class="keywordtype">size_t</span> start = line.find(<span class="stringliteral">"["</span>, initPos);</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (start != std::string::npos) {</div>
<div class="line"> <span class="comment">// NVIDIA</span></div>
<div class="line"> <span class="keywordtype">size_t</span> end = line.find(<span class="stringliteral">"]"</span>, start);</div>
<div class="line">                model = <a class="code" href="./class_m_string.html">MString</a>(line.substr(start + 1, end - start - 1).c_str());</div>
<div class="line">                manufacturer = <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"NVIDIA"</span>);</div>
<div class="line">            }</div>
<div class="line"> <span class="keywordflow">else</span> {</div>
<div class="line">                start = line.find(<span class="stringliteral">"ATI Technologies Inc"</span>, initPos);</div>
<div class="line"> <span class="keywordflow">if</span> (start != std::string::npos) {</div>
<div class="line"> <span class="comment">// AMD</span></div>
<div class="line"> <span class="keywordtype">size_t</span> end0 = line.find(<span class="stringliteral">" ("</span>, start);</div>
<div class="line"> <span class="keywordtype">size_t</span> end1 = line.find(<span class="stringliteral">", Mem @"</span>, start);</div>
<div class="line"> <span class="keywordtype">size_t</span> end = (end0 != std::string::npos &amp;&amp; end0 &lt; end1) ? end0 : end1; </div>
<div class="line">                    model = <a class="code" href="./class_m_string.html">MString</a>(line.substr(start + 20, end - start - 20).c_str());</div>
<div class="line">                    manufacturer = <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"Advanced Micro Devices, Inc."</span>);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// Try to detect card model in the pattern of the following line:</span></div>
<div class="line"> <span class="comment">// "(II) NVIDIA(0): NVIDIA GPU Quadro 4000 (GF100GL) at PCI:1:1:0 (GPU-0)"</span></div>
<div class="line"> <span class="keywordflow">if</span> (model.<a class="code" href="./class_m_string.html#a580388f31f60c46fac867ca48a48da1e">length</a>() == 0) {</div>
<div class="line"> <span class="keywordtype">size_t</span> start = line.find(<span class="stringliteral">"NVIDIA GPU "</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (start != std::string::npos &amp;&amp;</div>
<div class="line">                line.find(<span class="stringliteral">"NVIDIA("</span>) != std::string::npos) {</div>
<div class="line"> <span class="keywordtype">size_t</span> end0 = line.find(<span class="stringliteral">" ("</span>, start);</div>
<div class="line"> <span class="keywordtype">size_t</span> end1 = line.find(<span class="stringliteral">" at"</span>, start);</div>
<div class="line"> <span class="keywordtype">size_t</span> end = (end0 != std::string::npos &amp;&amp; end0 &lt; end1) ? end0 : end1; </div>
<div class="line">                model = <a class="code" href="./class_m_string.html">MString</a>(line.substr(start + 11, end - start - 11).c_str());</div>
<div class="line">                manufacturer = <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"NVIDIA"</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// find VRAM</span></div>
<div class="line"> <span class="keywordtype">size_t</span> startOffset = std::string::npos;</div>
<div class="line"> <span class="keywordtype">size_t</span> endOffset   = std::string::npos;</div>
<div class="line"> <span class="keywordflow">if</span> (line.find(<span class="stringliteral">"NVIDIA"</span>) != std::string::npos) {</div>
<div class="line"> <span class="comment">// found NVIDIA</span></div>
<div class="line">            startOffset = line.find(<span class="stringliteral">"Memory:"</span>) + 7;</div>
<div class="line">            endOffset   = line.find(<span class="stringliteral">"kBytes"</span>);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (startOffset == std::string::npos ||</div>
<div class="line">                endOffset == std::string::npos) {</div>
<div class="line"> <span class="comment">// possible AMD</span></div>
<div class="line">            startOffset = line.find(<span class="stringliteral">"Video RAM:"</span>) + 10;</div>
<div class="line">            endOffset   = line.find(<span class="stringliteral">"kByte"</span>);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (startOffset != std::string::npos &amp;&amp;</div>
<div class="line">                endOffset != std::string::npos) {</div>
<div class="line"> <span class="comment">// parse the number between start and end</span></div>
<div class="line">            std::string strVidMem = line.substr(startOffset, endOffset - startOffset);</div>
<div class="line"> <span class="keywordtype">int</span> vidMemKb = atoi(strVidMem.c_str());</div>
<div class="line">            maxVidMemKb  = (vidMemKb &gt; maxVidMemKb) ? vidMemKb : maxVidMemKb;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"> <span class="comment">// find driver version</span></div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">char</span>* driver = NULL;</div>
<div class="line"> <span class="keywordflow">if</span> ((driver = strstr(line.c_str(), <span class="stringliteral">"NVIDIA dlloader X Driver"</span>))) {</div>
<div class="line">            versionSize = sscanf(driver+24, <span class="stringliteral">"%d.%d.%d"</span>,</div>
<div class="line">                &amp;version[0], &amp;version[1], &amp;version[2]);</div>
<div class="line">            manufacturer = <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"NVIDIA"</span>);</div>
<div class="line">        }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((driver = strstr(line.c_str(), <span class="stringliteral">"ATI Proprietary Linux Driver Release Identifier:"</span>))) {</div>
<div class="line">            versionSize = sscanf(driver+48, <span class="stringliteral">"%d.%d"</span>,</div>
<div class="line">                &amp;version[0], &amp;version[1]);</div>
<div class="line">            manufacturer = <a class="code" href="./class_m_string.html">MString</a>(<span class="stringliteral">"Advanced Micro Devices, Inc."</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    vram = MUint64(maxVidMemKb) * 1024;</div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; versionSize; i++) {</div>
<div class="line">        driverVersion[i] = version[i];</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">MUint64 VramQuery::queryVramOGL()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Query Vram by OpenGL extensions.</span></div>
<div class="line"> <span class="comment">// This function needs an OpenGL context.</span></div>
<div class="line"> <span class="keywordflow">if</span> (gGLFT &amp;&amp; gGLFT-&gt;extensionExists(kMGLext_NVX_gpu_memory_info)) {</div>
<div class="line"> <span class="comment">// NVIDIA GL_NVX_gpu_memory_info exists</span></div>
<div class="line">        MGLint dedicatedVidMem = 0;</div>
<div class="line">        gGLFT-&gt;glGetIntegerv(MGL_GPU_MEMORY_INFO_DEDICATED_VIDMEM_NVX, &amp;dedicatedVidMem);</div>
<div class="line"> <span class="keywordflow">return</span> MUint64(dedicatedVidMem) * 1024;</div>
<div class="line">    }</div>
<div class="line"> <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gGLFT &amp;&amp; gGLFT-&gt;extensionExists(kMGLext_ATI_meminfo)) {</div>
<div class="line"> <span class="comment">// AMD GL_ATI_meminfo exists</span></div>
<div class="line">        MGLint freeVBOMem[4] = {0, 0, 0, 0};</div>
<div class="line">        gGLFT-&gt;glGetIntegerv(MGL_VBO_FREE_MEMORY_ATI, freeVBOMem);</div>
<div class="line"> <span class="keywordflow">return</span> MUint64(freeVBOMem[0]) * 1024;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">bool</span> VramQuery::isGeforceOGL()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Query the renderer by glGetString.</span></div>
<div class="line"> <span class="comment">// This function needs an OpenGL context</span></div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">char</span>* renderer = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)gGLFT-&gt;glGetString(MGL_RENDERER);</div>
<div class="line"> <span class="keywordflow">return</span> (renderer &amp;&amp; strstr(renderer, <span class="stringliteral">"GeForce"</span>));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">bool</span> VramQuery::isQuadroOGL()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Query the renderer by glGetString.</span></div>
<div class="line"> <span class="comment">// This function needs an OpenGL context</span></div>
<div class="line"> <span class="keyword">const</span> <span class="keywordtype">char</span>* renderer = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)gGLFT-&gt;glGetString(MGL_RENDERER);</div>
<div class="line"> <span class="keywordflow">return</span> (renderer &amp;&amp; strstr(renderer, <span class="stringliteral">"Quadro"</span>));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">const</span> VramQuery&amp; VramQuery::getInstance()</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// singleton, init on function call needs an OpenGL context</span></div>
<div class="line"> <span class="keyword">static</span> VramQuery query;</div>
<div class="line"> <span class="keywordflow">return</span> query;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line">VramQuery::VramQuery()</div>
<div class="line">    : fVram(0),</div>
<div class="line">      fIsGeforce(false),</div>
<div class="line">      fIsQuadro(false)</div>
<div class="line">{</div>
<div class="line">    fDriverVersion[0] = fDriverVersion[1] = fDriverVersion[2] = 0;</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">if</span> (<a name="a8"></a><a class="code" href="./class_m_global.html#afb0008b4212928b7913ba9cfc64fe88bafd5ecc6725f6695a70a949747cf89546">MGlobal::kInteractive</a> == <a name="a9"></a><a class="code" href="./class_m_global.html#ac7296da94b1d0b659833fc653a6af10e">MGlobal::mayaState</a>()) {</div>
<div class="line">        InitializeGLFT();</div>
<div class="line">        MUint64 vram = 0;</div>
<div class="line"> <span class="keywordtype">int</span>     driverVersion[3] = {0, 0, 0};</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> manufacturer;</div>
<div class="line"> <a class="code" href="./class_m_string.html">MString</a> model;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"> <span class="comment">// Windows, let's query VRAM via WMI</span></div>
<div class="line"> <span class="comment">// Please see the Video Memory sample in DirectX SDK</span></div>
<div class="line"> <span class="comment">// http://msdn.microsoft.com/en-us/library/ee419018%28v=vs.85%29.aspx</span></div>
<div class="line">        MUint64 vramDXGI = VramQuery::queryVramDXGI();</div>
<div class="line">        VramQuery::queryVramAndDriverWMI(vram, driverVersion, manufacturer, model);</div>
<div class="line"> <span class="keywordflow">if</span> (vramDXGI != 0) {</div>
<div class="line">            vram = vramDXGI;  <span class="comment">// DXGI can detect VRAM over 4G</span></div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#elif defined(__APPLE__) || defined(__MACH__)</span></div>
<div class="line"> <span class="comment">// Mac OSX, let's query VRAM via Core Graphics and IOKit</span></div>
<div class="line"> <span class="comment">// http://developer.apple.com/library/mac/#qa/qa1168/_index.html </span></div>
<div class="line">        VramQuery::queryVramAndDriverMAC(vram, driverVersion, manufacturer, model);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"> <span class="comment">// Linux, let's parse Xorg.0.log</span></div>
<div class="line">        VramQuery::queryVramAndDriverXORG(vram, driverVersion, manufacturer, model);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// the platform specific query failed</span></div>
<div class="line"> <span class="comment">// http://www.opengl.org/registry/specs/ATI/meminfo.txt </span></div>
<div class="line"> <span class="comment">// http://developer.download.nvidia.com/opengl/specs/GL_NVX_gpu_memory_info.txt </span></div>
<div class="line"> <span class="keywordflow">if</span> (vram == 0) {</div>
<div class="line">            vram = VramQuery::queryVramOGL();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// everything failed.. use a predefined value: 1G</span></div>
<div class="line"> <span class="keywordflow">if</span> (vram == 0) {</div>
<div class="line">            vram = 1 &lt;&lt; 30;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        fVram      = vram;</div>
<div class="line">        fDriverVersion[0] = driverVersion[0];</div>
<div class="line">        fDriverVersion[1] = driverVersion[1];</div>
<div class="line">        fDriverVersion[2] = driverVersion[2];</div>
<div class="line">        fIsGeforce = VramQuery::isGeforceOGL();</div>
<div class="line">        fIsQuadro  = VramQuery::isQuadroOGL();</div>
<div class="line">        fManufacturer = manufacturer;</div>
<div class="line">        fModel = model;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="footer-block"><a class="comments-anchor" href="../html/ac.cmtdialog.htm" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div></div>
</div></body>
</html>
