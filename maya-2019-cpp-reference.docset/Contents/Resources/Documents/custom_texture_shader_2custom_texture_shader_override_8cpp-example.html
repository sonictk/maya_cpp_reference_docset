<!-- saved from url=(0024)http://docs.autodesk.com -->
<html>
   <head><script src="../scripts/yepnope.1.5.4-min.js" type="text/javascript"></script><script src="../scripts/lib/jquery-1.11.1.min.js" type="text/javascript"></script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script type="text/javascript" src="../scripts/utils/adsk.redirect.js"></script>
      <title>customTextureShader/customTextureShaderOverride.cpp</title>
   

<meta name="topic-subtype" content="C++"></head>
   <body height="100%"><div class="body_content" id="body-content"><link rel="stylesheet" type="text/css" href="cpp_ref/navtree.css"><link rel="stylesheet" type="text/css" href="cpp_ref/doxygen.css"><link rel="stylesheet" type="text/css" href="cpp_ref/tabs.css"><link rel="stylesheet" type="text/css" href="style/adsk.cpm.css"><script type="text/javascript">
var tocSystemNeedsToBeLoaded = typeof(cpp_ref_adsk_ref_toc) == 'undefined';
var weAreIn21 = $('div#main.view-active').length;
var tocPrefix = '';
if (weAreIn21)
{ tocPrefix = 'cpp_ref/'; }
function cpp_ref_initializeToc(forceTrigger) {
    cpp_ref_adsk_ref_toc.initResizable();
    cpp_ref_adsk_ref_toc.initNavTree('custom_texture_shader_2custom_texture_shader_override_8cpp-example.html', tocPrefix);
    dQuery(document).trigger('toc_initialized');
}
if (tocSystemNeedsToBeLoaded)
{
	yepnope([{
	load:[tocPrefix + 'json3.min.js', tocPrefix + 'jquery.js', tocPrefix + 'ref-toc-controller.js', tocPrefix + 'dynsections.js'],
	complete: function() {
	  if (typeof(dQuery) == 'undefined')
	  {
	    dQuery = jQuery.noConflict(true);
	  }
	  else { jQuery.noConflict(true); }
	  $(document).ready(cpp_ref_initializeToc);
	}
 	}])
}
if (!weAreIn21) { // if in AKN...
$(window).load( function() {
    setTimeout( function() {
        var content = $('body > div').not('#body-content');     // take any divs under body that are not id=body-content
        content.each( function() { 
            $(this).css( { 'padding-left': $(this).css('margin-left') } );       // and if they have any padding-left already, move it to margin-left.
        } );
        var width = cpp_ref_adsk_ref_toc.readFromStorage('width');
        content.css({marginLeft:parseInt(width)+6+"px"});
    }, 100);
} ); 
}
</script><script>$("div#WidgetFloaterPanels,link[href*='microsofttranslator.com'],script[src*='microsofttranslator.com'],script[src*='bing.com']").remove();</script><script type='text/javascript'>$("div#navigation,div#breadcrumbs,div#banner").attr("translate","no"); var mtLocation = ((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?ctf=True&ui=true&settings=Manual&from=en&hidelanguages='; yepnope.injectJs(mtLocation, function() {}, { charset:'utf-8', type:'text/javascript' } );</script><script>
 if (!tocSystemNeedsToBeLoaded) { cpp_ref_initializeToc(); }
 </script><!-- begin MT -->
            
            <div id='MicrosoftTranslatorWidget' class='Dark' style='float:right;z-index:100;color:white;background-color:#bbbbbb;height:58px;overflow:hidden'></div>
      <div>
         <div class="head">
            <h1>customTextureShader/customTextureShaderOverride.cpp</h1>
         </div>

    <div id="top"><!-- Generated by Doxygen 1.8.10 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="#!/url=./cpp_ref/index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="#!/url=./cpp_ref/pages.html"><span>Topics</span></a></li>
      <li><a href="#!/url=./cpp_ref/modules.html"><span>Modules</span></a></li>
      <li><a href="#!/url=./cpp_ref/namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="#!/url=./cpp_ref/annotated.html"><span>Classes</span></a></li>
      <li><a href="#!/url=./cpp_ref/files.html"><span>Files</span></a></li>
      <li><a href="#!/url=./cpp_ref/examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" class="ui-resizable-handle">
  </div>
</div>

<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">customTextureShader/customTextureShaderOverride.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">//-</span></div>
<div class="line"><span class="comment">// Copyright 2012 Autodesk, Inc.  All rights reserved.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Use of this software is subject to the terms of the Autodesk license agreement</span></div>
<div class="line"><span class="comment">// provided at the time of installation or download, or which otherwise</span></div>
<div class="line"><span class="comment">// accompanies this software in either electronic or hard copy form.</span></div>
<div class="line"><span class="comment">//+</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;customTextureShaderOverride.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;customTextureShader.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MString.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MDrawContext.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;maya/MGlobal.h&gt;</span></div>
<div class="line"></div>
<div class="line">customTextureShaderOverride::customTextureShaderOverride(<span class="keyword">const</span> <a name="_a0"></a><a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a>&amp; obj)</div>
<div class="line">: <a class="code" href="#!/url=./cpp_ref/namespace_m_h_w_render.html">MHWRender</a>::MPxShaderOverride(obj)</div>
<div class="line">{</div>
<div class="line">    m_beautyShaderInstance = NULL;</div>
<div class="line">    m_multiDrawBeautyShaderInstance = NULL;</div>
<div class="line">    m_shaderBound = <span class="keyword">false</span>;</div>
<div class="line">    m_inBeautyPass = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// init custom texture data:</span></div>
<div class="line">    m_customTextureData = NULL;</div>
<div class="line"></div>
<div class="line">    <a name="_a1"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html">MHWRender::MRenderer</a>* renderer = <a name="a2"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html#a4678a72ac6959ed21d422d27928d0343">MHWRender::MRenderer::theRenderer</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (!renderer)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a name="_a3"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_manager.html">MHWRender::MShaderManager</a>* shaderMgr = renderer-&gt;<a name="a4"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html#a4603e18a1b89b798a2e4a4f36d9b5125">getShaderManager</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (!shaderMgr)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Tell Maya to get our shader</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// The plugin assumes that the devkit location follows &quot;Setting up your build</span></div>
<div class="line">    <span class="comment">// environment&quot; at Maya Developer Help; otherwise, shaders/textures cannot be</span></div>
<div class="line">    <span class="comment">// located. In this case create a mod (module description file) as below in a</span></div>
<div class="line">    <span class="comment">// suitable modules folder (getenv &quot;MAYA_MODULE_PATH&quot;) and restart Maya.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//   + devkit 1.0 &lt;local devkit path&gt;</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <a name="_a5"></a><a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> shaderLocation;</div>
<div class="line">    <span class="keywordflow">if</span>( !<a name="a6"></a><a class="code" href="#!/url=./cpp_ref/class_m_global.html#a09e405631e7cf680f8ac9d934ad73434">MGlobal::executeCommand</a>(<a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>(<span class="stringliteral">&quot;getModulePath -moduleName \&quot;devkit\&quot;&quot;</span>), shaderLocation, <span class="keyword">false</span>) ) {</div>
<div class="line">        shaderLocation = <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>(getenv(<span class="stringliteral">&quot;MAYA_LOCATION&quot;</span>)) + <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>(<span class="stringliteral">&quot;/devkit&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    shaderLocation += <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>(<span class="stringliteral">&quot;/plug-ins/customTextureShader/CustomTextureBlock&quot;</span>);</div>
<div class="line">    m_beautyShaderInstance = shaderMgr-&gt;<a name="a7"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_manager.html#a581c659670f0e3168750382c61a91a25">getEffectsFileShader</a>(shaderLocation, <span class="stringliteral">&quot;Main&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Load the MultiDraw alternate version of the shader</span></div>
<div class="line">    shaderLocation += <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>(<span class="stringliteral">&quot;MultiDraw&quot;</span>);</div>
<div class="line">    m_multiDrawBeautyShaderInstance = shaderMgr-&gt;<a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_manager.html#a581c659670f0e3168750382c61a91a25">getEffectsFileShader</a>(shaderLocation, <span class="stringliteral">&quot;Main&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a name="_a8"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_px_shader_override.html">MHWRender::MPxShaderOverride</a>* customTextureShaderOverride::Creator(<span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a>&amp; obj)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">new</span> customTextureShaderOverride(obj);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">customTextureShaderOverride::~customTextureShaderOverride()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (m_beautyShaderInstance || m_multiDrawBeautyShaderInstance)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html">MHWRender::MRenderer</a>* renderer = <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html#a4678a72ac6959ed21d422d27928d0343">MHWRender::MRenderer::theRenderer</a>();</div>
<div class="line">        <span class="keywordflow">if</span> (renderer)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_manager.html">MHWRender::MShaderManager</a>* shaderMgr = renderer-&gt;<a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html#a4603e18a1b89b798a2e4a4f36d9b5125">getShaderManager</a>();</div>
<div class="line">            <span class="keywordflow">if</span> (shaderMgr)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (m_beautyShaderInstance)</div>
<div class="line">                {</div>
<div class="line">                    shaderMgr-&gt;<a name="a9"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_manager.html#a0c7deb55edc231cbb2365b271ecd55f8">releaseShader</a>(m_beautyShaderInstance);</div>
<div class="line">                    m_beautyShaderInstance = NULL;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (m_multiDrawBeautyShaderInstance)</div>
<div class="line">                {</div>
<div class="line">                    shaderMgr-&gt;<a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_manager.html#a0c7deb55edc231cbb2365b271ecd55f8">releaseShader</a>(m_multiDrawBeautyShaderInstance);</div>
<div class="line">                    m_multiDrawBeautyShaderInstance = NULL;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// clean custom texture data:</span></div>
<div class="line">    <span class="keyword">delete</span> m_customTextureData;</div>
<div class="line">    m_customTextureData = NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> customTextureShaderOverride::initialize(<span class="keyword">const</span> MInitContext&amp; initContext, MInitFeedback&amp; initFeedback)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Set the geometry requirements for drawing.</span></div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> empty;</div>
<div class="line"></div>
<div class="line">    <a name="_a10"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_vertex_buffer_descriptor.html">MHWRender::MVertexBufferDescriptor</a> positionDesc(</div>
<div class="line">        empty,</div>
<div class="line">        <a name="a11"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_geometry.html#a5a5b1d8320f94d3c3d142753f5527fc4aa20581584e5f9447cb96afb4f2e10703">MHWRender::MGeometry::kPosition</a>,</div>
<div class="line">        <a name="a12"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_geometry.html#ad8ed01ff3ff33333d8e19db4d2818bb6a5686197bafb177bdc82550848416a1ad">MHWRender::MGeometry::kFloat</a>,</div>
<div class="line">        3);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_vertex_buffer_descriptor.html">MHWRender::MVertexBufferDescriptor</a> uvDesc(</div>
<div class="line">        empty,</div>
<div class="line">        <a name="a13"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_geometry.html#a5a5b1d8320f94d3c3d142753f5527fc4a6de4261b95102b5402b425d62e1bda93">MHWRender::MGeometry::kTexture</a>,</div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_geometry.html#ad8ed01ff3ff33333d8e19db4d2818bb6a5686197bafb177bdc82550848416a1ad">MHWRender::MGeometry::kFloat</a>,</div>
<div class="line">        2);</div>
<div class="line"></div>
<div class="line">    addGeometryRequirement(positionDesc);</div>
<div class="line">    addGeometryRequirement(uvDesc);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (m_beautyShaderInstance)</div>
<div class="line">    {</div>
<div class="line">        addShaderSignature(*m_beautyShaderInstance);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (m_multiDrawBeautyShaderInstance)</div>
<div class="line">    {</div>
<div class="line">        addShaderSignature(*m_multiDrawBeautyShaderInstance);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>(<span class="stringliteral">&quot;customTextureShaderOverride&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a name="_a14"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_instance.html">MHWRender::MShaderInstance</a>* customTextureShaderOverride::shaderInstance(<a name="_a15"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_draw_context.html">MHWRender::MDrawContext</a>&amp; context)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">if</span> (m_inBeautyPass)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (context.<a name="a16"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_draw_context.html#a7d0fc38902e84515879ea33cb99960a5">isMultiDraw</a>())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> m_multiDrawBeautyShaderInstance;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> m_beautyShaderInstance;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> customTextureShaderOverride::updateDG(<a class="code" href="#!/url=./cpp_ref/class_m_object.html">MObject</a> <span class="keywordtype">object</span>)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> customTextureShaderOverride::updateDevice()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Set parameters:</span></div>
<div class="line">    updateShaderInstance();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// build that custom data texture here and bind to shader:</span></div>
<div class="line">    buildAndUpdateCustomDataTextureViaMaya();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> customTextureShaderOverride::endUpdate()</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> customTextureShaderOverride::handlesDraw(<a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_draw_context.html">MHWRender::MDrawContext</a>&amp; context)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a name="_a17"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_pass_context.html">MHWRender::MPassContext</a>&amp; passCtx = context.<a name="a18"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_draw_context.html#ad3f9422688a9ffbe815c374ece46c1ea">getPassContext</a>();</div>
<div class="line">    <span class="keyword">const</span> <a name="_a19"></a><a class="code" href="#!/url=./cpp_ref/class_m_string_array.html">MStringArray</a>&amp; passSem = passCtx.<a name="a20"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_pass_context.html#a9737189d5cfffd795336d711a678d627">passSemantics</a>();</div>
<div class="line"></div>
<div class="line">    m_inBeautyPass = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// For color passes, only handle if there isn&#39;t already</span></div>
<div class="line">    <span class="comment">// a global override. This is the same as the default</span></div>
<div class="line">    <span class="comment">// logic for this method in MPxShaderOverride</span></div>
<div class="line">    <span class="keywordtype">bool</span> handlePass = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;passSem.<a name="a21"></a><a class="code" href="#!/url=./cpp_ref/class_m_string_array.html#a580388f31f60c46fac867ca48a48da1e">length</a>(); i++)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (passSem[i] == <a name="a22"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_pass_context.html#a97ffcfc5e6c4bd512eab6727c58a9ae8">MHWRender::MPassContext::kColorPassSemantic</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">bool</span> hasOverrideShader = passCtx.<a name="a23"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_pass_context.html#a54cb1ff5e4a10ffc51cb05ddab8e69ab">hasShaderOverride</a>();</div>
<div class="line">            <span class="keywordflow">if</span> (!hasOverrideShader)</div>
<div class="line">                handlePass = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">            m_inBeautyPass = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// If these semantics are specified then they override</span></div>
<div class="line">        <span class="comment">// the color pass semantic handling.</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (passSem[i] == <a name="a24"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_pass_context.html#a67e11eaab888b31695e3bc19dc1c26ef">MHWRender::MPassContext::kDepthPassSemantic</a> ||</div>
<div class="line">                 passSem[i] == <a name="a25"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_pass_context.html#a30804db03c6cccf4fd8d480fe4af0660">MHWRender::MPassContext::kNormalDepthPassSemantic</a>)</div>
<div class="line">        {</div>
<div class="line">            handlePass = <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> handlePass;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> customTextureShaderOverride::activateKey(<a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_draw_context.html">MHWRender::MDrawContext</a>&amp; context, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; <span class="comment">/*key*/</span>)</div>
<div class="line">{</div>
<div class="line">    m_inMultiDrawMode = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (m_inBeautyPass)</div>
<div class="line">    {</div>
<div class="line">        m_inMultiDrawMode = context.<a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_draw_context.html#a7d0fc38902e84515879ea33cb99960a5">isMultiDraw</a>();</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (m_inMultiDrawMode &amp;&amp; m_multiDrawBeautyShaderInstance)</div>
<div class="line">        {</div>
<div class="line">            m_multiDrawBeautyShaderInstance-&gt;bind(context); <span class="comment">// bind the MultiDraw version of the shader</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!m_inMultiDrawMode &amp;&amp; m_beautyShaderInstance)</div>
<div class="line">        {</div>
<div class="line">            m_beautyShaderInstance-&gt;bind(context);  <span class="comment">// make sure our shader is the active shader</span></div>
<div class="line">        }</div>
<div class="line">        m_shaderBound = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> customTextureShaderOverride::draw(<a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_draw_context.html">MHWRender::MDrawContext</a>&amp; context, <span class="keyword">const</span> <a name="_a26"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_render_item_list.html">MHWRender::MRenderItemList</a>&amp; renderItemList)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">if</span> (!m_shaderBound)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Draw for color pass</span></div>
<div class="line">    <span class="keywordflow">if</span> (m_inBeautyPass)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">        <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_instance.html">MHWRender::MShaderInstance</a> * shaderInstance = NULL;</div>
<div class="line">        <span class="keywordflow">if</span> (m_inMultiDrawMode)</div>
<div class="line">        {</div>
<div class="line">            shaderInstance = m_multiDrawBeautyShaderInstance;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            shaderInstance = m_beautyShaderInstance;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (shaderInstance)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> passCount = shaderInstance-&gt;<a name="a27"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_instance.html#af37a1499b42b48fa48a5bb446305d1f2">getPassCount</a>(context);</div>
<div class="line">            <span class="keywordflow">if</span> (passCount)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;passCount; i++)</div>
<div class="line">                {</div>
<div class="line">                    shaderInstance-&gt;<a name="a28"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_shader_instance.html#a0e164e1ae3d1df9f879a8fd4834b4272">activatePass</a>(context, i);</div>
<div class="line">                    <a name="a29"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_px_shader_override.html#a96b26e833c1533131841eb2bcb2288a4">MHWRender::MPxShaderOverride::drawGeometry</a>(context);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> customTextureShaderOverride::terminateKey(<a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_draw_context.html">MHWRender::MDrawContext</a>&amp; context, <span class="keyword">const</span> <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>&amp; <span class="comment">/*key*/</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (m_shaderBound &amp;&amp; m_inBeautyPass)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (m_inMultiDrawMode &amp;&amp; m_multiDrawBeautyShaderInstance)</div>
<div class="line">        {</div>
<div class="line">            m_multiDrawBeautyShaderInstance-&gt;unbind(context);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!m_inMultiDrawMode &amp;&amp; m_beautyShaderInstance)</div>
<div class="line">        {</div>
<div class="line">            m_beautyShaderInstance-&gt;unbind(context);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    m_inMultiDrawMode = <span class="keyword">false</span>;</div>
<div class="line">    m_shaderBound = <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="#!/url=./cpp_ref/namespace_m_h_w_render.html#ad970d5c990d4803d0e9d73c1ff4fda49">MHWRender::DrawAPI</a> customTextureShaderOverride::supportedDrawAPIs()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">return</span> ( <a name="a30"></a><a class="code" href="#!/url=./cpp_ref/namespace_m_h_w_render.html#ad970d5c990d4803d0e9d73c1ff4fda49a72361be679c1aca1c1be5f9b500a3315">MHWRender::kOpenGL</a> | <a name="a31"></a><a class="code" href="#!/url=./cpp_ref/namespace_m_h_w_render.html#ad970d5c990d4803d0e9d73c1ff4fda49aaebf48c70b63878eff38483392f19fb7">MHWRender::kOpenGLCoreProfile</a> | <a name="a32"></a><a class="code" href="#!/url=./cpp_ref/namespace_m_h_w_render.html#ad970d5c990d4803d0e9d73c1ff4fda49a90bc0a1678af7ac4d1e62e2e954be4e5">MHWRender::kDirectX11</a> );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> customTextureShaderOverride::isTransparent()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> customTextureShaderOverride::overridesDrawState()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> customTextureShaderOverride::supportsMultiDraw()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">return</span> m_multiDrawBeautyShaderInstance != NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> customTextureShaderOverride::updateShaderInstance()</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html">MHWRender::MRenderer</a> *renderer = <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html#a4678a72ac6959ed21d422d27928d0343">MHWRender::MRenderer::theRenderer</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (!renderer)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// this could be optimized by checking if parameters actually changed</span></div>
<div class="line">    <span class="comment">// see hwPhongShader for a more complete example in this regards</span></div>
<div class="line">    <span class="keywordflow">if</span> (m_beautyShaderInstance)</div>
<div class="line">    {</div>
<div class="line">        m_beautyShaderInstance-&gt;setParameter(<span class="stringliteral">&quot;colVal&quot;</span>, 1.0f);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (m_multiDrawBeautyShaderInstance)</div>
<div class="line">    {</div>
<div class="line">        m_multiDrawBeautyShaderInstance-&gt;setParameter(<span class="stringliteral">&quot;colVal&quot;</span>, 1.0f);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> customTextureShaderOverride::buildAndUpdateCustomDataTextureViaMaya()</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html">MHWRender::MRenderer</a> *renderer = <a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html#a4678a72ac6959ed21d422d27928d0343">MHWRender::MRenderer::theRenderer</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (!renderer)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <a name="_a33"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_texture_manager.html">MHWRender::MTextureManager</a>* mt = renderer-&gt;<a name="a34"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_renderer.html#aa3f2ec2984800e2cd8ea09b4ad9f072e">getTextureManager</a>();</div>
<div class="line"></div>
<div class="line">    generateCustomTexture();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a> newTextureName = <a class="code" href="#!/url=./cpp_ref/class_m_string.html">MString</a>(<span class="stringliteral">&quot;MyCustomTexture&quot;</span>);</div>
<div class="line">    <a name="_a35"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_texture.html">MHWRender::MTexture</a>* myTex = mt-&gt;<a name="a36"></a><a class="code" href="#!/url=./cpp_ref/class_m_h_w_render_1_1_m_texture_manager.html#a04aa3cfef217948abc8edd0f19565f95">acquireTexture</a>(newTextureName, m_desc, m_customTextureData, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (myTex)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a37"></a><a class="code" href="#!/url=./cpp_ref/struct_m_h_w_render_1_1_m_texture_assignment.html">MHWRender::MTextureAssignment</a> texResource;</div>
<div class="line">        texResource.<a name="a38"></a>texture = myTex;</div>
<div class="line">        <span class="keywordflow">if</span> (m_beautyShaderInstance)</div>
<div class="line">        {</div>
<div class="line">            m_beautyShaderInstance-&gt;setParameter(<span class="stringliteral">&quot;MyTexture&quot;</span>, texResource);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (m_multiDrawBeautyShaderInstance)</div>
<div class="line">        {</div>
<div class="line">            m_multiDrawBeautyShaderInstance-&gt;setParameter(<span class="stringliteral">&quot;MyTexture&quot;</span>, texResource);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> customTextureShaderOverride::generateCustomTexture()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> textureSize = 256;</div>
<div class="line">    <span class="keywordtype">int</span> numSlice = 1; <span class="comment">// Number of array slices. e.g. 6 would be required for a cube-map</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// First time, we create a contiguous block of data for the texture.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!m_customTextureData)</div>
<div class="line">    {</div>
<div class="line">        m_customTextureData = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[4*textureSize*textureSize*numSlice];</div>
<div class="line"></div>
<div class="line">        <span class="comment">// init values</span></div>
<div class="line">        <span class="comment">// do whatever you would do with your custom texture data. E.g. generate procedural texture.</span></div>
<div class="line">        <span class="keywordtype">int</span> index = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> face=0 ; face&lt;numSlice ; face++)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0 ; j&lt;textureSize ; j++)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0 ; i&lt;textureSize ; i++)</div>
<div class="line">                {</div>
<div class="line">                    m_customTextureData[index++] = (<span class="keywordtype">unsigned</span> char)(i);</div>
<div class="line">                    m_customTextureData[index++] = (<span class="keywordtype">unsigned</span> char)(j);</div>
<div class="line">                    m_customTextureData[index++] = (<span class="keywordtype">unsigned</span> char)(255*face/numSlice);</div>
<div class="line">                    m_customTextureData[index++] = 255;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// we still have to setup a texture description for Maya, even when using custom data:</span></div>
<div class="line">        m_desc.setToDefault2DTexture();</div>
<div class="line">        m_desc.fWidth = textureSize;</div>
<div class="line">        m_desc.fHeight = textureSize;</div>
<div class="line">        m_desc.fDepth = 1;</div>
<div class="line">        m_desc.fBytesPerRow = 4*textureSize;</div>
<div class="line">        m_desc.fBytesPerSlice = 4*textureSize*textureSize;</div>
<div class="line">        m_desc.fMipmaps = 1;</div>
<div class="line">        m_desc.fArraySlices = numSlice;</div>
<div class="line">        m_desc.fFormat = <a name="a39"></a><a class="code" href="#!/url=./cpp_ref/namespace_m_h_w_render.html#ab8dcc38685c6e5601a32fb70764742dca0e33962255b311165cb5d31c43ff576e">MHWRender::kR8G8B8A8_UNORM</a>;</div>
<div class="line">        m_desc.fTextureType = <a name="a40"></a><a class="code" href="#!/url=./cpp_ref/namespace_m_h_w_render.html#aaad5d927ce0bd1ecf45d5ddff4e3e030ab60d1f2093b30766f75777b2bfc47e87">MHWRender::kImage2D</a>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
          <div class="footer-block"><a href="../html/ac.cmtdialog.htm" class="comments-anchor" target="_blank"><span class="comments-link">Please send us your comment about this page</span></a></div></div>
   </div></body>
</html>
